<!doctype html>




<html class="theme-next pisces" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  
    
      
    

    
  

  

  
    
      
    

    
  

  
    
      
    

    
  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Monda:300,300italic,400,400italic,700,700italic|Roboto Slab:300,300italic,400,400italic,700,700italic|Lobster Two:300,300italic,400,400italic,700,700italic|PT Mono:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.0" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Hexo, NexT" />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.0" />






<meta name="description" content="Activity 的创建和加载1.我们通过调用 startActivity() 方法来启动一个 Activity，startActivity() 方法有几种重载的方式，但都会最终调用 startActivityForResult() 方法，代码如下： 12345678910@Override    public void startActivity(Intent intent, @Nullable">
<meta name="keywords">
<meta property="og:type" content="article">
<meta property="og:title" content="Activity 的创建和加载源码解析">
<meta property="og:url" content="http://yoursite.com/2017/04/29/Activity-的创建和加载源码解析/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="Activity 的创建和加载1.我们通过调用 startActivity() 方法来启动一个 Activity，startActivity() 方法有几种重载的方式，但都会最终调用 startActivityForResult() 方法，代码如下： 12345678910@Override    public void startActivity(Intent intent, @Nullable">
<meta property="og:updated_time" content="2017-04-29T06:57:25.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Activity 的创建和加载源码解析">
<meta name="twitter:description" content="Activity 的创建和加载1.我们通过调用 startActivity() 方法来启动一个 Activity，startActivity() 方法有几种重载的方式，但都会最终调用 startActivityForResult() 方法，代码如下： 12345678910@Override    public void startActivity(Intent intent, @Nullable">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    sidebar: {"position":"left","display":"post","offset":12,"offset_float":0,"b2t":false,"scrollpercent":false},
    fancybox: true,
    motion: false,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/2017/04/29/Activity-的创建和加载源码解析/"/>





  <title> Activity 的创建和加载源码解析 | Hexo </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  














  
  
    
  

  <div class="container sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Hexo</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/04/29/Activity-的创建和加载源码解析/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="zhangzaidong">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                Activity 的创建和加载源码解析
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-04-29T14:57:00+08:00">
                2017-04-29
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        <h4 id="Activity-的创建和加载"><a href="#Activity-的创建和加载" class="headerlink" title="Activity 的创建和加载"></a>Activity 的创建和加载</h4><p>1.我们通过调用 startActivity() 方法来启动一个 Activity，startActivity() 方法有几种重载的方式，但都会最终调用 startActivityForResult() 方法，代码如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">@Override</div><div class="line">    public void startActivity(Intent intent, @Nullable Bundle options) &#123;</div><div class="line">        if (options != null) &#123;</div><div class="line">            startActivityForResult(intent, -1, options);</div><div class="line">        &#125; else &#123;</div><div class="line">            // Note we want to go through this call for compatibility with</div><div class="line">            // applications that may have overridden the method.</div><div class="line">            startActivityForResult(intent, -1);</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>startActivityForResule() 方法，代码如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div></pre></td><td class="code"><pre><div class="line">/**</div><div class="line"> * Base class for implementing application instrumentation code.  When running</div><div class="line"> * with instrumentation turned on, this class will be instantiated for you</div><div class="line"> * before any of the application code, allowing you to monitor all of the</div><div class="line"> * interaction the system has with the application.  An Instrumentation</div><div class="line"> * implementation is described to the system through an AndroidManifest.xml&apos;s</div><div class="line"> * &amp;lt;instrumentation&amp;gt; tag.</div><div class="line"> */</div><div class="line">// set by the thread after the constructor and before onCreate(Bundle savedInstanceState) is called.</div><div class="line">    private Instrumentation mInstrumentation;</div><div class="line"></div><div class="line">public void startActivityForResult(@RequiresPermission Intent intent, int requestCode,</div><div class="line">            @Nullable Bundle options) &#123;</div><div class="line">        if (mParent == null) &#123;</div><div class="line">            options = transferSpringboardActivityOptions(options);</div><div class="line">            Instrumentation.ActivityResult ar =</div><div class="line">                mInstrumentation.execStartActivity(</div><div class="line">                    this, mMainThread.getApplicationThread(), mToken, this,</div><div class="line">                    intent, requestCode, options);</div><div class="line">            if (ar != null) &#123;</div><div class="line">                mMainThread.sendActivityResult(</div><div class="line">                    mToken, mEmbeddedID, requestCode, ar.getResultCode(),</div><div class="line">                    ar.getResultData());</div><div class="line">            &#125;</div><div class="line">            if (requestCode &gt;= 0) &#123;</div><div class="line">                // If this start is requesting a result, we can avoid making</div><div class="line">                // the activity visible until the result is received.  Setting</div><div class="line">                // this code during onCreate(Bundle savedInstanceState) or onResume() will keep the</div><div class="line">                // activity hidden during this time, to avoid flickering.</div><div class="line">                // This can only be done when a result is requested because</div><div class="line">                // that guarantees we will get information back when the</div><div class="line">                // activity is finished, no matter what happens to it.</div><div class="line">                mStartedActivity = true;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            cancelInputsAndStartExitTransition(options);</div><div class="line">            // TODO Consider clearing/flushing other event sources and events for child windows.</div><div class="line">        &#125; else &#123;</div><div class="line">            if (options != null) &#123;</div><div class="line">                mParent.startActivityFromChild(this, intent, requestCode, options);</div><div class="line">            &#125; else &#123;</div><div class="line">                // Note we want to go through this method for compatibility with</div><div class="line">                // existing applications that may have overridden it.</div><div class="line">                mParent.startActivityFromChild(this, intent, requestCode);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>在这个方法中，通过 execStartActivity () 方法的调用来开启一个 Activity,这个方法的第二个参数是 mMainThread.getApplicationThread() 方法返回的是一个 ApplicationThread 类型，ApplicationThread 是 ActivityThread 的内部类，ApplicationThread 和 ActivityThread 是 Activity 启动过程中很重要的两个元素， 下面我们接着看 execStartActivity() 方法，代码如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div></pre></td><td class="code"><pre><div class="line">/**</div><div class="line"> * Execute a startActivity call made by the application.  The default </div><div class="line"> * implementation takes care of updating any active &#123;@link ActivityMonitor&#125;</div><div class="line"> * objects and dispatches this call to the system activity manager; you can</div><div class="line"> * override this to watch for the application to start an activity, and </div><div class="line"> * modify what happens when it does. </div><div class="line"> *</div><div class="line"> * &lt;p&gt;This method returns an &#123;@link ActivityResult&#125; object, which you can </div><div class="line"> * use when intercepting application calls to avoid performing the start </div><div class="line"> * activity action but still return the result the application is </div><div class="line"> * expecting.  To do this, override this method to catch the call to start </div><div class="line"> * activity so that it returns a new ActivityResult containing the results </div><div class="line"> * you would like the application to see, and don&apos;t call up to the super </div><div class="line"> * class.  Note that an application is only expecting a result if </div><div class="line"> * &lt;var&gt;requestCode&lt;/var&gt; is &amp;gt;= 0.</div><div class="line"> *</div><div class="line"> * &lt;p&gt;This method throws &#123;@link android.content.ActivityNotFoundException&#125;</div><div class="line"> * if there was no Activity found to run the given Intent.</div><div class="line"> *</div><div class="line"> * @param who The Context from which the activity is being started.</div><div class="line"> * @param contextThread The main thread of the Context from which the activity</div><div class="line"> *                      is being started.</div><div class="line"> * @param token Internal token identifying to the system who is starting </div><div class="line"> *              the activity; may be null.</div><div class="line"> * @param target Which activity is performing the start (and thus receiving </div><div class="line"> *               any result); may be null if this call is not being made</div><div class="line"> *               from an activity.</div><div class="line"> * @param intent The actual Intent to start.</div><div class="line"> * @param requestCode Identifier for this request&apos;s result; less than zero </div><div class="line"> *                    if the caller is not expecting a result.</div><div class="line"> * @param options Addition options.</div><div class="line"> *</div><div class="line"> * @return To force the return of a particular result, return an </div><div class="line"> *         ActivityResult object containing the desired data; otherwise</div><div class="line"> *         return null.  The default implementation always returns null.</div><div class="line"> *</div><div class="line"> * @throws android.content.ActivityNotFoundException</div><div class="line"> *</div><div class="line"> * @see Activity#startActivity(Intent)</div><div class="line"> * @see Activity#startActivityForResult(Intent, int)</div><div class="line"> * @see Activity#startActivityFromChild</div><div class="line"> *</div><div class="line"> * &#123;@hide&#125;</div><div class="line"> */</div><div class="line">public ActivityResult execStartActivity(</div><div class="line">        Context who, IBinder contextThread, IBinder token, Activity target,</div><div class="line">        Intent intent, int requestCode, Bundle options) &#123;</div><div class="line">    IApplicationThread whoThread = (IApplicationThread) contextThread;</div><div class="line">    Uri referrer = target != null ? target.onProvideReferrer() : null;</div><div class="line">    if (referrer != null) &#123;</div><div class="line">        intent.putExtra(Intent.EXTRA_REFERRER, referrer);</div><div class="line">    &#125;</div><div class="line">    if (mActivityMonitors != null) &#123;</div><div class="line">        synchronized (mSync) &#123;</div><div class="line">            final int N = mActivityMonitors.size();</div><div class="line">            for (int i=0; i&lt;N; i++) &#123;</div><div class="line">                final ActivityMonitor am = mActivityMonitors.get(i);</div><div class="line">                if (am.match(who, null, intent)) &#123;</div><div class="line">                    am.mHits++;</div><div class="line">                    if (am.isBlocking()) &#123;</div><div class="line">                        return requestCode &gt;= 0 ? am.getResult() : null;</div><div class="line">                    &#125;</div><div class="line">                    break;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    try &#123;</div><div class="line">        intent.migrateExtraStreamToClipData();</div><div class="line">        intent.prepareToLeaveProcess(who);</div><div class="line">        // 开始启动 Activity</div><div class="line">        int result = ActivityManagerNative.getDefault()</div><div class="line">            .startActivity(whoThread, who.getBasePackageName(), intent,</div><div class="line">                    intent.resolveTypeIfNeeded(who.getContentResolver()),</div><div class="line">                    token, target != null ? target.mEmbeddedID : null,</div><div class="line">                    requestCode, 0, null, options);</div><div class="line">        // 检查 Activity 启动的结果，不正常就抛出异常</div><div class="line">        checkStartActivityResult(result, intent);</div><div class="line">    &#125; catch (RemoteException e) &#123;</div><div class="line">        throw new RuntimeException(&quot;Failure from system&quot;, e);</div><div class="line">    &#125;</div><div class="line">    return null;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>启动 Activity 的实现由 ActivityManagerNative.getDefault().startActivity() 实现。ActivityManagerNative 是一个抽象类，继承自 Binder 并实现了 IActivityManager 接口，ActivityManagerService (AMS) 继承自 ActivityManagerNative，因此 AMS 也是一个 Binder 接口，是 IActivityManager 的具体实现，</p>
<p>在 ActivityManagerNative 中，getDefault() 方法得代码如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div></pre></td><td class="code"><pre><div class="line">/**</div><div class="line"> * Retrieve the system&apos;s default/global activity manager.</div><div class="line"> */</div><div class="line">static public IActivityManager getDefault() &#123;</div><div class="line">	return gDefault.get();</div><div class="line">&#125;</div><div class="line"></div><div class="line">private static final Singleton&lt;IActivityManager&gt; gDefault = new Singleton&lt;IActivityManager&gt;() &#123;</div><div class="line">        protected IActivityManager create() &#123;</div><div class="line">            IBinder b = ServiceManager.getService(&quot;activity&quot;);</div><div class="line">            if (false) &#123;</div><div class="line">                Log.v(&quot;ActivityManager&quot;, &quot;default service binder = &quot; + b);</div><div class="line">            &#125;</div><div class="line">            IActivityManager am = asInterface(b);</div><div class="line">            if (false) &#123;</div><div class="line">                Log.v(&quot;ActivityManager&quot;, &quot;default service = &quot; + am);</div><div class="line">            &#125;</div><div class="line">            return am;</div><div class="line">        &#125;</div><div class="line">    &#125;;</div><div class="line">    </div><div class="line">/**</div><div class="line"> * Singleton helper class for lazily initialization.</div><div class="line"> *</div><div class="line"> * Modeled after frameworks/base/include/utils/Singleton.h</div><div class="line"> *</div><div class="line"> * @hide</div><div class="line"> */</div><div class="line">public abstract class Singleton&lt;T&gt; &#123;</div><div class="line">    private T mInstance;</div><div class="line"></div><div class="line">    protected abstract T create();</div><div class="line"></div><div class="line">    public final T get() &#123;</div><div class="line">        synchronized (this) &#123;</div><div class="line">            if (mInstance == null) &#123;</div><div class="line">                mInstance = create();</div><div class="line">            &#125;</div><div class="line">            return mInstance;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>AMS 这个Binder 接口 采用单例模式对外提供，由此可以 Activity 的启动是 AMS 调用 startActivity() 方法来启动的，代码如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">    @Override</div><div class="line">    public final int startActivity(IApplicationThread caller, String callingPackage,</div><div class="line">            Intent intent, String resolvedType, IBinder resultTo, String resultWho, int requestCode,</div><div class="line">            int startFlags, ProfilerInfo profilerInfo, Bundle bOptions) &#123;</div><div class="line">        return startActivityAsUser(caller, callingPackage, intent, resolvedType, resultTo,</div><div class="line">                resultWho, requestCode, startFlags, profilerInfo, bOptions,</div><div class="line">                UserHandle.getCallingUserId());</div><div class="line">    &#125;</div><div class="line"></div><div class="line">@Override</div><div class="line">    public final int startActivityAsUser(IApplicationThread caller, String callingPackage,</div><div class="line">            Intent intent, String resolvedType, IBinder resultTo, String resultWho, int requestCode,</div><div class="line">            int startFlags, ProfilerInfo profilerInfo, Bundle bOptions, int userId) &#123;</div><div class="line">        enforceNotIsolatedCaller(&quot;startActivity&quot;);</div><div class="line">        userId = mUserController.handleIncomingUser(Binder.getCallingPid(), Binder.getCallingUid(),</div><div class="line">                userId, false, ALLOW_FULL_ONLY, &quot;startActivity&quot;, null);</div><div class="line">        // TODO: Switch to user app stacks here.</div><div class="line">        //</div><div class="line">        return mActivityStarter.startActivityMayWait(caller, -1, callingPackage, intent,</div><div class="line">                resolvedType, null, null, resultTo, resultWho, requestCode, startFlags,</div><div class="line">                profilerInfo, null, null, bOptions, false, userId, null, null);</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>从这个函数开始由一串很长的方法调用，我们一个一个分析，首先，调用 mActivityStarter.startActivityMayWait() 方法，这个 mActivityStarter 的作用是控制 Activity 的中断和启动，搜集 Activity 启动的相关逻辑；在 ActivityStarter 中有一个 ActivityStackSupervisor 类，这个类的作用是负责管理 ActivityStack; 在 startActivityMayWait() 方法中由调用了 startActivityLocked() 方法，在其中调用 startActivityUnchecked() 方法，接着调用了 resumeFocusedStackTopActivityLocked() 方法，接着调用了 ActivityStack 的 resumeTopActivityUncheckedLocked() 方法，这个启动过程从 ActivityStackSupervisor 转移到 ActivityStack。</p>
<p>分析一下 resumeTopActivityUncheckedLocked() 方法，代码如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line">/**</div><div class="line">    * Ensure that the top activity in the stack is resumed.</div><div class="line">    *</div><div class="line">    * @param prev The previously resumed activity, for when in the process</div><div class="line">    * of pausing; can be null to call from elsewhere.</div><div class="line">    * @param options Activity options.</div><div class="line">    *</div><div class="line">    * @return Returns true if something is being resumed, or false if</div><div class="line">    * nothing happened.</div><div class="line">    *</div><div class="line">    * NOTE: It is not safe to call this method directly as it can cause an activity in a</div><div class="line">    *       non-focused stack to be resumed.</div><div class="line">    *       Use &#123;@link ActivityStackSupervisor#resumeFocusedStackTopActivityLocked&#125; to resume the</div><div class="line">    *       right activity for the current system state.</div><div class="line">    */</div><div class="line">   boolean resumeTopActivityUncheckedLocked(ActivityRecord prev, ActivityOptions options) &#123;</div><div class="line">       if (mStackSupervisor.inResumeTopActivity) &#123;</div><div class="line">           // Don&apos;t even start recursing.</div><div class="line">           return false;</div><div class="line">       &#125;</div><div class="line"></div><div class="line">       boolean result = false;</div><div class="line">       try &#123;</div><div class="line">           // Protect against recursion.</div><div class="line">           mStackSupervisor.inResumeTopActivity = true;</div><div class="line">           if (mService.mLockScreenShown == ActivityManagerService.LOCK_SCREEN_LEAVING) &#123;</div><div class="line">               mService.mLockScreenShown = ActivityManagerService.LOCK_SCREEN_HIDDEN;</div><div class="line">               mService.updateSleepIfNeededLocked();</div><div class="line">           &#125;</div><div class="line">           result = resumeTopActivityInnerLocked(prev, options);</div><div class="line">       &#125; finally &#123;</div><div class="line">           mStackSupervisor.inResumeTopActivity = false;</div><div class="line">       &#125;</div><div class="line">       return result;</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<p>在这个方法调用了resumeTopActivityInnerLocked() 方法,接着在其中调用了 ActivityStackSupervisor 的 startSpecificActivityLocked() 方法，代码如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line">void startSpecificActivityLocked(ActivityRecord r,</div><div class="line">        boolean andResume, boolean checkConfig) &#123;</div><div class="line">    // Is this activity&apos;s application already running?</div><div class="line">    ProcessRecord app = mService.getProcessRecordLocked(r.processName,</div><div class="line">            r.info.applicationInfo.uid, true);</div><div class="line"></div><div class="line">    r.task.stack.setLaunchTime(r);</div><div class="line"></div><div class="line">    if (app != null &amp;&amp; app.thread != null) &#123;</div><div class="line">        try &#123;</div><div class="line">            if ((r.info.flags&amp;ActivityInfo.FLAG_MULTIPROCESS) == 0</div><div class="line">                    || !&quot;android&quot;.equals(r.info.packageName)) &#123;</div><div class="line">                // Don&apos;t add this if it is a platform component that is marked</div><div class="line">                // to run in multiple processes, because this is actually</div><div class="line">                // part of the framework so doesn&apos;t make sense to track as a</div><div class="line">                // separate apk in the process.</div><div class="line">                app.addPackage(r.info.packageName, r.info.applicationInfo.versionCode,</div><div class="line">                        mService.mProcessStats);</div><div class="line">            &#125;</div><div class="line">            realStartActivityLocked(r, app, andResume, checkConfig);</div><div class="line">            return;</div><div class="line">        &#125; catch (RemoteException e) &#123;</div><div class="line">            Slog.w(TAG, &quot;Exception when starting activity &quot;</div><div class="line">                    + r.intent.getComponent().flattenToShortString(), e);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        // If a dead object exception was thrown -- fall through to</div><div class="line">        // restart the application.</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    mService.startProcessLocked(r.processName, r.info.applicationInfo, true, 0,</div><div class="line">            &quot;activity&quot;, r.intent.getComponent(), false, false, true);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>上述代码中，调用了 realStartActivityLocked() 方法；说明 Activity 的启动过程是在 ActivityStackSupervisor 和 ActivityStack 之间传递顺序的。</p>
<p>在 realStartActivityLocked() 方法中，又如下代码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">app.thread.scheduleLaunchActivity(new Intent(r.intent), r.appToken,</div><div class="line">                    System.identityHashCode(r), r.info, new Configuration(mService.mConfiguration),</div><div class="line">                    new Configuration(task.mOverrideConfig), r.compat, r.launchedFromPackage,</div><div class="line">                    task.voiceInteractor, app.repProcState, r.icicle, r.persistentState, results,</div><div class="line">                    newIntents, !andResume, mService.isNextTransitionForward(), profilerInfo);</div></pre></td></tr></table></figure>
<p>在上述代码中，app.thread 的类型为 IApplicationThread，它的作用是负责 activityManager 和 Application 之间的通信，它里面完成了大量的和 activity 以及 service 启动和停止相关的功能,代码如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div></pre></td><td class="code"><pre><div class="line">/**</div><div class="line"> * System private API for communicating with the application.  This is given to</div><div class="line"> * the activity manager by an application  when it starts up, for the activity</div><div class="line"> * manager to tell the application about things it needs to do.</div><div class="line"> *</div><div class="line"> * &#123;@hide&#125;</div><div class="line"> */</div><div class="line">public interface IApplicationThread extends IInterface &#123;</div><div class="line">    void schedulePauseActivity(IBinder token, boolean finished, boolean userLeaving,</div><div class="line">            int configChanges, boolean dontReport) throws RemoteException;</div><div class="line">    void scheduleStopActivity(IBinder token, boolean showWindow,</div><div class="line">            int configChanges) throws RemoteException;</div><div class="line">    void scheduleWindowVisibility(IBinder token, boolean showWindow) throws RemoteException;</div><div class="line">    void scheduleSleeping(IBinder token, boolean sleeping) throws RemoteException;</div><div class="line">    void scheduleResumeActivity(IBinder token, int procState, boolean isForward, Bundle resumeArgs)</div><div class="line">            throws RemoteException;</div><div class="line">    void scheduleSendResult(IBinder token, List&lt;ResultInfo&gt; results) throws RemoteException;</div><div class="line">    void scheduleLaunchActivity(Intent intent, IBinder token, int ident,</div><div class="line">            ActivityInfo info, Configuration curConfig, Configuration overrideConfig,</div><div class="line">            CompatibilityInfo compatInfo, String referrer, IVoiceInteractor voiceInteractor,</div><div class="line">            int procState, Bundle state, PersistableBundle persistentState,</div><div class="line">            List&lt;ResultInfo&gt; pendingResults, List&lt;ReferrerIntent&gt; pendingNewIntents,</div><div class="line">            boolean notResumed, boolean isForward, ProfilerInfo profilerInfo) throws RemoteException;</div><div class="line">    void scheduleRelaunchActivity(IBinder token, List&lt;ResultInfo&gt; pendingResults,</div><div class="line">            List&lt;ReferrerIntent&gt; pendingNewIntents, int configChanges, boolean notResumed,</div><div class="line">            Configuration config, Configuration overrideConfig, boolean preserveWindow)</div><div class="line">            throws RemoteException;</div><div class="line">    void scheduleNewIntent(</div><div class="line">            List&lt;ReferrerIntent&gt; intent, IBinder token, boolean andPause) throws RemoteException;</div><div class="line">    void scheduleDestroyActivity(IBinder token, boolean finished,</div><div class="line">            int configChanges) throws RemoteException;</div><div class="line">    void scheduleReceiver(Intent intent, ActivityInfo info, CompatibilityInfo compatInfo,</div><div class="line">            int resultCode, String data, Bundle extras, boolean sync,</div><div class="line">            int sendingUser, int processState) throws RemoteException;</div><div class="line">    static final int BACKUP_MODE_INCREMENTAL = 0;</div><div class="line">    static final int BACKUP_MODE_FULL = 1;</div><div class="line">    static final int BACKUP_MODE_RESTORE = 2;</div><div class="line">    static final int BACKUP_MODE_RESTORE_FULL = 3;</div><div class="line">    void scheduleCreateBackupAgent(ApplicationInfo app, CompatibilityInfo compatInfo,</div><div class="line">            int backupMode) throws RemoteException;</div><div class="line">    void scheduleDestroyBackupAgent(ApplicationInfo app, CompatibilityInfo compatInfo)</div><div class="line">            throws RemoteException;</div><div class="line">    void scheduleCreateService(IBinder token, ServiceInfo info,</div><div class="line">            CompatibilityInfo compatInfo, int processState) throws RemoteException;</div><div class="line">    void scheduleBindService(IBinder token,</div><div class="line">            Intent intent, boolean rebind, int processState) throws RemoteException;</div><div class="line">    void scheduleUnbindService(IBinder token,</div><div class="line">            Intent intent) throws RemoteException;</div><div class="line">    void scheduleServiceArgs(IBinder token, boolean taskRemoved, int startId,</div><div class="line">            int flags, Intent args) throws RemoteException;</div><div class="line">    void scheduleStopService(IBinder token) throws RemoteException;</div><div class="line">    static final int DEBUG_OFF = 0;</div><div class="line">    static final int DEBUG_ON = 1;</div><div class="line">    static final int DEBUG_WAIT = 2;</div><div class="line">    void bindApplication(String packageName, ApplicationInfo info, List&lt;ProviderInfo&gt; providers,</div><div class="line">            ComponentName testName, ProfilerInfo profilerInfo, Bundle testArguments,</div><div class="line">            IInstrumentationWatcher testWatcher, IUiAutomationConnection uiAutomationConnection,</div><div class="line">            int debugMode, boolean enableBinderTracking, boolean trackAllocation,</div><div class="line">            boolean restrictedBackupMode, boolean persistent, Configuration config,</div><div class="line">            CompatibilityInfo compatInfo, Map&lt;String, IBinder&gt; services, Bundle coreSettings)</div><div class="line">            throws RemoteException;</div><div class="line">    void scheduleExit() throws RemoteException;</div><div class="line">    void scheduleSuicide() throws RemoteException;</div><div class="line">    void scheduleConfigurationChanged(Configuration config) throws RemoteException;</div><div class="line">    void updateTimeZone() throws RemoteException;</div><div class="line">    void clearDnsCache() throws RemoteException;</div><div class="line">    void setHttpProxy(String proxy, String port, String exclList,</div><div class="line">            Uri pacFileUrl) throws RemoteException;</div><div class="line">    void processInBackground() throws RemoteException;</div><div class="line">    void dumpService(FileDescriptor fd, IBinder servicetoken, String[] args)</div><div class="line">            throws RemoteException;</div><div class="line">    void dumpProvider(FileDescriptor fd, IBinder servicetoken, String[] args)</div><div class="line">            throws RemoteException;</div><div class="line">    void scheduleRegisteredReceiver(IIntentReceiver receiver, Intent intent,</div><div class="line">            int resultCode, String data, Bundle extras, boolean ordered,</div><div class="line">            boolean sticky, int sendingUser, int processState) throws RemoteException;</div><div class="line">    void scheduleLowMemory() throws RemoteException;</div><div class="line">    void scheduleActivityConfigurationChanged(IBinder token, Configuration overrideConfig,</div><div class="line">            boolean reportToActivity) throws RemoteException;</div><div class="line">    void profilerControl(boolean start, ProfilerInfo profilerInfo, int profileType)</div><div class="line">            throws RemoteException;</div><div class="line">    void dumpHeap(boolean managed, String path, ParcelFileDescriptor fd)</div><div class="line">            throws RemoteException;</div><div class="line">    void attachAgent(String path) throws RemoteException;</div><div class="line">    void setSchedulingGroup(int group) throws RemoteException;</div><div class="line">    // the package has been removed, clean up internal references</div><div class="line">    static final int PACKAGE_REMOVED = 0;</div><div class="line">    static final int EXTERNAL_STORAGE_UNAVAILABLE = 1;</div><div class="line">    // the package is being modified in-place, don&apos;t kill it and retain references to it</div><div class="line">    static final int PACKAGE_REMOVED_DONT_KILL = 2;</div><div class="line">    // a previously removed package was replaced with a new version [eg. upgrade, split added, ...]</div><div class="line">    static final int PACKAGE_REPLACED = 3;</div><div class="line">    void dispatchPackageBroadcast(int cmd, String[] packages) throws RemoteException;</div><div class="line">    void scheduleCrash(String msg) throws RemoteException;</div><div class="line">    void dumpActivity(FileDescriptor fd, IBinder servicetoken, String prefix, String[] args)</div><div class="line">            throws RemoteException;</div><div class="line">    void setCoreSettings(Bundle coreSettings) throws RemoteException;</div><div class="line">    void updatePackageCompatibilityInfo(String pkg, CompatibilityInfo info) throws RemoteException;</div><div class="line">    void scheduleTrimMemory(int level) throws RemoteException;</div><div class="line">    void dumpMemInfo(FileDescriptor fd, Debug.MemoryInfo mem, boolean checkin, boolean dumpInfo,</div><div class="line">            boolean dumpDalvik, boolean dumpSummaryOnly, boolean dumpUnreachable,</div><div class="line">            String[] args) throws RemoteException;</div><div class="line">    void dumpGfxInfo(FileDescriptor fd, String[] args) throws RemoteException;</div><div class="line">    void dumpDbInfo(FileDescriptor fd, String[] args) throws RemoteException;</div><div class="line">    void unstableProviderDied(IBinder provider) throws RemoteException;</div><div class="line">    void requestAssistContextExtras(IBinder activityToken, IBinder requestToken, int requestType,</div><div class="line">            int sessionId) throws RemoteException;</div><div class="line">    void scheduleTranslucentConversionComplete(IBinder token, boolean timeout)</div><div class="line">            throws RemoteException;</div><div class="line">    void scheduleOnNewActivityOptions(IBinder token, ActivityOptions options)</div><div class="line">            throws RemoteException;</div><div class="line">    void setProcessState(int state) throws RemoteException;</div><div class="line">    void scheduleInstallProvider(ProviderInfo provider) throws RemoteException;</div><div class="line">    void updateTimePrefs(boolean is24Hour) throws RemoteException;</div><div class="line">    void scheduleCancelVisibleBehind(IBinder token) throws RemoteException;</div><div class="line">    void scheduleBackgroundVisibleBehindChanged(IBinder token, boolean enabled) throws RemoteException;</div><div class="line">    void scheduleEnterAnimationComplete(IBinder token) throws RemoteException;</div><div class="line">    void notifyCleartextNetwork(byte[] firstPacket) throws RemoteException;</div><div class="line">    void startBinderTracking() throws RemoteException;</div><div class="line">    void stopBinderTrackingAndDump(FileDescriptor fd) throws RemoteException;</div><div class="line">    void scheduleMultiWindowModeChanged(IBinder token, boolean isInMultiWindowMode) throws RemoteException;</div><div class="line">    void schedulePictureInPictureModeChanged(IBinder token, boolean isInPictureInPictureMode) throws RemoteException;</div><div class="line">    void scheduleLocalVoiceInteractionStarted(IBinder token, IVoiceInteractor voiceInteractor) throws RemoteException;</div><div class="line">......</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ApplicationThread 是 IApplicationThread 的实现类，其中 scheduleLaunchActivity() 方法如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line">// we use token to identify this activity without having to send the</div><div class="line">// activity itself back to the activity manager. (matters more with ipc)</div><div class="line">@Override</div><div class="line">public final void scheduleLaunchActivity(Intent intent, IBinder token, int ident,</div><div class="line">        ActivityInfo info, Configuration curConfig, Configuration overrideConfig,</div><div class="line">        CompatibilityInfo compatInfo, String referrer, IVoiceInteractor voiceInteractor,</div><div class="line">        int procState, Bundle state, PersistableBundle persistentState,</div><div class="line">        List&lt;ResultInfo&gt; pendingResults, List&lt;ReferrerIntent&gt; pendingNewIntents,</div><div class="line">        boolean notResumed, boolean isForward, ProfilerInfo profilerInfo) &#123;</div><div class="line"></div><div class="line">    updateProcessState(procState, false);</div><div class="line"></div><div class="line">    ActivityClientRecord r = new ActivityClientRecord();</div><div class="line"></div><div class="line">    r.token = token;</div><div class="line">    r.ident = ident;</div><div class="line">    r.intent = intent;</div><div class="line">    r.referrer = referrer;</div><div class="line">    r.voiceInteractor = voiceInteractor;</div><div class="line">    r.activityInfo = info;</div><div class="line">    r.compatInfo = compatInfo;</div><div class="line">    r.state = state;</div><div class="line">    r.persistentState = persistentState;</div><div class="line"></div><div class="line">    r.pendingResults = pendingResults;</div><div class="line">    r.pendingIntents = pendingNewIntents;</div><div class="line"></div><div class="line">    r.startsNotResumed = notResumed;</div><div class="line">    r.isForward = isForward;</div><div class="line"></div><div class="line">    r.profilerInfo = profilerInfo;</div><div class="line"></div><div class="line">    r.overrideConfig = overrideConfig;</div><div class="line">    updatePendingConfiguration(curConfig);</div><div class="line"></div><div class="line">    sendMessage(H.LAUNCH_ACTIVITY, r);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>它的原理就是发送一个启动 Activity 的消息交由 H(Handler) 处理，实现如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">final H mH = new H();</div><div class="line"></div><div class="line">private void sendMessage(int what, Object obj, int arg1, int arg2, boolean async) &#123;</div><div class="line">        if (DEBUG_MESSAGES) Slog.v(</div><div class="line">            TAG, &quot;SCHEDULE &quot; + what + &quot; &quot; + mH.codeToString(what)</div><div class="line">            + &quot;: &quot; + arg1 + &quot; / &quot; + obj);</div><div class="line">        Message msg = Message.obtain();</div><div class="line">        msg.what = what;</div><div class="line">        msg.obj = obj;</div><div class="line">        msg.arg1 = arg1;</div><div class="line">        msg.arg2 = arg2;</div><div class="line">        if (async) &#123;</div><div class="line">            msg.setAsynchronous(true);</div><div class="line">        &#125;</div><div class="line">        mH.sendMessage(msg);</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>H 的代码如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div></pre></td><td class="code"><pre><div class="line">private class H extends Handler &#123;</div><div class="line">        public static final int LAUNCH_ACTIVITY         = 100;</div><div class="line">        public static final int PAUSE_ACTIVITY          = 101;</div><div class="line">        public static final int PAUSE_ACTIVITY_FINISHING= 102;</div><div class="line">        public static final int STOP_ACTIVITY_SHOW      = 103;</div><div class="line">        public static final int STOP_ACTIVITY_HIDE      = 104;</div><div class="line">        public static final int SHOW_WINDOW             = 105;</div><div class="line">        public static final int HIDE_WINDOW             = 106;</div><div class="line">        public static final int RESUME_ACTIVITY         = 107;</div><div class="line">        public static final int SEND_RESULT             = 108;</div><div class="line">        public static final int DESTROY_ACTIVITY        = 109;</div><div class="line">        public static final int BIND_APPLICATION        = 110;</div><div class="line">        public static final int EXIT_APPLICATION        = 111;</div><div class="line">        public static final int NEW_INTENT              = 112;</div><div class="line">        public static final int RECEIVER                = 113;</div><div class="line">        public static final int CREATE_SERVICE          = 114;</div><div class="line">        public static final int SERVICE_ARGS            = 115;</div><div class="line">        public static final int STOP_SERVICE            = 116;</div><div class="line">        .....</div><div class="line">                public void handleMessage(Message msg) &#123;</div><div class="line">            if (DEBUG_MESSAGES) Slog.v(TAG, &quot;&gt;&gt;&gt; handling: &quot; + codeToString(msg.what));</div><div class="line">            switch (msg.what) &#123;</div><div class="line">                case LAUNCH_ACTIVITY: &#123;</div><div class="line">                    Trace.traceBegin(Trace.TRACE_TAG_ACTIVITY_MANAGER, &quot;activityStart&quot;);</div><div class="line">                    final ActivityClientRecord r = (ActivityClientRecord) msg.obj;</div><div class="line"></div><div class="line">                    r.packageInfo = getPackageInfoNoCheck(</div><div class="line">                            r.activityInfo.applicationInfo, r.compatInfo);</div><div class="line">                    handleLaunchActivity(r, null, &quot;LAUNCH_ACTIVITY&quot;);</div><div class="line">                    Trace.traceEnd(Trace.TRACE_TAG_ACTIVITY_MANAGER);</div><div class="line">                &#125; break;</div><div class="line">                case RELAUNCH_ACTIVITY: &#123;</div><div class="line">                    Trace.traceBegin(Trace.TRACE_TAG_ACTIVITY_MANAGER, &quot;activityRestart&quot;);</div><div class="line">                    ActivityClientRecord r = (ActivityClientRecord)msg.obj;</div><div class="line">                    handleRelaunchActivity(r);</div><div class="line">                    Trace.traceEnd(Trace.TRACE_TAG_ACTIVITY_MANAGER);</div><div class="line">                &#125; break;</div><div class="line">                case PAUSE_ACTIVITY: &#123;</div><div class="line">                    Trace.traceBegin(Trace.TRACE_TAG_ACTIVITY_MANAGER, &quot;activityPause&quot;);</div><div class="line">                    SomeArgs args = (SomeArgs) msg.obj;</div><div class="line">                    handlePauseActivity((IBinder) args.arg1, false,</div><div class="line">                            (args.argi1 &amp; USER_LEAVING) != 0, args.argi2,</div><div class="line">                            (args.argi1 &amp; DONT_REPORT) != 0, args.argi3);</div><div class="line">                    maybeSnapshot();</div><div class="line">                    Trace.traceEnd(Trace.TRACE_TAG_ACTIVITY_MANAGER);</div><div class="line">                &#125; break;</div><div class="line">                ......</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>从上述代码中可以看出， <strong>Activity 的启动是由 ActivityThread 的 handleLaunchActivity() 方法实现的</strong>，代码如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div></pre></td><td class="code"><pre><div class="line">private void handleLaunchActivity(ActivityClientRecord r, Intent customIntent, String reason) &#123;</div><div class="line">        // If we are getting ready to gc after going to the background, well</div><div class="line">        // we are back active so skip it.</div><div class="line">        unscheduleGcIdler();</div><div class="line">        mSomeActivitiesChanged = true;</div><div class="line"></div><div class="line">        if (r.profilerInfo != null) &#123;</div><div class="line">            mProfiler.setProfiler(r.profilerInfo);</div><div class="line">            mProfiler.startProfiling();</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        // Make sure we are running with the most recent config.</div><div class="line">        handleConfigurationChanged(null, null);</div><div class="line"></div><div class="line">        if (localLOGV) Slog.v(</div><div class="line">            TAG, &quot;Handling launch of &quot; + r);</div><div class="line"></div><div class="line">        // Initialize before creating the activity</div><div class="line">        WindowManagerGlobal.initialize();</div><div class="line">		//完成的 Activity 的创建和启动</div><div class="line">        Activity a = performLaunchActivity(r, customIntent);</div><div class="line"></div><div class="line">        if (a != null) &#123;</div><div class="line">            r.createdConfig = new Configuration(mConfiguration);</div><div class="line">            reportSizeConfigurations(r);</div><div class="line">            Bundle oldState = r.state;</div><div class="line">            handleResumeActivity(r.token, false, r.isForward,</div><div class="line">                    !r.activity.mFinished &amp;&amp; !r.startsNotResumed, r.lastProcessedSeq, reason);</div><div class="line"></div><div class="line">            if (!r.activity.mFinished &amp;&amp; r.startsNotResumed) &#123;</div><div class="line">                // The activity manager actually wants this one to start out paused, because it</div><div class="line">                // needs to be visible but isn&apos;t in the foreground. We accomplish this by going</div><div class="line">                // through the normal startup (because activities expect to go through onResume()</div><div class="line">                // the first time they run, before their window is displayed), and then pausing it.</div><div class="line">                // However, in this case we do -not- need to do the full pause cycle (of freezing</div><div class="line">                // and such) because the activity manager assumes it can just retain the current</div><div class="line">                // state it has.</div><div class="line">                performPauseActivityIfNeeded(r, reason);</div><div class="line"></div><div class="line">                // We need to keep around the original state, in case we need to be created again.</div><div class="line">                // But we only do this for pre-Honeycomb apps, which always save their state when</div><div class="line">                // pausing, so we can not have them save their state when restarting from a paused</div><div class="line">                // state. For HC and later, we want to (and can) let the state be saved as the</div><div class="line">                // normal part of stopping the activity.</div><div class="line">                if (r.isPreHoneycomb()) &#123;</div><div class="line">                    r.state = oldState;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125; else &#123;</div><div class="line">            // If there was an error, for any reason, tell the activity manager to stop us.</div><div class="line">            try &#123;</div><div class="line">                ActivityManagerNative.getDefault()</div><div class="line">                    .finishActivity(r.token, Activity.RESULT_CANCELED, null,</div><div class="line">                            Activity.DONT_FINISH_TASK_WITH_ACTIVITY);</div><div class="line">            &#125; catch (RemoteException ex) &#123;</div><div class="line">                throw ex.rethrowFromSystemServer();</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>从上述代码中，performLaunchActivity() 最终完成了 Activity 对象的创建和启动过程，并且 ActivityThread 通过 handleResumeActivity() 方法来调用被启动的 Activity 的 onResume() 方法。</p>
<p>performLaunchActivity() 方法，代码如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div></pre></td><td class="code"><pre><div class="line">  private Activity performLaunchActivity(ActivityClientRecord r, Intent customIntent) &#123;</div><div class="line">      // System.out.println(&quot;##### [&quot; + System.currentTimeMillis() + &quot;] ActivityThread.performLaunchActivity(&quot; + r + &quot;)&quot;);</div><div class="line">//1.从 ActivityClientRecord 中获取待启动的 Activity 的组件信息</div><div class="line">      ActivityInfo aInfo = r.activityInfo;</div><div class="line">      if (r.packageInfo == null) &#123;</div><div class="line">          r.packageInfo = getPackageInfo(aInfo.applicationInfo, r.compatInfo,</div><div class="line">                  Context.CONTEXT_INCLUDE_CODE);</div><div class="line">      &#125;</div><div class="line"></div><div class="line">      ComponentName component = r.intent.getComponent();</div><div class="line">      if (component == null) &#123;</div><div class="line">          component = r.intent.resolveActivity(</div><div class="line">              mInitialApplication.getPackageManager());</div><div class="line">          r.intent.setComponent(component);</div><div class="line">      &#125;</div><div class="line"></div><div class="line">      if (r.activityInfo.targetActivity != null) &#123;</div><div class="line">          component = new ComponentName(r.activityInfo.packageName,</div><div class="line">                  r.activityInfo.targetActivity);</div><div class="line">      &#125;</div><div class="line">//2.通过 Instrumentation 的 newActivity() 方法实用类加载器穿件 Activity 对象</div><div class="line">      Activity activity = null;</div><div class="line">      try &#123;</div><div class="line">          java.lang.ClassLoader cl = r.packageInfo.getClassLoader();</div><div class="line">          activity = mInstrumentation.newActivity(</div><div class="line">                  cl, component.getClassName(), r.intent);</div><div class="line">          StrictMode.incrementExpectedActivityCount(activity.getClass());</div><div class="line">          r.intent.setExtrasClassLoader(cl);</div><div class="line">          r.intent.prepareToEnterProcess();</div><div class="line">          if (r.state != null) &#123;</div><div class="line">              r.state.setClassLoader(cl);</div><div class="line">          &#125;</div><div class="line">      &#125; catch (Exception e) &#123;</div><div class="line">          if (!mInstrumentation.onException(activity, e)) &#123;</div><div class="line">              throw new RuntimeException(</div><div class="line">                  &quot;Unable to instantiate activity &quot; + component</div><div class="line">                  + &quot;: &quot; + e.toString(), e);</div><div class="line">          &#125;</div><div class="line">      &#125;</div><div class="line">//3.通过 LoadedApk 的 makeApplication() 尝试创建 Application 对象。</div><div class="line">      try &#123;</div><div class="line">          Application app = r.packageInfo.makeApplication(false, mInstrumentation);</div><div class="line"></div><div class="line">          if (localLOGV) Slog.v(TAG, &quot;Performing launch of &quot; + r);</div><div class="line">          if (localLOGV) Slog.v(</div><div class="line">                  TAG, r + &quot;: app=&quot; + app</div><div class="line">                  + &quot;, appName=&quot; + app.getPackageName()</div><div class="line">                  + &quot;, pkg=&quot; + r.packageInfo.getPackageName()</div><div class="line">                  + &quot;, comp=&quot; + r.intent.getComponent().toShortString()</div><div class="line">                  + &quot;, dir=&quot; + r.packageInfo.getAppDir());</div><div class="line"></div><div class="line">          if (activity != null) &#123;</div><div class="line">          //4.创建 ContextImpl 对象并通过 Activity 的 attach 方法来完成一些重要数据的初始化</div><div class="line">              Context appContext = createBaseContextForActivity(r, activity);</div><div class="line">              CharSequence title = r.activityInfo.loadLabel(appContext.getPackageManager());</div><div class="line">              Configuration config = new Configuration(mCompatConfiguration);</div><div class="line">              if (r.overrideConfig != null) &#123;</div><div class="line">                  config.updateFrom(r.overrideConfig);</div><div class="line">              &#125;</div><div class="line">              if (DEBUG_CONFIGURATION) Slog.v(TAG, &quot;Launching activity &quot;</div><div class="line">                      + r.activityInfo.name + &quot; with config &quot; + config);</div><div class="line">              Window window = null;</div><div class="line">              if (r.mPendingRemoveWindow != null &amp;&amp; r.mPreserveWindow) &#123;</div><div class="line">                  window = r.mPendingRemoveWindow;</div><div class="line">                  r.mPendingRemoveWindow = null;</div><div class="line">                  r.mPendingRemoveWindowManager = null;</div><div class="line">              &#125;</div><div class="line">              // Context 与 Activity 之间关联的方法 </div><div class="line">              activity.attach(appContext, this, getInstrumentation(), r.token,</div><div class="line">                      r.ident, app, r.intent, r.activityInfo, title, r.parent,</div><div class="line">                      r.embeddedID, r.lastNonConfigurationInstances, config,</div><div class="line">                      r.referrer, r.voiceInteractor, window);</div><div class="line"></div><div class="line">              if (customIntent != null) &#123;</div><div class="line">                  activity.mIntent = customIntent;</div><div class="line">              &#125;</div><div class="line">              r.lastNonConfigurationInstances = null;</div><div class="line">              activity.mStartedActivity = false;</div><div class="line">              int theme = r.activityInfo.getThemeResource();</div><div class="line">              if (theme != 0) &#123;</div><div class="line">                  activity.setTheme(theme);</div><div class="line">              &#125;</div><div class="line"></div><div class="line">              activity.mCalled = false;</div><div class="line">              if (r.isPersistable()) &#123;</div><div class="line">                  mInstrumentation.callActivityOnCreate(activity, r.state, r.persistentState);</div><div class="line">              &#125; else &#123;</div><div class="line">                  mInstrumentation.callActivityOnCreate(activity, r.state);</div><div class="line">              &#125;</div><div class="line">              if (!activity.mCalled) &#123;</div><div class="line">                  throw new SuperNotCalledException(</div><div class="line">                      &quot;Activity &quot; + r.intent.getComponent().toShortString() +</div><div class="line">                      &quot; did not call through to super.onCreate()&quot;);</div><div class="line">              &#125;</div><div class="line">              r.activity = activity;</div><div class="line">              r.stopped = true;</div><div class="line">              if (!r.activity.mFinished) &#123;</div><div class="line">                  activity.performStart();</div><div class="line">                  r.stopped = false;</div><div class="line">              &#125;</div><div class="line">              if (!r.activity.mFinished) &#123;</div><div class="line">                  if (r.isPersistable()) &#123;</div><div class="line">                      if (r.state != null || r.persistentState != null) &#123;</div><div class="line">                          mInstrumentation.callActivityOnRestoreInstanceState(activity, r.state,</div><div class="line">                                  r.persistentState);</div><div class="line">                      &#125;</div><div class="line">                  &#125; else if (r.state != null) &#123;</div><div class="line">                      mInstrumentation.callActivityOnRestoreInstanceState(activity, r.state);</div><div class="line">                  &#125;</div><div class="line">              &#125;</div><div class="line">              if (!r.activity.mFinished) &#123;</div><div class="line">                  activity.mCalled = false;</div><div class="line">                  if (r.isPersistable()) &#123;</div><div class="line">                      mInstrumentation.callActivityOnPostCreate(activity, r.state,</div><div class="line">                              r.persistentState);</div><div class="line">                  &#125; else &#123;</div><div class="line">                      mInstrumentation.callActivityOnPostCreate(activity, r.state);</div><div class="line">                  &#125;</div><div class="line">                  if (!activity.mCalled) &#123;</div><div class="line">                      throw new SuperNotCalledException(</div><div class="line">                          &quot;Activity &quot; + r.intent.getComponent().toShortString() +</div><div class="line">                          &quot; did not call through to super.onPostCreate()&quot;);</div><div class="line">                  &#125;</div><div class="line">              &#125;</div><div class="line">          &#125;</div><div class="line">          r.paused = true;</div><div class="line"></div><div class="line">          mActivities.put(r.token, r);</div><div class="line"></div><div class="line">      &#125; catch (SuperNotCalledException e) &#123;</div><div class="line">          throw e;</div><div class="line"></div><div class="line">      &#125; catch (Exception e) &#123;</div><div class="line">          if (!mInstrumentation.onException(activity, e)) &#123;</div><div class="line">              throw new RuntimeException(</div><div class="line">                  &quot;Unable to start activity &quot; + component</div><div class="line">                  + &quot;: &quot; + e.toString(), e);</div><div class="line">          &#125;</div><div class="line">      &#125;</div><div class="line"></div><div class="line">      return activity;</div><div class="line">  &#125;</div></pre></td></tr></table></figure>
<p> ContextImpl 是 Context 的具体实现，它通过 Activity 的 attach() 方法和 Activity 建立关联；在 attach() 方法中还会完成 Window 的创建并建立 Activity 和 Window 的关联，当 Window 接收到外部输入事件后就可以将时间传递给 Activity。</p>
<p>mInstrumentation.callActivityOnCreate()  方法调用 Activity 的 onCreate() 方法，这意味着 Acitivity 的整个启动过程已经完成。</p>

      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        

      
    </div>

    <footer class="post-footer">
      

      
        
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2017/04/29/Service-启动源码解析/" rel="next" title="Service 启动源码解析">
                <i class="fa fa-chevron-left"></i> Service 启动源码解析
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2017/04/25/经典算法-冒泡排序再优化/" rel="prev" title="经典算法--冒泡排序再优化">
                经典算法--冒泡排序再优化 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/avatar.gif"
               alt="zhangzaidong" />
          <p class="site-author-name" itemprop="name">zhangzaidong</p>
           
              <p class="site-description motion-element" itemprop="description"></p>
          
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives">
                <span class="site-state-item-count">10</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          

          

        </nav>

        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        
        

        


      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-4"><a class="nav-link" href="#Activity-的创建和加载"><span class="nav-number">1.</span> <span class="nav-text">Activity 的创建和加载</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2017</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">zhangzaidong</span>
</div>


<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Pisces
  </a>
</div>


        

        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  






  



  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>

  
  <script type="text/javascript" src="/lib/canvas-ribbon/canvas-ribbon.js"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.0"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.0"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.0"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.0"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.0"></script>



  


  




	





  





  





  






  





  

  

  

  

  

</body>
</html>
