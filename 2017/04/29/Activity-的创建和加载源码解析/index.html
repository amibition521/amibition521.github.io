<!doctype html>




<html class="theme-next pisces" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  
    
      
    

    
  

  

  
    
      
    

    
  

  
    
      
    

    
  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Monda:300,300italic,400,400italic,700,700italic|Roboto Slab:300,300italic,400,400italic,700,700italic|Lobster Two:300,300italic,400,400italic,700,700italic|PT Mono:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.0" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Android," />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.0" />






<meta name="description" content="Activity 的创建和加载1.我们通过调用 startActivity() 方法来启动一个 Activity，startActivity() 方法有几种重载的方式，但都会最终调用 startActivityForResult() 方法，代码如下： 12345678910@Override    public void startActivity(Intent intent, @Nullable">
<meta name="keywords" content="Android">
<meta property="og:type" content="article">
<meta property="og:title" content="Activity 的创建和加载源码解析">
<meta property="og:url" content="http://yoursite.com/2017/04/29/Activity-的创建和加载源码解析/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="Activity 的创建和加载1.我们通过调用 startActivity() 方法来启动一个 Activity，startActivity() 方法有几种重载的方式，但都会最终调用 startActivityForResult() 方法，代码如下： 12345678910@Override    public void startActivity(Intent intent, @Nullable">
<meta property="og:updated_time" content="2017-05-21T13:12:05.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Activity 的创建和加载源码解析">
<meta name="twitter:description" content="Activity 的创建和加载1.我们通过调用 startActivity() 方法来启动一个 Activity，startActivity() 方法有几种重载的方式，但都会最终调用 startActivityForResult() 方法，代码如下： 12345678910@Override    public void startActivity(Intent intent, @Nullable">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    sidebar: {"position":"left","display":"post","offset":12,"offset_float":0,"b2t":false,"scrollpercent":false},
    fancybox: true,
    motion: false,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/2017/04/29/Activity-的创建和加载源码解析/"/>





  <title> Activity 的创建和加载源码解析 | Hexo </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  














  
  
    
  

  <div class="container sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Hexo</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/04/29/Activity-的创建和加载源码解析/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="喝咖啡的鱼儿">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/uploads/header.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                Activity 的创建和加载源码解析
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-04-29T14:57:00+08:00">
                2017-04-29
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android/" itemprop="url" rel="index">
                    <span itemprop="name">Android</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        <h4 id="Activity-的创建和加载"><a href="#Activity-的创建和加载" class="headerlink" title="Activity 的创建和加载"></a>Activity 的创建和加载</h4><p>1.我们通过调用 startActivity() 方法来启动一个 Activity，startActivity() 方法有几种重载的方式，但都会最终调用 startActivityForResult() 方法，代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">startActivity</span><span class="params">(Intent intent, @Nullable Bundle options)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (options != <span class="keyword">null</span>) &#123;</div><div class="line">            startActivityForResult(intent, -<span class="number">1</span>, options);</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="comment">// Note we want to go through this call for compatibility with</span></div><div class="line">            <span class="comment">// applications that may have overridden the method.</span></div><div class="line">            startActivityForResult(intent, -<span class="number">1</span>);</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>startActivityForResule() 方法，代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Base class for implementing application instrumentation code.  When running</div><div class="line"> * with instrumentation turned on, this class will be instantiated for you</div><div class="line"> * before any of the application code, allowing you to monitor all of the</div><div class="line"> * interaction the system has with the application.  An Instrumentation</div><div class="line"> * implementation is described to the system through an AndroidManifest.xml's</div><div class="line"> * &amp;lt;instrumentation&amp;gt; tag.</div><div class="line"> */</div><div class="line"><span class="comment">// set by the thread after the constructor and before onCreate(Bundle savedInstanceState) is called.</span></div><div class="line">    <span class="keyword">private</span> Instrumentation mInstrumentation;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">startActivityForResult</span><span class="params">(@RequiresPermission Intent intent, <span class="keyword">int</span> requestCode,</span></span></div><div class="line">            @Nullable Bundle options) &#123;</div><div class="line">        <span class="keyword">if</span> (mParent == <span class="keyword">null</span>) &#123;</div><div class="line">            options = transferSpringboardActivityOptions(options);</div><div class="line">            Instrumentation.ActivityResult ar =</div><div class="line">                mInstrumentation.execStartActivity(</div><div class="line">                    <span class="keyword">this</span>, mMainThread.getApplicationThread(), mToken, <span class="keyword">this</span>,</div><div class="line">                    intent, requestCode, options);</div><div class="line">            <span class="keyword">if</span> (ar != <span class="keyword">null</span>) &#123;</div><div class="line">                mMainThread.sendActivityResult(</div><div class="line">                    mToken, mEmbeddedID, requestCode, ar.getResultCode(),</div><div class="line">                    ar.getResultData());</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">if</span> (requestCode &gt;= <span class="number">0</span>) &#123;</div><div class="line">                <span class="comment">// If this start is requesting a result, we can avoid making</span></div><div class="line">                <span class="comment">// the activity visible until the result is received.  Setting</span></div><div class="line">                <span class="comment">// this code during onCreate(Bundle savedInstanceState) or onResume() will keep the</span></div><div class="line">                <span class="comment">// activity hidden during this time, to avoid flickering.</span></div><div class="line">                <span class="comment">// This can only be done when a result is requested because</span></div><div class="line">                <span class="comment">// that guarantees we will get information back when the</span></div><div class="line">                <span class="comment">// activity is finished, no matter what happens to it.</span></div><div class="line">                mStartedActivity = <span class="keyword">true</span>;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            cancelInputsAndStartExitTransition(options);</div><div class="line">            <span class="comment">// TODO Consider clearing/flushing other event sources and events for child windows.</span></div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="keyword">if</span> (options != <span class="keyword">null</span>) &#123;</div><div class="line">                mParent.startActivityFromChild(<span class="keyword">this</span>, intent, requestCode, options);</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                <span class="comment">// Note we want to go through this method for compatibility with</span></div><div class="line">                <span class="comment">// existing applications that may have overridden it.</span></div><div class="line">                mParent.startActivityFromChild(<span class="keyword">this</span>, intent, requestCode);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>在这个方法中，通过 execStartActivity () 方法的调用来开启一个 Activity,这个方法的第二个参数是 mMainThread.getApplicationThread() 方法返回的是一个 ApplicationThread 类型，ApplicationThread 是 ActivityThread 的内部类，ApplicationThread 和 ActivityThread 是 Activity 启动过程中很重要的两个元素， 下面我们接着看 execStartActivity() 方法，代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Execute a startActivity call made by the application.  The default </div><div class="line"> * implementation takes care of updating any active &#123;<span class="doctag">@link</span> ActivityMonitor&#125;</div><div class="line"> * objects and dispatches this call to the system activity manager; you can</div><div class="line"> * override this to watch for the application to start an activity, and </div><div class="line"> * modify what happens when it does. </div><div class="line"> *</div><div class="line"> * &lt;p&gt;This method returns an &#123;<span class="doctag">@link</span> ActivityResult&#125; object, which you can </div><div class="line"> * use when intercepting application calls to avoid performing the start </div><div class="line"> * activity action but still return the result the application is </div><div class="line"> * expecting.  To do this, override this method to catch the call to start </div><div class="line"> * activity so that it returns a new ActivityResult containing the results </div><div class="line"> * you would like the application to see, and don't call up to the super </div><div class="line"> * class.  Note that an application is only expecting a result if </div><div class="line"> * &lt;var&gt;requestCode&lt;/var&gt; is &amp;gt;= 0.</div><div class="line"> *</div><div class="line"> * &lt;p&gt;This method throws &#123;<span class="doctag">@link</span> android.content.ActivityNotFoundException&#125;</div><div class="line"> * if there was no Activity found to run the given Intent.</div><div class="line"> *</div><div class="line"> * <span class="doctag">@param</span> who The Context from which the activity is being started.</div><div class="line"> * <span class="doctag">@param</span> contextThread The main thread of the Context from which the activity</div><div class="line"> *                      is being started.</div><div class="line"> * <span class="doctag">@param</span> token Internal token identifying to the system who is starting </div><div class="line"> *              the activity; may be null.</div><div class="line"> * <span class="doctag">@param</span> target Which activity is performing the start (and thus receiving </div><div class="line"> *               any result); may be null if this call is not being made</div><div class="line"> *               from an activity.</div><div class="line"> * <span class="doctag">@param</span> intent The actual Intent to start.</div><div class="line"> * <span class="doctag">@param</span> requestCode Identifier for this request's result; less than zero </div><div class="line"> *                    if the caller is not expecting a result.</div><div class="line"> * <span class="doctag">@param</span> options Addition options.</div><div class="line"> *</div><div class="line"> * <span class="doctag">@return</span> To force the return of a particular result, return an </div><div class="line"> *         ActivityResult object containing the desired data; otherwise</div><div class="line"> *         return null.  The default implementation always returns null.</div><div class="line"> *</div><div class="line"> * <span class="doctag">@throws</span> android.content.ActivityNotFoundException</div><div class="line"> *</div><div class="line"> * <span class="doctag">@see</span> Activity#startActivity(Intent)</div><div class="line"> * <span class="doctag">@see</span> Activity#startActivityForResult(Intent, int)</div><div class="line"> * <span class="doctag">@see</span> Activity#startActivityFromChild</div><div class="line"> *</div><div class="line"> * &#123;<span class="doctag">@hide</span>&#125;</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">public</span> ActivityResult <span class="title">execStartActivity</span><span class="params">(</span></span></div><div class="line">        Context who, IBinder contextThread, IBinder token, Activity target,</div><div class="line">        Intent intent, <span class="keyword">int</span> requestCode, Bundle options) &#123;</div><div class="line">    IApplicationThread whoThread = (IApplicationThread) contextThread;</div><div class="line">    Uri referrer = target != <span class="keyword">null</span> ? target.onProvideReferrer() : <span class="keyword">null</span>;</div><div class="line">    <span class="keyword">if</span> (referrer != <span class="keyword">null</span>) &#123;</div><div class="line">        intent.putExtra(Intent.EXTRA_REFERRER, referrer);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (mActivityMonitors != <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="keyword">synchronized</span> (mSync) &#123;</div><div class="line">            <span class="keyword">final</span> <span class="keyword">int</span> N = mActivityMonitors.size();</div><div class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;N; i++) &#123;</div><div class="line">                <span class="keyword">final</span> ActivityMonitor am = mActivityMonitors.get(i);</div><div class="line">                <span class="keyword">if</span> (am.match(who, <span class="keyword">null</span>, intent)) &#123;</div><div class="line">                    am.mHits++;</div><div class="line">                    <span class="keyword">if</span> (am.isBlocking()) &#123;</div><div class="line">                        <span class="keyword">return</span> requestCode &gt;= <span class="number">0</span> ? am.getResult() : <span class="keyword">null</span>;</div><div class="line">                    &#125;</div><div class="line">                    <span class="keyword">break</span>;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        intent.migrateExtraStreamToClipData();</div><div class="line">        intent.prepareToLeaveProcess(who);</div><div class="line">        <span class="comment">// 开始启动 Activity</span></div><div class="line">        <span class="keyword">int</span> result = ActivityManagerNative.getDefault()</div><div class="line">            .startActivity(whoThread, who.getBasePackageName(), intent,</div><div class="line">                    intent.resolveTypeIfNeeded(who.getContentResolver()),</div><div class="line">                    token, target != <span class="keyword">null</span> ? target.mEmbeddedID : <span class="keyword">null</span>,</div><div class="line">                    requestCode, <span class="number">0</span>, <span class="keyword">null</span>, options);</div><div class="line">        <span class="comment">// 检查 Activity 启动的结果，不正常就抛出异常</span></div><div class="line">        checkStartActivityResult(result, intent);</div><div class="line">    &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"Failure from system"</span>, e);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>启动 Activity 的实现由 ActivityManagerNative.getDefault().startActivity() 实现。ActivityManagerNative 是一个抽象类，继承自 Binder 并实现了 IActivityManager 接口，ActivityManagerService (AMS) 继承自 ActivityManagerNative，因此 AMS 也是一个 Binder 接口，是 IActivityManager 的具体实现，</p>
<p>在 ActivityManagerNative 中，getDefault() 方法得代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Retrieve the system's default/global activity manager.</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">public</span> IActivityManager <span class="title">getDefault</span><span class="params">()</span> </span>&#123;</div><div class="line">	<span class="keyword">return</span> gDefault.get();</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Singleton&lt;IActivityManager&gt; gDefault = <span class="keyword">new</span> Singleton&lt;IActivityManager&gt;() &#123;</div><div class="line">        <span class="function"><span class="keyword">protected</span> IActivityManager <span class="title">create</span><span class="params">()</span> </span>&#123;</div><div class="line">            IBinder b = ServiceManager.getService(<span class="string">"activity"</span>);</div><div class="line">            <span class="keyword">if</span> (<span class="keyword">false</span>) &#123;</div><div class="line">                Log.v(<span class="string">"ActivityManager"</span>, <span class="string">"default service binder = "</span> + b);</div><div class="line">            &#125;</div><div class="line">            IActivityManager am = asInterface(b);</div><div class="line">            <span class="keyword">if</span> (<span class="keyword">false</span>) &#123;</div><div class="line">                Log.v(<span class="string">"ActivityManager"</span>, <span class="string">"default service = "</span> + am);</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">return</span> am;</div><div class="line">        &#125;</div><div class="line">    &#125;;</div><div class="line">    </div><div class="line"><span class="comment">/**</span></div><div class="line"> * Singleton helper class for lazily initialization.</div><div class="line"> *</div><div class="line"> * Modeled after frameworks/base/include/utils/Singleton.h</div><div class="line"> *</div><div class="line"> * <span class="doctag">@hide</span></div><div class="line"> */</div><div class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">Singleton</span>&lt;<span class="title">T</span>&gt; </span>&#123;</div><div class="line">    <span class="keyword">private</span> T mInstance;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> T <span class="title">create</span><span class="params">()</span></span>;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> T <span class="title">get</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</div><div class="line">            <span class="keyword">if</span> (mInstance == <span class="keyword">null</span>) &#123;</div><div class="line">                mInstance = create();</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">return</span> mInstance;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>AMS 这个Binder 接口 采用单例模式对外提供，由此可以 Activity 的启动是 AMS 调用 startActivity() 方法来启动的，代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="title">startActivity</span><span class="params">(IApplicationThread caller, String callingPackage,</span></span></div><div class="line">            Intent intent, String resolvedType, IBinder resultTo, String resultWho, <span class="keyword">int</span> requestCode,</div><div class="line">            <span class="keyword">int</span> startFlags, ProfilerInfo profilerInfo, Bundle bOptions) &#123;</div><div class="line">        <span class="keyword">return</span> startActivityAsUser(caller, callingPackage, intent, resolvedType, resultTo,</div><div class="line">                resultWho, requestCode, startFlags, profilerInfo, bOptions,</div><div class="line">                UserHandle.getCallingUserId());</div><div class="line">    &#125;</div><div class="line"></div><div class="line"><span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="title">startActivityAsUser</span><span class="params">(IApplicationThread caller, String callingPackage,</span></span></div><div class="line">            Intent intent, String resolvedType, IBinder resultTo, String resultWho, <span class="keyword">int</span> requestCode,</div><div class="line">            <span class="keyword">int</span> startFlags, ProfilerInfo profilerInfo, Bundle bOptions, <span class="keyword">int</span> userId) &#123;</div><div class="line">        enforceNotIsolatedCaller(<span class="string">"startActivity"</span>);</div><div class="line">        userId = mUserController.handleIncomingUser(Binder.getCallingPid(), Binder.getCallingUid(),</div><div class="line">                userId, <span class="keyword">false</span>, ALLOW_FULL_ONLY, <span class="string">"startActivity"</span>, <span class="keyword">null</span>);</div><div class="line">        <span class="comment">// <span class="doctag">TODO:</span> Switch to user app stacks here.</span></div><div class="line">        <span class="comment">//</span></div><div class="line">        <span class="keyword">return</span> mActivityStarter.startActivityMayWait(caller, -<span class="number">1</span>, callingPackage, intent,</div><div class="line">                resolvedType, <span class="keyword">null</span>, <span class="keyword">null</span>, resultTo, resultWho, requestCode, startFlags,</div><div class="line">                profilerInfo, <span class="keyword">null</span>, <span class="keyword">null</span>, bOptions, <span class="keyword">false</span>, userId, <span class="keyword">null</span>, <span class="keyword">null</span>);</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>从这个函数开始由一串很长的方法调用，我们一个一个分析，首先，调用 mActivityStarter.startActivityMayWait() 方法，这个 mActivityStarter 的作用是控制 Activity 的中断和启动，搜集 Activity 启动的相关逻辑；在 ActivityStarter 中有一个 ActivityStackSupervisor 类，这个类的作用是负责管理 ActivityStack; 在 startActivityMayWait() 方法中由调用了 startActivityLocked() 方法，在其中调用 startActivityUnchecked() 方法，接着调用了 resumeFocusedStackTopActivityLocked() 方法，接着调用了 ActivityStack 的 resumeTopActivityUncheckedLocked() 方法，这个启动过程从 ActivityStackSupervisor 转移到 ActivityStack。</p>
<p>分析一下 resumeTopActivityUncheckedLocked() 方法，代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line">    * Ensure that the top activity in the stack is resumed.</div><div class="line">    *</div><div class="line">    * <span class="doctag">@param</span> prev The previously resumed activity, for when in the process</div><div class="line">    * of pausing; can be null to call from elsewhere.</div><div class="line">    * <span class="doctag">@param</span> options Activity options.</div><div class="line">    *</div><div class="line">    * <span class="doctag">@return</span> Returns true if something is being resumed, or false if</div><div class="line">    * nothing happened.</div><div class="line">    *</div><div class="line">    * <span class="doctag">NOTE:</span> It is not safe to call this method directly as it can cause an activity in a</div><div class="line">    *       non-focused stack to be resumed.</div><div class="line">    *       Use &#123;<span class="doctag">@link</span> ActivityStackSupervisor#resumeFocusedStackTopActivityLocked&#125; to resume the</div><div class="line">    *       right activity for the current system state.</div><div class="line">    */</div><div class="line">   <span class="function"><span class="keyword">boolean</span> <span class="title">resumeTopActivityUncheckedLocked</span><span class="params">(ActivityRecord prev, ActivityOptions options)</span> </span>&#123;</div><div class="line">       <span class="keyword">if</span> (mStackSupervisor.inResumeTopActivity) &#123;</div><div class="line">           <span class="comment">// Don't even start recursing.</span></div><div class="line">           <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">       &#125;</div><div class="line"></div><div class="line">       <span class="keyword">boolean</span> result = <span class="keyword">false</span>;</div><div class="line">       <span class="keyword">try</span> &#123;</div><div class="line">           <span class="comment">// Protect against recursion.</span></div><div class="line">           mStackSupervisor.inResumeTopActivity = <span class="keyword">true</span>;</div><div class="line">           <span class="keyword">if</span> (mService.mLockScreenShown == ActivityManagerService.LOCK_SCREEN_LEAVING) &#123;</div><div class="line">               mService.mLockScreenShown = ActivityManagerService.LOCK_SCREEN_HIDDEN;</div><div class="line">               mService.updateSleepIfNeededLocked();</div><div class="line">           &#125;</div><div class="line">           result = resumeTopActivityInnerLocked(prev, options);</div><div class="line">       &#125; <span class="keyword">finally</span> &#123;</div><div class="line">           mStackSupervisor.inResumeTopActivity = <span class="keyword">false</span>;</div><div class="line">       &#125;</div><div class="line">       <span class="keyword">return</span> result;</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<p>在这个方法调用了resumeTopActivityInnerLocked() 方法,接着在其中调用了 ActivityStackSupervisor 的 startSpecificActivityLocked() 方法，代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">startSpecificActivityLocked</span><span class="params">(ActivityRecord r,</span></span></div><div class="line">        <span class="keyword">boolean</span> andResume, <span class="keyword">boolean</span> checkConfig) &#123;</div><div class="line">    <span class="comment">// Is this activity's application already running?</span></div><div class="line">    ProcessRecord app = mService.getProcessRecordLocked(r.processName,</div><div class="line">            r.info.applicationInfo.uid, <span class="keyword">true</span>);</div><div class="line"></div><div class="line">    r.task.stack.setLaunchTime(r);</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (app != <span class="keyword">null</span> &amp;&amp; app.thread != <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            <span class="keyword">if</span> ((r.info.flags&amp;ActivityInfo.FLAG_MULTIPROCESS) == <span class="number">0</span></div><div class="line">                    || !<span class="string">"android"</span>.equals(r.info.packageName)) &#123;</div><div class="line">                <span class="comment">// Don't add this if it is a platform component that is marked</span></div><div class="line">                <span class="comment">// to run in multiple processes, because this is actually</span></div><div class="line">                <span class="comment">// part of the framework so doesn't make sense to track as a</span></div><div class="line">                <span class="comment">// separate apk in the process.</span></div><div class="line">                app.addPackage(r.info.packageName, r.info.applicationInfo.versionCode,</div><div class="line">                        mService.mProcessStats);</div><div class="line">            &#125;</div><div class="line">            realStartActivityLocked(r, app, andResume, checkConfig);</div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</div><div class="line">            Slog.w(TAG, <span class="string">"Exception when starting activity "</span></div><div class="line">                    + r.intent.getComponent().flattenToShortString(), e);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// If a dead object exception was thrown -- fall through to</span></div><div class="line">        <span class="comment">// restart the application.</span></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    mService.startProcessLocked(r.processName, r.info.applicationInfo, <span class="keyword">true</span>, <span class="number">0</span>,</div><div class="line">            <span class="string">"activity"</span>, r.intent.getComponent(), <span class="keyword">false</span>, <span class="keyword">false</span>, <span class="keyword">true</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>上述代码中，调用了 realStartActivityLocked() 方法；说明 Activity 的启动过程是在 ActivityStackSupervisor 和 ActivityStack 之间传递顺序的。</p>
<p>在 realStartActivityLocked() 方法中，又如下代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">app.thread.scheduleLaunchActivity(<span class="keyword">new</span> Intent(r.intent), r.appToken,</div><div class="line">                    System.identityHashCode(r), r.info, <span class="keyword">new</span> Configuration(mService.mConfiguration),</div><div class="line">                    <span class="keyword">new</span> Configuration(task.mOverrideConfig), r.compat, r.launchedFromPackage,</div><div class="line">                    task.voiceInteractor, app.repProcState, r.icicle, r.persistentState, results,</div><div class="line">                    newIntents, !andResume, mService.isNextTransitionForward(), profilerInfo);</div></pre></td></tr></table></figure>
<p>在上述代码中，app.thread 的类型为 IApplicationThread，它的作用是负责 activityManager 和 Application 之间的通信，它里面完成了大量的和 activity 以及 service 启动和停止相关的功能,代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * System private API for communicating with the application.  This is given to</div><div class="line"> * the activity manager by an application  when it starts up, for the activity</div><div class="line"> * manager to tell the application about things it needs to do.</div><div class="line"> *</div><div class="line"> * &#123;<span class="doctag">@hide</span>&#125;</div><div class="line"> */</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">IApplicationThread</span> <span class="keyword">extends</span> <span class="title">IInterface</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">schedulePauseActivity</span><span class="params">(IBinder token, <span class="keyword">boolean</span> finished, <span class="keyword">boolean</span> userLeaving,</span></span></div><div class="line">            <span class="keyword">int</span> configChanges, <span class="keyword">boolean</span> dontReport) <span class="keyword">throws</span> RemoteException;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">scheduleStopActivity</span><span class="params">(IBinder token, <span class="keyword">boolean</span> showWindow,</span></span></div><div class="line">            <span class="keyword">int</span> configChanges) <span class="keyword">throws</span> RemoteException;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">scheduleWindowVisibility</span><span class="params">(IBinder token, <span class="keyword">boolean</span> showWindow)</span> <span class="keyword">throws</span> RemoteException</span>;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">scheduleSleeping</span><span class="params">(IBinder token, <span class="keyword">boolean</span> sleeping)</span> <span class="keyword">throws</span> RemoteException</span>;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">scheduleResumeActivity</span><span class="params">(IBinder token, <span class="keyword">int</span> procState, <span class="keyword">boolean</span> isForward, Bundle resumeArgs)</span></span></div><div class="line">            <span class="keyword">throws</span> RemoteException;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">scheduleSendResult</span><span class="params">(IBinder token, List&lt;ResultInfo&gt; results)</span> <span class="keyword">throws</span> RemoteException</span>;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">scheduleLaunchActivity</span><span class="params">(Intent intent, IBinder token, <span class="keyword">int</span> ident,</span></span></div><div class="line">            ActivityInfo info, Configuration curConfig, Configuration overrideConfig,</div><div class="line">            CompatibilityInfo compatInfo, String referrer, IVoiceInteractor voiceInteractor,</div><div class="line">            <span class="keyword">int</span> procState, Bundle state, PersistableBundle persistentState,</div><div class="line">            List&lt;ResultInfo&gt; pendingResults, List&lt;ReferrerIntent&gt; pendingNewIntents,</div><div class="line">            <span class="keyword">boolean</span> notResumed, <span class="keyword">boolean</span> isForward, ProfilerInfo profilerInfo) <span class="keyword">throws</span> RemoteException;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">scheduleRelaunchActivity</span><span class="params">(IBinder token, List&lt;ResultInfo&gt; pendingResults,</span></span></div><div class="line">            List&lt;ReferrerIntent&gt; pendingNewIntents, <span class="keyword">int</span> configChanges, <span class="keyword">boolean</span> notResumed,</div><div class="line">            Configuration config, Configuration overrideConfig, <span class="keyword">boolean</span> preserveWindow)</div><div class="line">            <span class="keyword">throws</span> RemoteException;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">scheduleNewIntent</span><span class="params">(</span></span></div><div class="line">            List&lt;ReferrerIntent&gt; intent, IBinder token, <span class="keyword">boolean</span> andPause) <span class="keyword">throws</span> RemoteException;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">scheduleDestroyActivity</span><span class="params">(IBinder token, <span class="keyword">boolean</span> finished,</span></span></div><div class="line">            <span class="keyword">int</span> configChanges) <span class="keyword">throws</span> RemoteException;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">scheduleReceiver</span><span class="params">(Intent intent, ActivityInfo info, CompatibilityInfo compatInfo,</span></span></div><div class="line">            <span class="keyword">int</span> resultCode, String data, Bundle extras, <span class="keyword">boolean</span> sync,</div><div class="line">            <span class="keyword">int</span> sendingUser, <span class="keyword">int</span> processState) <span class="keyword">throws</span> RemoteException;</div><div class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> BACKUP_MODE_INCREMENTAL = <span class="number">0</span>;</div><div class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> BACKUP_MODE_FULL = <span class="number">1</span>;</div><div class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> BACKUP_MODE_RESTORE = <span class="number">2</span>;</div><div class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> BACKUP_MODE_RESTORE_FULL = <span class="number">3</span>;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">scheduleCreateBackupAgent</span><span class="params">(ApplicationInfo app, CompatibilityInfo compatInfo,</span></span></div><div class="line">            <span class="keyword">int</span> backupMode) <span class="keyword">throws</span> RemoteException;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">scheduleDestroyBackupAgent</span><span class="params">(ApplicationInfo app, CompatibilityInfo compatInfo)</span></span></div><div class="line">            <span class="keyword">throws</span> RemoteException;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">scheduleCreateService</span><span class="params">(IBinder token, ServiceInfo info,</span></span></div><div class="line">            CompatibilityInfo compatInfo, <span class="keyword">int</span> processState) <span class="keyword">throws</span> RemoteException;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">scheduleBindService</span><span class="params">(IBinder token,</span></span></div><div class="line">            Intent intent, <span class="keyword">boolean</span> rebind, <span class="keyword">int</span> processState) <span class="keyword">throws</span> RemoteException;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">scheduleUnbindService</span><span class="params">(IBinder token,</span></span></div><div class="line">            Intent intent) <span class="keyword">throws</span> RemoteException;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">scheduleServiceArgs</span><span class="params">(IBinder token, <span class="keyword">boolean</span> taskRemoved, <span class="keyword">int</span> startId,</span></span></div><div class="line">            <span class="keyword">int</span> flags, Intent args) <span class="keyword">throws</span> RemoteException;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">scheduleStopService</span><span class="params">(IBinder token)</span> <span class="keyword">throws</span> RemoteException</span>;</div><div class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> DEBUG_OFF = <span class="number">0</span>;</div><div class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> DEBUG_ON = <span class="number">1</span>;</div><div class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> DEBUG_WAIT = <span class="number">2</span>;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">bindApplication</span><span class="params">(String packageName, ApplicationInfo info, List&lt;ProviderInfo&gt; providers,</span></span></div><div class="line">            ComponentName testName, ProfilerInfo profilerInfo, Bundle testArguments,</div><div class="line">            IInstrumentationWatcher testWatcher, IUiAutomationConnection uiAutomationConnection,</div><div class="line">            <span class="keyword">int</span> debugMode, <span class="keyword">boolean</span> enableBinderTracking, <span class="keyword">boolean</span> trackAllocation,</div><div class="line">            <span class="keyword">boolean</span> restrictedBackupMode, <span class="keyword">boolean</span> persistent, Configuration config,</div><div class="line">            CompatibilityInfo compatInfo, Map&lt;String, IBinder&gt; services, Bundle coreSettings)</div><div class="line">            <span class="keyword">throws</span> RemoteException;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">scheduleExit</span><span class="params">()</span> <span class="keyword">throws</span> RemoteException</span>;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">scheduleSuicide</span><span class="params">()</span> <span class="keyword">throws</span> RemoteException</span>;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">scheduleConfigurationChanged</span><span class="params">(Configuration config)</span> <span class="keyword">throws</span> RemoteException</span>;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">updateTimeZone</span><span class="params">()</span> <span class="keyword">throws</span> RemoteException</span>;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">clearDnsCache</span><span class="params">()</span> <span class="keyword">throws</span> RemoteException</span>;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">setHttpProxy</span><span class="params">(String proxy, String port, String exclList,</span></span></div><div class="line">            Uri pacFileUrl) <span class="keyword">throws</span> RemoteException;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">processInBackground</span><span class="params">()</span> <span class="keyword">throws</span> RemoteException</span>;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">dumpService</span><span class="params">(FileDescriptor fd, IBinder servicetoken, String[] args)</span></span></div><div class="line">            <span class="keyword">throws</span> RemoteException;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">dumpProvider</span><span class="params">(FileDescriptor fd, IBinder servicetoken, String[] args)</span></span></div><div class="line">            <span class="keyword">throws</span> RemoteException;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">scheduleRegisteredReceiver</span><span class="params">(IIntentReceiver receiver, Intent intent,</span></span></div><div class="line">            <span class="keyword">int</span> resultCode, String data, Bundle extras, <span class="keyword">boolean</span> ordered,</div><div class="line">            <span class="keyword">boolean</span> sticky, <span class="keyword">int</span> sendingUser, <span class="keyword">int</span> processState) <span class="keyword">throws</span> RemoteException;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">scheduleLowMemory</span><span class="params">()</span> <span class="keyword">throws</span> RemoteException</span>;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">scheduleActivityConfigurationChanged</span><span class="params">(IBinder token, Configuration overrideConfig,</span></span></div><div class="line">            <span class="keyword">boolean</span> reportToActivity) <span class="keyword">throws</span> RemoteException;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">profilerControl</span><span class="params">(<span class="keyword">boolean</span> start, ProfilerInfo profilerInfo, <span class="keyword">int</span> profileType)</span></span></div><div class="line">            <span class="keyword">throws</span> RemoteException;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">dumpHeap</span><span class="params">(<span class="keyword">boolean</span> managed, String path, ParcelFileDescriptor fd)</span></span></div><div class="line">            <span class="keyword">throws</span> RemoteException;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">attachAgent</span><span class="params">(String path)</span> <span class="keyword">throws</span> RemoteException</span>;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">setSchedulingGroup</span><span class="params">(<span class="keyword">int</span> group)</span> <span class="keyword">throws</span> RemoteException</span>;</div><div class="line">    <span class="comment">// the package has been removed, clean up internal references</span></div><div class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> PACKAGE_REMOVED = <span class="number">0</span>;</div><div class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> EXTERNAL_STORAGE_UNAVAILABLE = <span class="number">1</span>;</div><div class="line">    <span class="comment">// the package is being modified in-place, don't kill it and retain references to it</span></div><div class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> PACKAGE_REMOVED_DONT_KILL = <span class="number">2</span>;</div><div class="line">    <span class="comment">// a previously removed package was replaced with a new version [eg. upgrade, split added, ...]</span></div><div class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> PACKAGE_REPLACED = <span class="number">3</span>;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">dispatchPackageBroadcast</span><span class="params">(<span class="keyword">int</span> cmd, String[] packages)</span> <span class="keyword">throws</span> RemoteException</span>;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">scheduleCrash</span><span class="params">(String msg)</span> <span class="keyword">throws</span> RemoteException</span>;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">dumpActivity</span><span class="params">(FileDescriptor fd, IBinder servicetoken, String prefix, String[] args)</span></span></div><div class="line">            <span class="keyword">throws</span> RemoteException;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">setCoreSettings</span><span class="params">(Bundle coreSettings)</span> <span class="keyword">throws</span> RemoteException</span>;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">updatePackageCompatibilityInfo</span><span class="params">(String pkg, CompatibilityInfo info)</span> <span class="keyword">throws</span> RemoteException</span>;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">scheduleTrimMemory</span><span class="params">(<span class="keyword">int</span> level)</span> <span class="keyword">throws</span> RemoteException</span>;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">dumpMemInfo</span><span class="params">(FileDescriptor fd, Debug.MemoryInfo mem, <span class="keyword">boolean</span> checkin, <span class="keyword">boolean</span> dumpInfo,</span></span></div><div class="line">            <span class="keyword">boolean</span> dumpDalvik, <span class="keyword">boolean</span> dumpSummaryOnly, <span class="keyword">boolean</span> dumpUnreachable,</div><div class="line">            String[] args) <span class="keyword">throws</span> RemoteException;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">dumpGfxInfo</span><span class="params">(FileDescriptor fd, String[] args)</span> <span class="keyword">throws</span> RemoteException</span>;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">dumpDbInfo</span><span class="params">(FileDescriptor fd, String[] args)</span> <span class="keyword">throws</span> RemoteException</span>;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">unstableProviderDied</span><span class="params">(IBinder provider)</span> <span class="keyword">throws</span> RemoteException</span>;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">requestAssistContextExtras</span><span class="params">(IBinder activityToken, IBinder requestToken, <span class="keyword">int</span> requestType,</span></span></div><div class="line">            <span class="keyword">int</span> sessionId) <span class="keyword">throws</span> RemoteException;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">scheduleTranslucentConversionComplete</span><span class="params">(IBinder token, <span class="keyword">boolean</span> timeout)</span></span></div><div class="line">            <span class="keyword">throws</span> RemoteException;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">scheduleOnNewActivityOptions</span><span class="params">(IBinder token, ActivityOptions options)</span></span></div><div class="line">            <span class="keyword">throws</span> RemoteException;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">setProcessState</span><span class="params">(<span class="keyword">int</span> state)</span> <span class="keyword">throws</span> RemoteException</span>;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">scheduleInstallProvider</span><span class="params">(ProviderInfo provider)</span> <span class="keyword">throws</span> RemoteException</span>;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">updateTimePrefs</span><span class="params">(<span class="keyword">boolean</span> is24Hour)</span> <span class="keyword">throws</span> RemoteException</span>;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">scheduleCancelVisibleBehind</span><span class="params">(IBinder token)</span> <span class="keyword">throws</span> RemoteException</span>;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">scheduleBackgroundVisibleBehindChanged</span><span class="params">(IBinder token, <span class="keyword">boolean</span> enabled)</span> <span class="keyword">throws</span> RemoteException</span>;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">scheduleEnterAnimationComplete</span><span class="params">(IBinder token)</span> <span class="keyword">throws</span> RemoteException</span>;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">notifyCleartextNetwork</span><span class="params">(<span class="keyword">byte</span>[] firstPacket)</span> <span class="keyword">throws</span> RemoteException</span>;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">startBinderTracking</span><span class="params">()</span> <span class="keyword">throws</span> RemoteException</span>;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">stopBinderTrackingAndDump</span><span class="params">(FileDescriptor fd)</span> <span class="keyword">throws</span> RemoteException</span>;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">scheduleMultiWindowModeChanged</span><span class="params">(IBinder token, <span class="keyword">boolean</span> isInMultiWindowMode)</span> <span class="keyword">throws</span> RemoteException</span>;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">schedulePictureInPictureModeChanged</span><span class="params">(IBinder token, <span class="keyword">boolean</span> isInPictureInPictureMode)</span> <span class="keyword">throws</span> RemoteException</span>;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">scheduleLocalVoiceInteractionStarted</span><span class="params">(IBinder token, IVoiceInteractor voiceInteractor)</span> <span class="keyword">throws</span> RemoteException</span>;</div><div class="line">......</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ApplicationThread 是 IApplicationThread 的实现类，其中 scheduleLaunchActivity() 方法如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// we use token to identify this activity without having to send the</span></div><div class="line"><span class="comment">// activity itself back to the activity manager. (matters more with ipc)</span></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">scheduleLaunchActivity</span><span class="params">(Intent intent, IBinder token, <span class="keyword">int</span> ident,</span></span></div><div class="line">        ActivityInfo info, Configuration curConfig, Configuration overrideConfig,</div><div class="line">        CompatibilityInfo compatInfo, String referrer, IVoiceInteractor voiceInteractor,</div><div class="line">        <span class="keyword">int</span> procState, Bundle state, PersistableBundle persistentState,</div><div class="line">        List&lt;ResultInfo&gt; pendingResults, List&lt;ReferrerIntent&gt; pendingNewIntents,</div><div class="line">        <span class="keyword">boolean</span> notResumed, <span class="keyword">boolean</span> isForward, ProfilerInfo profilerInfo) &#123;</div><div class="line"></div><div class="line">    updateProcessState(procState, <span class="keyword">false</span>);</div><div class="line"></div><div class="line">    ActivityClientRecord r = <span class="keyword">new</span> ActivityClientRecord();</div><div class="line"></div><div class="line">    r.token = token;</div><div class="line">    r.ident = ident;</div><div class="line">    r.intent = intent;</div><div class="line">    r.referrer = referrer;</div><div class="line">    r.voiceInteractor = voiceInteractor;</div><div class="line">    r.activityInfo = info;</div><div class="line">    r.compatInfo = compatInfo;</div><div class="line">    r.state = state;</div><div class="line">    r.persistentState = persistentState;</div><div class="line"></div><div class="line">    r.pendingResults = pendingResults;</div><div class="line">    r.pendingIntents = pendingNewIntents;</div><div class="line"></div><div class="line">    r.startsNotResumed = notResumed;</div><div class="line">    r.isForward = isForward;</div><div class="line"></div><div class="line">    r.profilerInfo = profilerInfo;</div><div class="line"></div><div class="line">    r.overrideConfig = overrideConfig;</div><div class="line">    updatePendingConfiguration(curConfig);</div><div class="line"></div><div class="line">    sendMessage(H.LAUNCH_ACTIVITY, r);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>它的原理就是发送一个启动 Activity 的消息交由 H(Handler) 处理，实现如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">final</span> H mH = <span class="keyword">new</span> H();</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">sendMessage</span><span class="params">(<span class="keyword">int</span> what, Object obj, <span class="keyword">int</span> arg1, <span class="keyword">int</span> arg2, <span class="keyword">boolean</span> async)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (DEBUG_MESSAGES) Slog.v(</div><div class="line">            TAG, <span class="string">"SCHEDULE "</span> + what + <span class="string">" "</span> + mH.codeToString(what)</div><div class="line">            + <span class="string">": "</span> + arg1 + <span class="string">" / "</span> + obj);</div><div class="line">        Message msg = Message.obtain();</div><div class="line">        msg.what = what;</div><div class="line">        msg.obj = obj;</div><div class="line">        msg.arg1 = arg1;</div><div class="line">        msg.arg2 = arg2;</div><div class="line">        <span class="keyword">if</span> (async) &#123;</div><div class="line">            msg.setAsynchronous(<span class="keyword">true</span>);</div><div class="line">        &#125;</div><div class="line">        mH.sendMessage(msg);</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>H 的代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">H</span> <span class="keyword">extends</span> <span class="title">Handler</span> </span>&#123;</div><div class="line">        <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> LAUNCH_ACTIVITY         = <span class="number">100</span>;</div><div class="line">        <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> PAUSE_ACTIVITY          = <span class="number">101</span>;</div><div class="line">        <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> PAUSE_ACTIVITY_FINISHING= <span class="number">102</span>;</div><div class="line">        <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> STOP_ACTIVITY_SHOW      = <span class="number">103</span>;</div><div class="line">        <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> STOP_ACTIVITY_HIDE      = <span class="number">104</span>;</div><div class="line">        <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> SHOW_WINDOW             = <span class="number">105</span>;</div><div class="line">        <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> HIDE_WINDOW             = <span class="number">106</span>;</div><div class="line">        <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> RESUME_ACTIVITY         = <span class="number">107</span>;</div><div class="line">        <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> SEND_RESULT             = <span class="number">108</span>;</div><div class="line">        <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> DESTROY_ACTIVITY        = <span class="number">109</span>;</div><div class="line">        <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> BIND_APPLICATION        = <span class="number">110</span>;</div><div class="line">        <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> EXIT_APPLICATION        = <span class="number">111</span>;</div><div class="line">        <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> NEW_INTENT              = <span class="number">112</span>;</div><div class="line">        <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> RECEIVER                = <span class="number">113</span>;</div><div class="line">        <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> CREATE_SERVICE          = <span class="number">114</span>;</div><div class="line">        <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> SERVICE_ARGS            = <span class="number">115</span>;</div><div class="line">        <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> STOP_SERVICE            = <span class="number">116</span>;</div><div class="line">        .....</div><div class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleMessage</span><span class="params">(Message msg)</span> </span>&#123;</div><div class="line">            <span class="keyword">if</span> (DEBUG_MESSAGES) Slog.v(TAG, <span class="string">"&gt;&gt;&gt; handling: "</span> + codeToString(msg.what));</div><div class="line">            <span class="keyword">switch</span> (msg.what) &#123;</div><div class="line">                <span class="keyword">case</span> LAUNCH_ACTIVITY: &#123;</div><div class="line">                    Trace.traceBegin(Trace.TRACE_TAG_ACTIVITY_MANAGER, <span class="string">"activityStart"</span>);</div><div class="line">                    <span class="keyword">final</span> ActivityClientRecord r = (ActivityClientRecord) msg.obj;</div><div class="line"></div><div class="line">                    r.packageInfo = getPackageInfoNoCheck(</div><div class="line">                            r.activityInfo.applicationInfo, r.compatInfo);</div><div class="line">                    handleLaunchActivity(r, <span class="keyword">null</span>, <span class="string">"LAUNCH_ACTIVITY"</span>);</div><div class="line">                    Trace.traceEnd(Trace.TRACE_TAG_ACTIVITY_MANAGER);</div><div class="line">                &#125; <span class="keyword">break</span>;</div><div class="line">                <span class="keyword">case</span> RELAUNCH_ACTIVITY: &#123;</div><div class="line">                    Trace.traceBegin(Trace.TRACE_TAG_ACTIVITY_MANAGER, <span class="string">"activityRestart"</span>);</div><div class="line">                    ActivityClientRecord r = (ActivityClientRecord)msg.obj;</div><div class="line">                    handleRelaunchActivity(r);</div><div class="line">                    Trace.traceEnd(Trace.TRACE_TAG_ACTIVITY_MANAGER);</div><div class="line">                &#125; <span class="keyword">break</span>;</div><div class="line">                <span class="keyword">case</span> PAUSE_ACTIVITY: &#123;</div><div class="line">                    Trace.traceBegin(Trace.TRACE_TAG_ACTIVITY_MANAGER, <span class="string">"activityPause"</span>);</div><div class="line">                    SomeArgs args = (SomeArgs) msg.obj;</div><div class="line">                    handlePauseActivity((IBinder) args.arg1, <span class="keyword">false</span>,</div><div class="line">                            (args.argi1 &amp; USER_LEAVING) != <span class="number">0</span>, args.argi2,</div><div class="line">                            (args.argi1 &amp; DONT_REPORT) != <span class="number">0</span>, args.argi3);</div><div class="line">                    maybeSnapshot();</div><div class="line">                    Trace.traceEnd(Trace.TRACE_TAG_ACTIVITY_MANAGER);</div><div class="line">                &#125; <span class="keyword">break</span>;</div><div class="line">                ......</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>从上述代码中可以看出， <strong>Activity 的启动是由 ActivityThread 的 handleLaunchActivity() 方法实现的</strong>，代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">handleLaunchActivity</span><span class="params">(ActivityClientRecord r, Intent customIntent, String reason)</span> </span>&#123;</div><div class="line">        <span class="comment">// If we are getting ready to gc after going to the background, well</span></div><div class="line">        <span class="comment">// we are back active so skip it.</span></div><div class="line">        unscheduleGcIdler();</div><div class="line">        mSomeActivitiesChanged = <span class="keyword">true</span>;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (r.profilerInfo != <span class="keyword">null</span>) &#123;</div><div class="line">            mProfiler.setProfiler(r.profilerInfo);</div><div class="line">            mProfiler.startProfiling();</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// Make sure we are running with the most recent config.</span></div><div class="line">        handleConfigurationChanged(<span class="keyword">null</span>, <span class="keyword">null</span>);</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (localLOGV) Slog.v(</div><div class="line">            TAG, <span class="string">"Handling launch of "</span> + r);</div><div class="line"></div><div class="line">        <span class="comment">// Initialize before creating the activity</span></div><div class="line">        WindowManagerGlobal.initialize();</div><div class="line">		<span class="comment">//完成的 Activity 的创建和启动</span></div><div class="line">        Activity a = performLaunchActivity(r, customIntent);</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (a != <span class="keyword">null</span>) &#123;</div><div class="line">            r.createdConfig = <span class="keyword">new</span> Configuration(mConfiguration);</div><div class="line">            reportSizeConfigurations(r);</div><div class="line">            Bundle oldState = r.state;</div><div class="line">            handleResumeActivity(r.token, <span class="keyword">false</span>, r.isForward,</div><div class="line">                    !r.activity.mFinished &amp;&amp; !r.startsNotResumed, r.lastProcessedSeq, reason);</div><div class="line"></div><div class="line">            <span class="keyword">if</span> (!r.activity.mFinished &amp;&amp; r.startsNotResumed) &#123;</div><div class="line">                <span class="comment">// The activity manager actually wants this one to start out paused, because it</span></div><div class="line">                <span class="comment">// needs to be visible but isn't in the foreground. We accomplish this by going</span></div><div class="line">                <span class="comment">// through the normal startup (because activities expect to go through onResume()</span></div><div class="line">                <span class="comment">// the first time they run, before their window is displayed), and then pausing it.</span></div><div class="line">                <span class="comment">// However, in this case we do -not- need to do the full pause cycle (of freezing</span></div><div class="line">                <span class="comment">// and such) because the activity manager assumes it can just retain the current</span></div><div class="line">                <span class="comment">// state it has.</span></div><div class="line">                performPauseActivityIfNeeded(r, reason);</div><div class="line"></div><div class="line">                <span class="comment">// We need to keep around the original state, in case we need to be created again.</span></div><div class="line">                <span class="comment">// But we only do this for pre-Honeycomb apps, which always save their state when</span></div><div class="line">                <span class="comment">// pausing, so we can not have them save their state when restarting from a paused</span></div><div class="line">                <span class="comment">// state. For HC and later, we want to (and can) let the state be saved as the</span></div><div class="line">                <span class="comment">// normal part of stopping the activity.</span></div><div class="line">                <span class="keyword">if</span> (r.isPreHoneycomb()) &#123;</div><div class="line">                    r.state = oldState;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="comment">// If there was an error, for any reason, tell the activity manager to stop us.</span></div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                ActivityManagerNative.getDefault()</div><div class="line">                    .finishActivity(r.token, Activity.RESULT_CANCELED, <span class="keyword">null</span>,</div><div class="line">                            Activity.DONT_FINISH_TASK_WITH_ACTIVITY);</div><div class="line">            &#125; <span class="keyword">catch</span> (RemoteException ex) &#123;</div><div class="line">                <span class="keyword">throw</span> ex.rethrowFromSystemServer();</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>从上述代码中，performLaunchActivity() 最终完成了 Activity 对象的创建和启动过程，并且 ActivityThread 通过 handleResumeActivity() 方法来调用被启动的 Activity 的 onResume() 方法。</p>
<p>performLaunchActivity() 方法，代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div></pre></td><td class="code"><pre><div class="line">  <span class="function"><span class="keyword">private</span> Activity <span class="title">performLaunchActivity</span><span class="params">(ActivityClientRecord r, Intent customIntent)</span> </span>&#123;</div><div class="line">      <span class="comment">// System.out.println("##### [" + System.currentTimeMillis() + "] ActivityThread.performLaunchActivity(" + r + ")");</span></div><div class="line"><span class="comment">//1.从 ActivityClientRecord 中获取待启动的 Activity 的组件信息</span></div><div class="line">      ActivityInfo aInfo = r.activityInfo;</div><div class="line">      <span class="keyword">if</span> (r.packageInfo == <span class="keyword">null</span>) &#123;</div><div class="line">          r.packageInfo = getPackageInfo(aInfo.applicationInfo, r.compatInfo,</div><div class="line">                  Context.CONTEXT_INCLUDE_CODE);</div><div class="line">      &#125;</div><div class="line"></div><div class="line">      ComponentName component = r.intent.getComponent();</div><div class="line">      <span class="keyword">if</span> (component == <span class="keyword">null</span>) &#123;</div><div class="line">          component = r.intent.resolveActivity(</div><div class="line">              mInitialApplication.getPackageManager());</div><div class="line">          r.intent.setComponent(component);</div><div class="line">      &#125;</div><div class="line"></div><div class="line">      <span class="keyword">if</span> (r.activityInfo.targetActivity != <span class="keyword">null</span>) &#123;</div><div class="line">          component = <span class="keyword">new</span> ComponentName(r.activityInfo.packageName,</div><div class="line">                  r.activityInfo.targetActivity);</div><div class="line">      &#125;</div><div class="line"><span class="comment">//2.通过 Instrumentation 的 newActivity() 方法实用类加载器穿件 Activity 对象</span></div><div class="line">      Activity activity = <span class="keyword">null</span>;</div><div class="line">      <span class="keyword">try</span> &#123;</div><div class="line">          java.lang.ClassLoader cl = r.packageInfo.getClassLoader();</div><div class="line">          activity = mInstrumentation.newActivity(</div><div class="line">                  cl, component.getClassName(), r.intent);</div><div class="line">          StrictMode.incrementExpectedActivityCount(activity.getClass());</div><div class="line">          r.intent.setExtrasClassLoader(cl);</div><div class="line">          r.intent.prepareToEnterProcess();</div><div class="line">          <span class="keyword">if</span> (r.state != <span class="keyword">null</span>) &#123;</div><div class="line">              r.state.setClassLoader(cl);</div><div class="line">          &#125;</div><div class="line">      &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">          <span class="keyword">if</span> (!mInstrumentation.onException(activity, e)) &#123;</div><div class="line">              <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(</div><div class="line">                  <span class="string">"Unable to instantiate activity "</span> + component</div><div class="line">                  + <span class="string">": "</span> + e.toString(), e);</div><div class="line">          &#125;</div><div class="line">      &#125;</div><div class="line"><span class="comment">//3.通过 LoadedApk 的 makeApplication() 尝试创建 Application 对象。</span></div><div class="line">      <span class="keyword">try</span> &#123;</div><div class="line">          Application app = r.packageInfo.makeApplication(<span class="keyword">false</span>, mInstrumentation);</div><div class="line"></div><div class="line">          <span class="keyword">if</span> (localLOGV) Slog.v(TAG, <span class="string">"Performing launch of "</span> + r);</div><div class="line">          <span class="keyword">if</span> (localLOGV) Slog.v(</div><div class="line">                  TAG, r + <span class="string">": app="</span> + app</div><div class="line">                  + <span class="string">", appName="</span> + app.getPackageName()</div><div class="line">                  + <span class="string">", pkg="</span> + r.packageInfo.getPackageName()</div><div class="line">                  + <span class="string">", comp="</span> + r.intent.getComponent().toShortString()</div><div class="line">                  + <span class="string">", dir="</span> + r.packageInfo.getAppDir());</div><div class="line"></div><div class="line">          <span class="keyword">if</span> (activity != <span class="keyword">null</span>) &#123;</div><div class="line">          <span class="comment">//4.创建 ContextImpl 对象并通过 Activity 的 attach 方法来完成一些重要数据的初始化</span></div><div class="line">              Context appContext = createBaseContextForActivity(r, activity);</div><div class="line">              CharSequence title = r.activityInfo.loadLabel(appContext.getPackageManager());</div><div class="line">              Configuration config = <span class="keyword">new</span> Configuration(mCompatConfiguration);</div><div class="line">              <span class="keyword">if</span> (r.overrideConfig != <span class="keyword">null</span>) &#123;</div><div class="line">                  config.updateFrom(r.overrideConfig);</div><div class="line">              &#125;</div><div class="line">              <span class="keyword">if</span> (DEBUG_CONFIGURATION) Slog.v(TAG, <span class="string">"Launching activity "</span></div><div class="line">                      + r.activityInfo.name + <span class="string">" with config "</span> + config);</div><div class="line">              Window window = <span class="keyword">null</span>;</div><div class="line">              <span class="keyword">if</span> (r.mPendingRemoveWindow != <span class="keyword">null</span> &amp;&amp; r.mPreserveWindow) &#123;</div><div class="line">                  window = r.mPendingRemoveWindow;</div><div class="line">                  r.mPendingRemoveWindow = <span class="keyword">null</span>;</div><div class="line">                  r.mPendingRemoveWindowManager = <span class="keyword">null</span>;</div><div class="line">              &#125;</div><div class="line">              <span class="comment">// Context 与 Activity 之间关联的方法 </span></div><div class="line">              activity.attach(appContext, <span class="keyword">this</span>, getInstrumentation(), r.token,</div><div class="line">                      r.ident, app, r.intent, r.activityInfo, title, r.parent,</div><div class="line">                      r.embeddedID, r.lastNonConfigurationInstances, config,</div><div class="line">                      r.referrer, r.voiceInteractor, window);</div><div class="line"></div><div class="line">              <span class="keyword">if</span> (customIntent != <span class="keyword">null</span>) &#123;</div><div class="line">                  activity.mIntent = customIntent;</div><div class="line">              &#125;</div><div class="line">              r.lastNonConfigurationInstances = <span class="keyword">null</span>;</div><div class="line">              activity.mStartedActivity = <span class="keyword">false</span>;</div><div class="line">              <span class="keyword">int</span> theme = r.activityInfo.getThemeResource();</div><div class="line">              <span class="keyword">if</span> (theme != <span class="number">0</span>) &#123;</div><div class="line">                  activity.setTheme(theme);</div><div class="line">              &#125;</div><div class="line"></div><div class="line">              activity.mCalled = <span class="keyword">false</span>;</div><div class="line">              <span class="keyword">if</span> (r.isPersistable()) &#123;</div><div class="line">                  mInstrumentation.callActivityOnCreate(activity, r.state, r.persistentState);</div><div class="line">              &#125; <span class="keyword">else</span> &#123;</div><div class="line">                  mInstrumentation.callActivityOnCreate(activity, r.state);</div><div class="line">              &#125;</div><div class="line">              <span class="keyword">if</span> (!activity.mCalled) &#123;</div><div class="line">                  <span class="keyword">throw</span> <span class="keyword">new</span> SuperNotCalledException(</div><div class="line">                      <span class="string">"Activity "</span> + r.intent.getComponent().toShortString() +</div><div class="line">                      <span class="string">" did not call through to super.onCreate()"</span>);</div><div class="line">              &#125;</div><div class="line">              r.activity = activity;</div><div class="line">              r.stopped = <span class="keyword">true</span>;</div><div class="line">              <span class="keyword">if</span> (!r.activity.mFinished) &#123;</div><div class="line">                  activity.performStart();</div><div class="line">                  r.stopped = <span class="keyword">false</span>;</div><div class="line">              &#125;</div><div class="line">              <span class="keyword">if</span> (!r.activity.mFinished) &#123;</div><div class="line">                  <span class="keyword">if</span> (r.isPersistable()) &#123;</div><div class="line">                      <span class="keyword">if</span> (r.state != <span class="keyword">null</span> || r.persistentState != <span class="keyword">null</span>) &#123;</div><div class="line">                          mInstrumentation.callActivityOnRestoreInstanceState(activity, r.state,</div><div class="line">                                  r.persistentState);</div><div class="line">                      &#125;</div><div class="line">                  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (r.state != <span class="keyword">null</span>) &#123;</div><div class="line">                      mInstrumentation.callActivityOnRestoreInstanceState(activity, r.state);</div><div class="line">                  &#125;</div><div class="line">              &#125;</div><div class="line">              <span class="keyword">if</span> (!r.activity.mFinished) &#123;</div><div class="line">                  activity.mCalled = <span class="keyword">false</span>;</div><div class="line">                  <span class="keyword">if</span> (r.isPersistable()) &#123;</div><div class="line">                      mInstrumentation.callActivityOnPostCreate(activity, r.state,</div><div class="line">                              r.persistentState);</div><div class="line">                  &#125; <span class="keyword">else</span> &#123;</div><div class="line">                      mInstrumentation.callActivityOnPostCreate(activity, r.state);</div><div class="line">                  &#125;</div><div class="line">                  <span class="keyword">if</span> (!activity.mCalled) &#123;</div><div class="line">                      <span class="keyword">throw</span> <span class="keyword">new</span> SuperNotCalledException(</div><div class="line">                          <span class="string">"Activity "</span> + r.intent.getComponent().toShortString() +</div><div class="line">                          <span class="string">" did not call through to super.onPostCreate()"</span>);</div><div class="line">                  &#125;</div><div class="line">              &#125;</div><div class="line">          &#125;</div><div class="line">          r.paused = <span class="keyword">true</span>;</div><div class="line"></div><div class="line">          mActivities.put(r.token, r);</div><div class="line"></div><div class="line">      &#125; <span class="keyword">catch</span> (SuperNotCalledException e) &#123;</div><div class="line">          <span class="keyword">throw</span> e;</div><div class="line"></div><div class="line">      &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">          <span class="keyword">if</span> (!mInstrumentation.onException(activity, e)) &#123;</div><div class="line">              <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(</div><div class="line">                  <span class="string">"Unable to start activity "</span> + component</div><div class="line">                  + <span class="string">": "</span> + e.toString(), e);</div><div class="line">          &#125;</div><div class="line">      &#125;</div><div class="line"></div><div class="line">      <span class="keyword">return</span> activity;</div><div class="line">  &#125;</div></pre></td></tr></table></figure>
<p> ContextImpl 是 Context 的具体实现，它通过 Activity 的 attach() 方法和 Activity 建立关联；在 attach() 方法中还会完成 Window 的创建并建立 Activity 和 Window 的关联，当 Window 接收到外部输入事件后就可以将时间传递给 Activity。</p>
<p>mInstrumentation.callActivityOnCreate()  方法调用 Activity 的 onCreate() 方法，这意味着 Acitivity 的整个启动过程已经完成。</p>

      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        

      
    </div>

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/Android/" rel="tag"># Android</a>
          
        </div>
      

      
        
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2017/04/29/Service-启动源码解析/" rel="next" title="Service 启动源码解析">
                <i class="fa fa-chevron-left"></i> Service 启动源码解析
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2017/04/25/经典算法-冒泡排序再优化/" rel="prev" title="经典算法--冒泡排序再优化">
                经典算法--冒泡排序再优化 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/uploads/header.jpg"
               alt="喝咖啡的鱼儿" />
          <p class="site-author-name" itemprop="name">喝咖啡的鱼儿</p>
           
              <p class="site-description motion-element" itemprop="description">愿你走出半生，归来仍是少年</p>
          
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives">
                <span class="site-state-item-count">23</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-categories">
              
                <span class="site-state-item-count">6</span>
                <span class="site-state-item-name">分类</span>
              
            </div>
          

          
            
            
            <div class="site-state-item site-state-tags">
              
                <span class="site-state-item-count">6</span>
                <span class="site-state-item-name">标签</span>
              
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        
        

        


      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-4"><a class="nav-link" href="#Activity-的创建和加载"><span class="nav-number">1.</span> <span class="nav-text">Activity 的创建和加载</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2017</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">喝咖啡的鱼儿</span>
</div>


<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Pisces
  </a>
</div>


        

        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  








  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.0"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.0"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.0"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.0"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.0"></script>



  


  




	





  





  





  






  





  

  

  

  

  

</body>
</html>
