<!doctype html>




<html class="theme-next pisces" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  
    
      
    

    
  

  

  
    
      
    

    
  

  
    
      
    

    
  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Monda:300,300italic,400,400italic,700,700italic|Roboto Slab:300,300italic,400,400italic,700,700italic|Lobster Two:300,300italic,400,400italic,700,700italic|PT Mono:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.0" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Android," />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.0" />






<meta name="description" content="Service 的启动过程service 的启动过程从 ContextWrapper 的 startService() 方法开始，如下： 123456Context mBase;@Overridepublic ComponentName startService(Intent service) &amp;#123;    return mBase.startService(service);&amp;#125;">
<meta name="keywords" content="Android">
<meta property="og:type" content="article">
<meta property="og:title" content="Service 启动源码解析">
<meta property="og:url" content="http://yoursite.com/2017/04/29/Service-启动源码解析/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="Service 的启动过程service 的启动过程从 ContextWrapper 的 startService() 方法开始，如下： 123456Context mBase;@Overridepublic ComponentName startService(Intent service) &amp;#123;    return mBase.startService(service);&amp;#125;">
<meta property="og:updated_time" content="2017-05-21T13:12:19.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Service 启动源码解析">
<meta name="twitter:description" content="Service 的启动过程service 的启动过程从 ContextWrapper 的 startService() 方法开始，如下： 123456Context mBase;@Overridepublic ComponentName startService(Intent service) &amp;#123;    return mBase.startService(service);&amp;#125;">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    sidebar: {"position":"left","display":"post","offset":12,"offset_float":0,"b2t":false,"scrollpercent":false},
    fancybox: true,
    motion: false,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/2017/04/29/Service-启动源码解析/"/>





  <title> Service 启动源码解析 | Hexo </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  














  
  
    
  

  <div class="container sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Hexo</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/04/29/Service-启动源码解析/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="喝咖啡的鱼儿">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/uploads/header.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                Service 启动源码解析
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-04-29T20:52:55+08:00">
                2017-04-29
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android/" itemprop="url" rel="index">
                    <span itemprop="name">Android</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        <h4 id="Service-的启动过程"><a href="#Service-的启动过程" class="headerlink" title="Service 的启动过程"></a>Service 的启动过程</h4><p>service 的启动过程从 ContextWrapper 的 startService() 方法开始，如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">Context mBase;</div><div class="line"></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> ComponentName <span class="title">startService</span><span class="params">(Intent service)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> mBase.startService(service);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>mBase 的类型是 Context,Context 是一个 abstract class，ContextImpl 继承自 Context, 从 ContextWrapper 的实现来看，大部分操作都是通过 mBase 来实现的，这是一种典型的桥接模式。</p>
<p>下面我们来看 ContextImpl 的 startService() 方法，如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line">   <span class="function"><span class="keyword">public</span> ComponentName <span class="title">startService</span><span class="params">(Intent service)</span> </span>&#123;</div><div class="line">       warnIfCallingFromSystemProcess();</div><div class="line">       <span class="keyword">return</span> startServiceCommon(service, mUser);</div><div class="line">   &#125;</div><div class="line">   <span class="function"><span class="keyword">private</span> ComponentName <span class="title">startServiceCommon</span><span class="params">(Intent service, UserHandle user)</span> </span>&#123;</div><div class="line">       <span class="keyword">try</span> &#123;</div><div class="line">           validateServiceIntent(service);</div><div class="line">           service.prepareToLeaveProcess(<span class="keyword">this</span>);</div><div class="line">           ComponentName cn = ActivityManagerNative.getDefault().startService(</div><div class="line">               mMainThread.getApplicationThread(), service, service.resolveTypeIfNeeded(</div><div class="line">                           getContentResolver()), getOpPackageName(), user.getIdentifier());</div><div class="line">           <span class="keyword">if</span> (cn != <span class="keyword">null</span>) &#123;</div><div class="line">               <span class="keyword">if</span> (cn.getPackageName().equals(<span class="string">"!"</span>)) &#123;</div><div class="line">                   <span class="keyword">throw</span> <span class="keyword">new</span> SecurityException(</div><div class="line">                           <span class="string">"Not allowed to start service "</span> + service</div><div class="line">                           + <span class="string">" without permission "</span> + cn.getClassName());</div><div class="line">               &#125; <span class="keyword">else</span> <span class="keyword">if</span> (cn.getPackageName().equals(<span class="string">"!!"</span>)) &#123;</div><div class="line">                   <span class="keyword">throw</span> <span class="keyword">new</span> SecurityException(</div><div class="line">                           <span class="string">"Unable to start service "</span> + service</div><div class="line">                           + <span class="string">": "</span> + cn.getClassName());</div><div class="line">               &#125;</div><div class="line">           &#125;</div><div class="line">           <span class="keyword">return</span> cn;</div><div class="line">       &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</div><div class="line">           <span class="keyword">throw</span> e.rethrowFromSystemServer();</div><div class="line">       &#125;</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<p> 上述代码中，调用 ActivityManagerNative.getDefault().startService() 方法，通过我们分析 Activity 的启动过程，我们对它很熟悉，下面在 AMS 中看下 startService() 方法，如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">final</span> ActiveServices mServices;</div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> ComponentName <span class="title">startService</span><span class="params">(IApplicationThread caller, Intent service,</span></span></div><div class="line">        String resolvedType, String callingPackage, <span class="keyword">int</span> userId)</div><div class="line">        <span class="keyword">throws</span> TransactionTooLargeException &#123;</div><div class="line">    enforceNotIsolatedCaller(<span class="string">"startService"</span>);</div><div class="line">    <span class="comment">// Refuse possible leaked file descriptors</span></div><div class="line">    <span class="keyword">if</span> (service != <span class="keyword">null</span> &amp;&amp; service.hasFileDescriptors() == <span class="keyword">true</span>) &#123;</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"File descriptors passed in Intent"</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (callingPackage == <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"callingPackage cannot be null"</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (DEBUG_SERVICE) Slog.v(TAG_SERVICE,</div><div class="line">            <span class="string">"startService: "</span> + service + <span class="string">" type="</span> + resolvedType);</div><div class="line">    <span class="keyword">synchronized</span>(<span class="keyword">this</span>) &#123;</div><div class="line">        <span class="keyword">final</span> <span class="keyword">int</span> callingPid = Binder.getCallingPid();</div><div class="line">        <span class="keyword">final</span> <span class="keyword">int</span> callingUid = Binder.getCallingUid();</div><div class="line">        <span class="keyword">final</span> <span class="keyword">long</span> origId = Binder.clearCallingIdentity();</div><div class="line">        ComponentName res = mServices.startServiceLocked(caller, service,</div><div class="line">                resolvedType, callingPid, callingUid, callingPackage, userId);</div><div class="line">        Binder.restoreCallingIdentity(origId);</div><div class="line">        <span class="keyword">return</span> res;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ActiveServices 是一个辅助 AMS 进行 Service 管理的类，包括 Service 的启动、绑定和停止等，在其 startServiceLocked() 方法中，调用 startServiceInnerLocked() 方法，如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line"><span class="function">ComponentName <span class="title">startServiceInnerLocked</span><span class="params">(ServiceMap smap, Intent service, ServiceRecord r,</span></span></div><div class="line">            <span class="keyword">boolean</span> callerFg, <span class="keyword">boolean</span> addToStarting) <span class="keyword">throws</span> TransactionTooLargeException &#123;</div><div class="line">        ServiceState stracker = r.getTracker();</div><div class="line">        <span class="keyword">if</span> (stracker != <span class="keyword">null</span>) &#123;</div><div class="line">            stracker.setStarted(<span class="keyword">true</span>, mAm.mProcessStats.getMemFactorLocked(), r.lastActivity);</div><div class="line">        &#125;</div><div class="line">        r.callStart = <span class="keyword">false</span>;</div><div class="line">        <span class="keyword">synchronized</span> (r.stats.getBatteryStats()) &#123;</div><div class="line">            r.stats.startRunningLocked();</div><div class="line">        &#125;</div><div class="line">        String error = bringUpServiceLocked(r, service.getFlags(), callerFg, <span class="keyword">false</span>, <span class="keyword">false</span>);</div><div class="line">        <span class="keyword">if</span> (error != <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">new</span> ComponentName(<span class="string">"!!"</span>, error);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (r.startRequested &amp;&amp; addToStarting) &#123;</div><div class="line">            <span class="keyword">boolean</span> first = smap.mStartingBackground.size() == <span class="number">0</span>;</div><div class="line">            smap.mStartingBackground.add(r);</div><div class="line">            r.startingBgTimeout = SystemClock.uptimeMillis() + BG_START_TIMEOUT;</div><div class="line">            <span class="keyword">if</span> (DEBUG_DELAYED_SERVICE) &#123;</div><div class="line">                RuntimeException here = <span class="keyword">new</span> RuntimeException(<span class="string">"here"</span>);</div><div class="line">                here.fillInStackTrace();</div><div class="line">                Slog.v(TAG_SERVICE, <span class="string">"Starting background (first="</span> + first + <span class="string">"): "</span> + r, here);</div><div class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (DEBUG_DELAYED_STARTS) &#123;</div><div class="line">                Slog.v(TAG_SERVICE, <span class="string">"Starting background (first="</span> + first + <span class="string">"): "</span> + r);</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">if</span> (first) &#123;</div><div class="line">                smap.rescheduleDelayedStarts();</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (callerFg) &#123;</div><div class="line">            smap.ensureNotStartingBackground(r);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">return</span> r.name;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>在上述代码中，ServiceRecord 描述的是一个 Service 的记录，startServiceInnerLocked() 方法并没有完成具体的工作，而是把任务交给了 bringUpServiceLocked()  方法，在这个方法中，又调用了 realStartServiceLocked() 方法，这是真正启动 Service 的方法，如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">realStartServiceLocked</span><span class="params">(ServiceRecord r,</span></span></div><div class="line">            ProcessRecord app, <span class="keyword">boolean</span> execInFg) <span class="keyword">throws</span> RemoteException &#123;</div><div class="line">        <span class="keyword">if</span> (app.thread == <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RemoteException();</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (DEBUG_MU)</div><div class="line">            Slog.v(TAG_MU, <span class="string">"realStartServiceLocked, ServiceRecord.uid = "</span> + r.appInfo.uid</div><div class="line">                    + <span class="string">", ProcessRecord.uid = "</span> + app.uid);</div><div class="line">        r.app = app;</div><div class="line">        r.restartTime = r.lastActivity = SystemClock.uptimeMillis();</div><div class="line"></div><div class="line">        <span class="keyword">final</span> <span class="keyword">boolean</span> newService = app.services.add(r);</div><div class="line">        bumpServiceExecutingLocked(r, execInFg, <span class="string">"create"</span>);</div><div class="line">        mAm.updateLruProcessLocked(app, <span class="keyword">false</span>, <span class="keyword">null</span>);</div><div class="line">        mAm.updateOomAdjLocked();</div><div class="line"></div><div class="line">        <span class="keyword">boolean</span> created = <span class="keyword">false</span>;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            <span class="keyword">if</span> (LOG_SERVICE_START_STOP) &#123;</div><div class="line">                String nameTerm;</div><div class="line">                <span class="keyword">int</span> lastPeriod = r.shortName.lastIndexOf(<span class="string">'.'</span>);</div><div class="line">                nameTerm = lastPeriod &gt;= <span class="number">0</span> ? r.shortName.substring(lastPeriod) : r.shortName;</div><div class="line">                EventLogTags.writeAmCreateService(</div><div class="line">                        r.userId, System.identityHashCode(r), nameTerm, r.app.uid, r.app.pid);</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">synchronized</span> (r.stats.getBatteryStats()) &#123;</div><div class="line">                r.stats.startLaunchedLocked();</div><div class="line">            &#125;</div><div class="line">            mAm.notifyPackageUse(r.serviceInfo.packageName,</div><div class="line">                                 PackageManager.NOTIFY_PACKAGE_USE_SERVICE);</div><div class="line">            app.forceProcessStateUpTo(ActivityManager.PROCESS_STATE_SERVICE);</div><div class="line">            <span class="comment">// 关键代码点</span></div><div class="line">            app.thread.scheduleCreateService(r, r.serviceInfo,</div><div class="line">                    mAm.compatibilityInfoForPackageLocked(r.serviceInfo.applicationInfo),</div><div class="line">                    app.repProcState);</div><div class="line">            r.postNotification();</div><div class="line">            created = <span class="keyword">true</span>;</div><div class="line">        &#125; <span class="keyword">catch</span> (DeadObjectException e) &#123;</div><div class="line">            Slog.w(TAG, <span class="string">"Application dead when creating service "</span> + r);</div><div class="line">            mAm.appDiedLocked(app);</div><div class="line">            <span class="keyword">throw</span> e;</div><div class="line">        &#125; <span class="keyword">finally</span> &#123;</div><div class="line">            <span class="keyword">if</span> (!created) &#123;</div><div class="line">                <span class="comment">// Keep the executeNesting count accurate.</span></div><div class="line">                <span class="keyword">final</span> <span class="keyword">boolean</span> inDestroying = mDestroyingServices.contains(r);</div><div class="line">                serviceDoneExecutingLocked(r, inDestroying, inDestroying);</div><div class="line"></div><div class="line">                <span class="comment">// Cleanup.</span></div><div class="line">                <span class="keyword">if</span> (newService) &#123;</div><div class="line">                    app.services.remove(r);</div><div class="line">                    r.app = <span class="keyword">null</span>;</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                <span class="comment">// Retry.</span></div><div class="line">                <span class="keyword">if</span> (!inDestroying) &#123;</div><div class="line">                    scheduleServiceRestartLocked(r, <span class="keyword">false</span>);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (r.whitelistManager) &#123;</div><div class="line">            app.whitelistManager = <span class="keyword">true</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        requestServiceBindingsLocked(r, execInFg);</div><div class="line"></div><div class="line">        updateServiceClientActivitiesLocked(app, <span class="keyword">null</span>, <span class="keyword">true</span>);</div><div class="line"></div><div class="line">        <span class="comment">// If the service is in the started state, and there are no</span></div><div class="line">        <span class="comment">// pending arguments, then fake up one so its onStartCommand() will</span></div><div class="line">        <span class="comment">// be called.</span></div><div class="line">        <span class="keyword">if</span> (r.startRequested &amp;&amp; r.callStart &amp;&amp; r.pendingStarts.size() == <span class="number">0</span>) &#123;</div><div class="line">            r.pendingStarts.add(<span class="keyword">new</span> ServiceRecord.StartItem(r, <span class="keyword">false</span>, r.makeNextStartId(),</div><div class="line">                    <span class="keyword">null</span>, <span class="keyword">null</span>));</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        sendServiceArgsLocked(r, execInFg, <span class="keyword">true</span>);</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (r.delayed) &#123;</div><div class="line">            <span class="keyword">if</span> (DEBUG_DELAYED_STARTS) Slog.v(TAG_SERVICE, <span class="string">"REM FR DELAY LIST (new proc): "</span> + r);</div><div class="line">            getServiceMap(r.userId).mDelayedStartList.remove(r);</div><div class="line">            r.delayed = <span class="keyword">false</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (r.delayedStop) &#123;</div><div class="line">            <span class="comment">// Oh and hey we've already been asked to stop!</span></div><div class="line">            r.delayedStop = <span class="keyword">false</span>;</div><div class="line">            <span class="keyword">if</span> (r.startRequested) &#123;</div><div class="line">                <span class="keyword">if</span> (DEBUG_DELAYED_STARTS) Slog.v(TAG_SERVICE,</div><div class="line">                        <span class="string">"Applying delayed stop (from start): "</span> + r);</div><div class="line">                stopServiceLocked(r);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>在上述方法中，通过调用 app.thread.scheduleCreateService() 方法来创建 Service 对象并调用其 onCreate() 方法，接着通过调用 sendServiceArgsLocked() 方法来调用其他生命周期的方法，app.thread 我们已经很熟悉啦，就是 ApplicationThread.因此我们需要去查看其 scheduleCreateService() 方法，如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">scheduleCreateService</span><span class="params">(IBinder token,</span></span></div><div class="line">            ServiceInfo info, CompatibilityInfo compatInfo, <span class="keyword">int</span> processState) &#123;</div><div class="line">        updateProcessState(processState, <span class="keyword">false</span>);</div><div class="line">        CreateServiceData s = <span class="keyword">new</span> CreateServiceData();</div><div class="line">        s.token = token;</div><div class="line">        s.info = info;</div><div class="line">        s.compatInfo = compatInfo;</div><div class="line"></div><div class="line">        sendMessage(H.CREATE_SERVICE, s);</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>很明显，通过发送消息给 H 来完成启动 Service 的任务，跟 Activity 的启动方式很相似，H 会接收这个 CREATE_SERVICE 消息并通过 ActivityThread 的 handleCreateService() 方法来完成 Service 的最终启动。handleCreateService() 方法如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div></pre></td><td class="code"><pre><div class="line">    <span class="keyword">case</span> CREATE_SERVICE:</div><div class="line">                    Trace.traceBegin(Trace.TRACE_TAG_ACTIVITY_MANAGER, (<span class="string">"serviceCreate: "</span> + String.valueOf(msg.obj)));</div><div class="line">                    handleCreateService((CreateServiceData)msg.obj);</div><div class="line">                    Trace.traceEnd(Trace.TRACE_TAG_ACTIVITY_MANAGER);</div><div class="line">                    <span class="keyword">break</span>;</div><div class="line">                    </div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">handleCreateService</span><span class="params">(CreateServiceData data)</span> </span>&#123;</div><div class="line">        <span class="comment">// If we are getting ready to gc after going to the background, well</span></div><div class="line">        <span class="comment">// we are back active so skip it.</span></div><div class="line">        unscheduleGcIdler();</div><div class="line"></div><div class="line">        LoadedApk packageInfo = getPackageInfoNoCheck(</div><div class="line">                data.info.applicationInfo, data.compatInfo);</div><div class="line">        Service service = <span class="keyword">null</span>;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            java.lang.ClassLoader cl = packageInfo.getClassLoader();</div><div class="line">            service = (Service) cl.loadClass(data.info.name).newInstance();</div><div class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">            <span class="keyword">if</span> (!mInstrumentation.onException(service, e)) &#123;</div><div class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(</div><div class="line">                    <span class="string">"Unable to instantiate service "</span> + data.info.name</div><div class="line">                    + <span class="string">": "</span> + e.toString(), e);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            <span class="keyword">if</span> (localLOGV) Slog.v(TAG, <span class="string">"Creating service "</span> + data.info.name);</div><div class="line"></div><div class="line">            ContextImpl context = ContextImpl.createAppContext(<span class="keyword">this</span>, packageInfo);</div><div class="line">            context.setOuterContext(service);</div><div class="line"></div><div class="line">            Application app = packageInfo.makeApplication(<span class="keyword">false</span>, mInstrumentation);</div><div class="line">            service.attach(context, <span class="keyword">this</span>, data.info.name, data.token, app,</div><div class="line">                    ActivityManagerNative.getDefault());</div><div class="line">            service.onCreate();</div><div class="line">            mServices.put(data.token, service);</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                ActivityManagerNative.getDefault().serviceDoneExecuting(</div><div class="line">                        data.token, SERVICE_DONE_EXECUTING_ANON, <span class="number">0</span>, <span class="number">0</span>);</div><div class="line">            &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</div><div class="line">                <span class="keyword">throw</span> e.rethrowFromSystemServer();</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">            <span class="keyword">if</span> (!mInstrumentation.onException(service, e)) &#123;</div><div class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(</div><div class="line">                    <span class="string">"Unable to create service "</span> + data.info.name</div><div class="line">                    + <span class="string">": "</span> + e.toString(), e);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;  </div><div class="line"><span class="keyword">final</span> ArrayMap&lt;IBinder, Service&gt; mServices = <span class="keyword">new</span> ArrayMap&lt;&gt;();</div></pre></td></tr></table></figure>
<p>handleCreateService() 方法主要万臣了如下几件事：</p>
<ul>
<li>通过类加载器创建 Service实例</li>
<li>创建 Application 实例并调用其 onCreate() 方法；</li>
<li>创建 ContextImpl 对象并通过 Service 的 attach() 方法建立二者之间的联系。</li>
<li>调用 Service 的 onCreate() 方法将 Service 对象存储到 一个列表中。</li>
</ul>
<p>ActivityThread 通过handleServiceArgs() 方法调用 Service 的 onStartCommand() 方法，如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">handleServiceArgs</span><span class="params">(ServiceArgsData data)</span> </span>&#123;</div><div class="line">        Service s = mServices.get(data.token);</div><div class="line">        <span class="keyword">if</span> (s != <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                <span class="keyword">if</span> (data.args != <span class="keyword">null</span>) &#123;</div><div class="line">                    data.args.setExtrasClassLoader(s.getClassLoader());</div><div class="line">                    data.args.prepareToEnterProcess();</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">int</span> res;</div><div class="line">                <span class="keyword">if</span> (!data.taskRemoved) &#123;</div><div class="line">                    res = s.onStartCommand(data.args, data.flags, data.startId);</div><div class="line">                &#125; <span class="keyword">else</span> &#123;</div><div class="line">                    s.onTaskRemoved(data.args);</div><div class="line">                    res = Service.START_TASK_REMOVED_COMPLETE;</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                QueuedWork.waitToFinish();</div><div class="line"></div><div class="line">                <span class="keyword">try</span> &#123;</div><div class="line">                    ActivityManagerNative.getDefault().serviceDoneExecuting(</div><div class="line">                            data.token, SERVICE_DONE_EXECUTING_START, data.startId, res);</div><div class="line">                &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</div><div class="line">                    <span class="keyword">throw</span> e.rethrowFromSystemServer();</div><div class="line">                &#125;</div><div class="line">                ensureJitEnabled();</div><div class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">                <span class="keyword">if</span> (!mInstrumentation.onException(s, e)) &#123;</div><div class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(</div><div class="line">                            <span class="string">"Unable to start service "</span> + s</div><div class="line">                            + <span class="string">" with "</span> + data.args + <span class="string">": "</span> + e.toString(), e);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>到此为止，启动 Service 的过程就已经结束。</p>
<h4 id="Service-的绑定过程"><a href="#Service-的绑定过程" class="headerlink" title="Service 的绑定过程"></a>Service 的绑定过程</h4><p>从 ContextWrapper 开始执行 BindService，代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">bindService</span><span class="params">(Intent service, ServiceConnection conn,</span></span></div><div class="line">           <span class="keyword">int</span> flags) &#123;</div><div class="line">       <span class="keyword">return</span> mBase.bindService(service, conn, flags);</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<p>mBase 是 ContextImpl 的对象，接着调用 bindServiceCommon() 方法，如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">bindServiceCommon</span><span class="params">(Intent service, ServiceConnection conn, <span class="keyword">int</span> flags, Handler</span></span></div><div class="line">            handler, UserHandle user) &#123;</div><div class="line">        IServiceConnection sd;</div><div class="line">        <span class="keyword">if</span> (conn == <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"connection is null"</span>);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (mPackageInfo != <span class="keyword">null</span>) &#123;</div><div class="line">            sd = mPackageInfo.getServiceDispatcher(conn, getOuterContext(), handler, flags);</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"Not supported in system context"</span>);</div><div class="line">        &#125;</div><div class="line">        validateServiceIntent(service);</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            IBinder token = getActivityToken();</div><div class="line">            <span class="keyword">if</span> (token == <span class="keyword">null</span> &amp;&amp; (flags&amp;BIND_AUTO_CREATE) == <span class="number">0</span> &amp;&amp; mPackageInfo != <span class="keyword">null</span></div><div class="line">                    &amp;&amp; mPackageInfo.getApplicationInfo().targetSdkVersion</div><div class="line">                    &lt; android.os.Build.VERSION_CODES.ICE_CREAM_SANDWICH) &#123;</div><div class="line">                flags |= BIND_WAIVE_PRIORITY;</div><div class="line">            &#125;</div><div class="line">            service.prepareToLeaveProcess(<span class="keyword">this</span>);</div><div class="line">            <span class="comment">//</span></div><div class="line">            <span class="keyword">int</span> res = ActivityManagerNative.getDefault().bindService(</div><div class="line">                mMainThread.getApplicationThread(), getActivityToken(), service,</div><div class="line">                service.resolveTypeIfNeeded(getContentResolver()),</div><div class="line">                sd, flags, getOpPackageName(), user.getIdentifier());</div><div class="line">            <span class="keyword">if</span> (res &lt; <span class="number">0</span>) &#123;</div><div class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> SecurityException(</div><div class="line">                        <span class="string">"Not allowed to bind to service "</span> + service);</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">return</span> res != <span class="number">0</span>;</div><div class="line">        &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</div><div class="line">            <span class="keyword">throw</span> e.rethrowFromSystemServer();</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>在上述方法中，首先将 ServiceConnection 对象转化成 ServiceDispatcher.InnerConnection 对象， ServiceDispatcher 起着连接 ServiceConnection 和 InnerConnection 的作用，这个过程是由 LoadedApk 的 getServiceDispatcher 方法来完成的，如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line">   <span class="keyword">private</span> <span class="keyword">final</span> ArrayMap&lt;Context, ArrayMap&lt;ServiceConnection, LoadedApk.ServiceDispatcher&gt;&gt; mServices</div><div class="line">    = <span class="keyword">new</span> ArrayMap&lt;Context, ArrayMap&lt;ServiceConnection, LoadedApk.ServiceDispatcher&gt;&gt;();</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> IServiceConnection <span class="title">getServiceDispatcher</span><span class="params">(ServiceConnection c,</span></span></div><div class="line">        Context context, Handler handler, <span class="keyword">int</span> flags) &#123;</div><div class="line">    <span class="keyword">synchronized</span> (mServices) &#123;</div><div class="line">        LoadedApk.ServiceDispatcher sd = <span class="keyword">null</span>;</div><div class="line">        ArrayMap&lt;ServiceConnection, LoadedApk.ServiceDispatcher&gt; map = mServices.get(context);</div><div class="line">        <span class="keyword">if</span> (map != <span class="keyword">null</span>) &#123;</div><div class="line">            sd = map.get(c);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (sd == <span class="keyword">null</span>) &#123;</div><div class="line">            sd = <span class="keyword">new</span> ServiceDispatcher(c, context, handler, flags);</div><div class="line">            <span class="keyword">if</span> (map == <span class="keyword">null</span>) &#123;</div><div class="line">                map = <span class="keyword">new</span> ArrayMap&lt;ServiceConnection, LoadedApk.ServiceDispatcher&gt;();</div><div class="line">                mServices.put(context, map);</div><div class="line">            &#125;</div><div class="line">            map.put(c, sd);</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            sd.validate(context, handler);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> sd.getIServiceConnection();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>mService 存储了一个应用当前活动的 ServiceConnection 和 ServiceDispatcher 的映射关系，系统首先会查找是否存在相同的 ServiceConnection，如果不存在就重新创建一个 ServiceDispatcher 对象并将其存储在 mService 中，key 是ServiceConnection，value 是 ServiceDispatcher，在 ServiceDispatcher 的内部又保存了 ServiceConnection 和 InnerConnection 对象，当 Service 和客户端建立连接后，系统会通过 InnerConnection 来调用 ServiceConnection 中的 onServiceConnected() 方法，这个过程有可能是跨进程的，当 ServiceDispatcher 创建好了之后，getServiceDispatcher 会返回其保存的 InnerConnection 对象。</p>
<p>在 bindServiceCommon() 方法中通过 AMS 来完成 Service  的绑定过程，如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">bindService</span><span class="params">(IApplicationThread caller, IBinder token, Intent service,</span></span></div><div class="line">        String resolvedType, IServiceConnection connection, <span class="keyword">int</span> flags, String callingPackage,</div><div class="line">        <span class="keyword">int</span> userId) <span class="keyword">throws</span> TransactionTooLargeException &#123;</div><div class="line">    enforceNotIsolatedCaller(<span class="string">"bindService"</span>);</div><div class="line"></div><div class="line">    <span class="comment">// Refuse possible leaked file descriptors</span></div><div class="line">    <span class="keyword">if</span> (service != <span class="keyword">null</span> &amp;&amp; service.hasFileDescriptors() == <span class="keyword">true</span>) &#123;</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"File descriptors passed in Intent"</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (callingPackage == <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"callingPackage cannot be null"</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">synchronized</span>(<span class="keyword">this</span>) &#123;</div><div class="line">        <span class="keyword">return</span> mServices.bindServiceLocked(caller, token, service,</div><div class="line">                resolvedType, connection, flags, callingPackage, userId);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>在上述方法中，调用 bindServiceLocked() 方法，接着在调用 bringUpServiceLocked() 方法，再调用 realStartServiceLocked() 方法，最终都是通过 ApplicationThread 来完成 Service 实例的创建并执行其 onCreate() 方法。</p>
<p>Service 的绑定过程会调用 app.thread 的 scheduleBindService 方法，这个过程的实现在 ActiveServices 的 requestServiceBindingLocked() 方法中，如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">requestServiceBindingLocked</span><span class="params">(ServiceRecord r, IntentBindRecord i,</span></span></div><div class="line">        <span class="keyword">boolean</span> execInFg, <span class="keyword">boolean</span> rebind) <span class="keyword">throws</span> TransactionTooLargeException &#123;</div><div class="line">    <span class="keyword">if</span> (r.app == <span class="keyword">null</span> || r.app.thread == <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="comment">// If service is not currently running, can't yet bind.</span></div><div class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> ((!i.requested || rebind) &amp;&amp; i.apps.size() &gt; <span class="number">0</span>) &#123;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            bumpServiceExecutingLocked(r, execInFg, <span class="string">"bind"</span>);</div><div class="line">            r.app.forceProcessStateUpTo(ActivityManager.PROCESS_STATE_SERVICE);</div><div class="line">            r.app.thread.scheduleBindService(r, i.intent.getIntent(), rebind,</div><div class="line">                    r.app.repProcState);</div><div class="line">            <span class="keyword">if</span> (!rebind) &#123;</div><div class="line">                i.requested = <span class="keyword">true</span>;</div><div class="line">            &#125;</div><div class="line">            i.hasBound = <span class="keyword">true</span>;</div><div class="line">            i.doRebind = <span class="keyword">false</span>;</div><div class="line">        &#125; <span class="keyword">catch</span> (TransactionTooLargeException e) &#123;</div><div class="line">            <span class="comment">// Keep the executeNesting count accurate.</span></div><div class="line">            <span class="keyword">if</span> (DEBUG_SERVICE) Slog.v(TAG_SERVICE, <span class="string">"Crashed while binding "</span> + r, e);</div><div class="line">            <span class="keyword">final</span> <span class="keyword">boolean</span> inDestroying = mDestroyingServices.contains(r);</div><div class="line">            serviceDoneExecutingLocked(r, inDestroying, inDestroying);</div><div class="line">            <span class="keyword">throw</span> e;</div><div class="line">        &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</div><div class="line">            <span class="keyword">if</span> (DEBUG_SERVICE) Slog.v(TAG_SERVICE, <span class="string">"Crashed while binding "</span> + r);</div><div class="line">            <span class="comment">// Keep the executeNesting count accurate.</span></div><div class="line">            <span class="keyword">final</span> <span class="keyword">boolean</span> inDestroying = mDestroyingServices.contains(r);</div><div class="line">            serviceDoneExecutingLocked(r, inDestroying, inDestroying);</div><div class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">&#125;</div><div class="line"><span class="comment">// H extends Handler 在 ActivityThread 的内部</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">scheduleBindService</span><span class="params">(IBinder token, Intent intent,</span></span></div><div class="line">            <span class="keyword">boolean</span> rebind, <span class="keyword">int</span> processState) &#123;</div><div class="line">        updateProcessState(processState, <span class="keyword">false</span>);</div><div class="line">        BindServiceData s = <span class="keyword">new</span> BindServiceData();</div><div class="line">        s.token = token;</div><div class="line">        s.intent = intent;</div><div class="line">        s.rebind = rebind;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (DEBUG_SERVICE)</div><div class="line">            Slog.v(TAG, <span class="string">"scheduleBindService token="</span> + token + <span class="string">" intent="</span> + intent + <span class="string">" uid="</span></div><div class="line">                    + Binder.getCallingUid() + <span class="string">" pid="</span> + Binder.getCallingPid());</div><div class="line">        sendMessage(H.BIND_SERVICE, s);</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>这个过程我们太熟悉啦，在 ActivityThread 的 handleBindService() 方法中，如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">handleBindService</span><span class="params">(BindServiceData data)</span> </span>&#123;</div><div class="line">    Service s = mServices.get(data.token);</div><div class="line">    <span class="keyword">if</span> (DEBUG_SERVICE)</div><div class="line">        Slog.v(TAG, <span class="string">"handleBindService s="</span> + s + <span class="string">" rebind="</span> + data.rebind);</div><div class="line">    <span class="keyword">if</span> (s != <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            data.intent.setExtrasClassLoader(s.getClassLoader());</div><div class="line">            data.intent.prepareToEnterProcess();</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                <span class="keyword">if</span> (!data.rebind) &#123;</div><div class="line">                    IBinder binder = s.onBind(data.intent);</div><div class="line">                    ActivityManagerNative.getDefault().publishService(</div><div class="line">                            data.token, data.intent, binder);</div><div class="line">                &#125; <span class="keyword">else</span> &#123;</div><div class="line">                    s.onRebind(data.intent);</div><div class="line">                    ActivityManagerNative.getDefault().serviceDoneExecuting(</div><div class="line">                            data.token, SERVICE_DONE_EXECUTING_ANON, <span class="number">0</span>, <span class="number">0</span>);</div><div class="line">                &#125;</div><div class="line">                ensureJitEnabled();</div><div class="line">            &#125; <span class="keyword">catch</span> (RemoteException ex) &#123;</div><div class="line">                <span class="keyword">throw</span> ex.rethrowFromSystemServer();</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">            <span class="keyword">if</span> (!mInstrumentation.onException(s, e)) &#123;</div><div class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(</div><div class="line">                        <span class="string">"Unable to bind to service "</span> + s</div><div class="line">                        + <span class="string">" with "</span> + data.intent + <span class="string">": "</span> + e.toString(), e);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>首先根据 Service 的token 取出 Service 对象，在调用 onBind() 方法，在 Service 的方法中会返回一个 Binder 对象给客户端使用，此时 Service 已经处于绑定状态。接下来由 ActivityManagerNative.getDefault().publishService() 方法来通知客户端，我们继续看 AMS 的 publishService() 方法，如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">publishService</span><span class="params">(IBinder token, Intent intent, IBinder service)</span> </span>&#123;</div><div class="line">        <span class="comment">// Refuse possible leaked file descriptors</span></div><div class="line">        <span class="keyword">if</span> (intent != <span class="keyword">null</span> &amp;&amp; intent.hasFileDescriptors() == <span class="keyword">true</span>) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"File descriptors passed in Intent"</span>);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">synchronized</span>(<span class="keyword">this</span>) &#123;</div><div class="line">            <span class="keyword">if</span> (!(token <span class="keyword">instanceof</span> ServiceRecord)) &#123;</div><div class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Invalid service token"</span>);</div><div class="line">            &#125;</div><div class="line">            mServices.publishServiceLocked((ServiceRecord)token, intent, service);</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>mService 是 ActiveService 对象，publishServiceLocked() 方法的代码如下，</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">publishServiceLocked</span><span class="params">(ServiceRecord r, Intent intent, IBinder service)</span> </span>&#123;</div><div class="line">        <span class="keyword">final</span> <span class="keyword">long</span> origId = Binder.clearCallingIdentity();</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            <span class="keyword">if</span> (DEBUG_SERVICE) Slog.v(TAG_SERVICE, <span class="string">"PUBLISHING "</span> + r</div><div class="line">                    + <span class="string">" "</span> + intent + <span class="string">": "</span> + service);</div><div class="line">            <span class="keyword">if</span> (r != <span class="keyword">null</span>) &#123;</div><div class="line">                Intent.FilterComparison filter</div><div class="line">                        = <span class="keyword">new</span> Intent.FilterComparison(intent);</div><div class="line">                IntentBindRecord b = r.bindings.get(filter);</div><div class="line">                <span class="keyword">if</span> (b != <span class="keyword">null</span> &amp;&amp; !b.received) &#123;</div><div class="line">                    b.binder = service;</div><div class="line">                    b.requested = <span class="keyword">true</span>;</div><div class="line">                    b.received = <span class="keyword">true</span>;</div><div class="line">                    <span class="keyword">for</span> (<span class="keyword">int</span> conni=r.connections.size()-<span class="number">1</span>; conni&gt;=<span class="number">0</span>; conni--) &#123;</div><div class="line">                        ArrayList&lt;ConnectionRecord&gt; clist = r.connections.valueAt(conni);</div><div class="line">                        <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;clist.size(); i++) &#123;</div><div class="line">                            ConnectionRecord c = clist.get(i);</div><div class="line">                            <span class="keyword">if</span> (!filter.equals(c.binding.intent.intent)) &#123;</div><div class="line">                                <span class="keyword">if</span> (DEBUG_SERVICE) Slog.v(</div><div class="line">                                        TAG_SERVICE, <span class="string">"Not publishing to: "</span> + c);</div><div class="line">                                <span class="keyword">if</span> (DEBUG_SERVICE) Slog.v(</div><div class="line">                                        TAG_SERVICE, <span class="string">"Bound intent: "</span> + c.binding.intent.intent);</div><div class="line">                                <span class="keyword">if</span> (DEBUG_SERVICE) Slog.v(</div><div class="line">                                        TAG_SERVICE, <span class="string">"Published intent: "</span> + intent);</div><div class="line">                                <span class="keyword">continue</span>;</div><div class="line">                            &#125;</div><div class="line">                            <span class="keyword">if</span> (DEBUG_SERVICE) Slog.v(TAG_SERVICE, <span class="string">"Publishing to: "</span> + c);</div><div class="line">                            <span class="keyword">try</span> &#123;</div><div class="line">                            <span class="comment">//核心代码</span></div><div class="line">                                c.conn.connected(r.name, service);</div><div class="line">                            &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">                                Slog.w(TAG, <span class="string">"Failure sending service "</span> + r.name +</div><div class="line">                                      <span class="string">" to connection "</span> + c.conn.asBinder() +</div><div class="line">                                      <span class="string">" (in "</span> + c.binding.client.processName + <span class="string">")"</span>, e);</div><div class="line">                            &#125;</div><div class="line">                        &#125;</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                serviceDoneExecutingLocked(r, mDestroyingServices.contains(r), <span class="keyword">false</span>);</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">finally</span> &#123;</div><div class="line">            Binder.restoreCallingIdentity(origId);</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>最关键的一句话：c.conn.connected(r.name,service);其中 c 的类型是 ConnectionRecord,c.conn 类型是 ServiceDispatcher.InnerConnection，service 是 Service 的 onBind() 方法返回的 Binder 对象。我们先看 ServiceDispatcher.InnerConnection 的定义，ServiceDispather 是 LoadedApk 的内部类,如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">InnerConnection</span> <span class="keyword">extends</span> <span class="title">IServiceConnection</span>.<span class="title">Stub</span> </span>&#123;</div><div class="line">           <span class="keyword">final</span> WeakReference&lt;LoadedApk.ServiceDispatcher&gt; mDispatcher;</div><div class="line"></div><div class="line">           InnerConnection(LoadedApk.ServiceDispatcher sd) &#123;</div><div class="line">               mDispatcher = <span class="keyword">new</span> WeakReference&lt;LoadedApk.ServiceDispatcher&gt;(sd);</div><div class="line">           &#125;</div><div class="line"></div><div class="line">           <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">connected</span><span class="params">(ComponentName name, IBinder service)</span> <span class="keyword">throws</span> RemoteException </span>&#123;</div><div class="line">               LoadedApk.ServiceDispatcher sd = mDispatcher.get();</div><div class="line">               <span class="keyword">if</span> (sd != <span class="keyword">null</span>) &#123;</div><div class="line">                   sd.connected(name, service);</div><div class="line">               &#125;</div><div class="line">           &#125;</div><div class="line">       &#125;</div></pre></td></tr></table></figure>
<p>在它的方法里，又调用了 ServiceDispatcher 的 connected() 方法，如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">connected</span><span class="params">(ComponentName name, IBinder service)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (mActivityThread != <span class="keyword">null</span>) &#123;</div><div class="line">            mActivityThread.post(<span class="keyword">new</span> RunConnection(name, service, <span class="number">0</span>));</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            doConnected(name, service);</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>mActivityThread 是一个 Handler,它就是 ActivityThread 的 H，从 ServiceDispatcher 的创建过程来看，mActivityThread 不会为null，这样 RunConnection() 方法就由 H 的 post 方法从而运行在主线程中，客户端的 ServiceConnection 中的方法在主线程中被回调，如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">RunConnection</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</div><div class="line">            RunConnection(ComponentName name, IBinder service, <span class="keyword">int</span> command) &#123;</div><div class="line">                mName = name;</div><div class="line">                mService = service;</div><div class="line">                mCommand = command;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">                <span class="keyword">if</span> (mCommand == <span class="number">0</span>) &#123;</div><div class="line">                    doConnected(mName, mService);</div><div class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (mCommand == <span class="number">1</span>) &#123;</div><div class="line">                    doDeath(mName, mService);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="keyword">final</span> ComponentName mName;</div><div class="line">            <span class="keyword">final</span> IBinder mService;</div><div class="line">            <span class="keyword">final</span> <span class="keyword">int</span> mCommand;</div><div class="line">        &#125;</div></pre></td></tr></table></figure>
<p>调用了 ServiceDispathcer 的 doConnected() 方法，如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doConnected</span><span class="params">(ComponentName name, IBinder service)</span> </span>&#123;</div><div class="line">            ServiceDispatcher.ConnectionInfo old;</div><div class="line">            ServiceDispatcher.ConnectionInfo info;</div><div class="line"></div><div class="line">            <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</div><div class="line">                <span class="keyword">if</span> (mForgotten) &#123;</div><div class="line">                    <span class="comment">// We unbound before receiving the connection; ignore</span></div><div class="line">                    <span class="comment">// any connection received.</span></div><div class="line">                    <span class="keyword">return</span>;</div><div class="line">                &#125;</div><div class="line">                old = mActiveConnections.get(name);</div><div class="line">                <span class="keyword">if</span> (old != <span class="keyword">null</span> &amp;&amp; old.binder == service) &#123;</div><div class="line">                    <span class="comment">// Huh, already have this one.  Oh well!</span></div><div class="line">                    <span class="keyword">return</span>;</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                <span class="keyword">if</span> (service != <span class="keyword">null</span>) &#123;</div><div class="line">                    <span class="comment">// A new service is being connected... set it all up.</span></div><div class="line">                    info = <span class="keyword">new</span> ConnectionInfo();</div><div class="line">                    info.binder = service;</div><div class="line">                    info.deathMonitor = <span class="keyword">new</span> DeathMonitor(name, service);</div><div class="line">                    <span class="keyword">try</span> &#123;</div><div class="line">                        service.linkToDeath(info.deathMonitor, <span class="number">0</span>);</div><div class="line">                        mActiveConnections.put(name, info);</div><div class="line">                    &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</div><div class="line">                        <span class="comment">// This service was dead before we got it...  just</span></div><div class="line">                        <span class="comment">// don't do anything with it.</span></div><div class="line">                        mActiveConnections.remove(name);</div><div class="line">                        <span class="keyword">return</span>;</div><div class="line">                    &#125;</div><div class="line"></div><div class="line">                &#125; <span class="keyword">else</span> &#123;</div><div class="line">                    <span class="comment">// The named service is being disconnected... clean up.</span></div><div class="line">                    mActiveConnections.remove(name);</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                <span class="keyword">if</span> (old != <span class="keyword">null</span>) &#123;</div><div class="line">                    old.binder.unlinkToDeath(old.deathMonitor, <span class="number">0</span>);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="comment">// If there was an old service, it is now disconnected.</span></div><div class="line">            <span class="keyword">if</span> (old != <span class="keyword">null</span>) &#123;</div><div class="line">                mConnection.onServiceDisconnected(name);</div><div class="line">            &#125;</div><div class="line">            <span class="comment">// If there is a new service, it is now connected.</span></div><div class="line">            <span class="keyword">if</span> (service != <span class="keyword">null</span>) &#123;</div><div class="line">                mConnection.onServiceConnected(name, service);</div><div class="line">            &#125;</div><div class="line">        &#125;</div></pre></td></tr></table></figure>
<p>其中 mConnection 是客户端的ServiceConnection 对象，因此很容易调用 ServiceConnection 对象的 onServiceConnected() 方法。</p>
<p>到此为止，Service 的绑定过程就结束啦，</p>

      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        

      
    </div>

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/Android/" rel="tag"># Android</a>
          
        </div>
      

      
        
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2017/05/01/Android-性能优化典范学习笔记/" rel="next" title="Android 性能优化典范学习笔记">
                <i class="fa fa-chevron-left"></i> Android 性能优化典范学习笔记
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2017/04/29/Activity-的创建和加载源码解析/" rel="prev" title="Activity 的创建和加载源码解析">
                Activity 的创建和加载源码解析 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/uploads/header.jpg"
               alt="喝咖啡的鱼儿" />
          <p class="site-author-name" itemprop="name">喝咖啡的鱼儿</p>
           
              <p class="site-description motion-element" itemprop="description">愿你走出半生，归来仍是少年</p>
          
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives">
                <span class="site-state-item-count">28</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-categories">
              
                <span class="site-state-item-count">6</span>
                <span class="site-state-item-name">分类</span>
              
            </div>
          

          
            
            
            <div class="site-state-item site-state-tags">
              
                <span class="site-state-item-count">7</span>
                <span class="site-state-item-name">标签</span>
              
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        
        

        


      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-4"><a class="nav-link" href="#Service-的启动过程"><span class="nav-number">1.</span> <span class="nav-text">Service 的启动过程</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Service-的绑定过程"><span class="nav-number">2.</span> <span class="nav-text">Service 的绑定过程</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">喝咖啡的鱼儿</span>
</div>


<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Pisces
  </a>
</div>


        

        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  








  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.0"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.0"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.0"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.0"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.0"></script>



  


  




	





  





  





  






  





  

  

  

  

  

</body>
</html>
