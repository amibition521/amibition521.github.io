<!doctype html>




<html class="theme-next pisces" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  
    
      
    

    
  

  

  
    
      
    

    
  

  
    
      
    

    
  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Monda:300,300italic,400,400italic,700,700italic|Roboto Slab:300,300italic,400,400italic,700,700italic|Lobster Two:300,300italic,400,400italic,700,700italic|PT Mono:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.0" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Hexo, NexT" />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.0" />






<meta name="description" content="Volley 的工具类解析 NetworkByteArrayPool原文解释如下： 1234567891011ByteArrayPool is a source and repository of &amp;lt;code&amp;gt;byte[]&amp;lt;/code&amp;gt; objects. Its purpose is to supply those buffers to consumers who need">
<meta name="keywords">
<meta property="og:type" content="article">
<meta property="og:title" content="Volley 相关ToolBox 工具类解析">
<meta property="og:url" content="http://yoursite.com/2017/05/30/Volley-相关ToolBox-工具类解析/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="Volley 的工具类解析 NetworkByteArrayPool原文解释如下： 1234567891011ByteArrayPool is a source and repository of &amp;lt;code&amp;gt;byte[]&amp;lt;/code&amp;gt; objects. Its purpose is to supply those buffers to consumers who need">
<meta property="og:updated_time" content="2017-05-30T14:55:26.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Volley 相关ToolBox 工具类解析">
<meta name="twitter:description" content="Volley 的工具类解析 NetworkByteArrayPool原文解释如下： 1234567891011ByteArrayPool is a source and repository of &amp;lt;code&amp;gt;byte[]&amp;lt;/code&amp;gt; objects. Its purpose is to supply those buffers to consumers who need">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    sidebar: {"position":"left","display":"post","offset":12,"offset_float":0,"b2t":false,"scrollpercent":false},
    fancybox: true,
    motion: false,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/2017/05/30/Volley-相关ToolBox-工具类解析/"/>





  <title> Volley 相关ToolBox 工具类解析 | Hexo </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  














  
  
    
  

  <div class="container sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Hexo</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/05/30/Volley-相关ToolBox-工具类解析/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="喝咖啡的鱼儿">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/uploads/header.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                Volley 相关ToolBox 工具类解析
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-05-30T20:11:15+08:00">
                2017-05-30
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>Volley 的工具类解析</p>
<h3 id="Network"><a href="#Network" class="headerlink" title="Network"></a>Network</h3><h4 id="ByteArrayPool"><a href="#ByteArrayPool" class="headerlink" title="ByteArrayPool"></a>ByteArrayPool</h4><p>原文解释如下：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">ByteArrayPool is a source and repository of &lt;code&gt;byte[]&lt;/code&gt; objects. Its purpose is to supply those buffers to consumers who need to use them for a short period of time and then dispose of them. Simply creating and disposing such buffers in the conventional manner can considerable heap churn and garbage collection delays on Android, which lacks good management of short-lived heap objects. It may be advantageous to trade off some memory in the form of a permanently allocated pool of buffers in order to gain heap performance improvements; that is what this class does.</div><div class="line">   A good candidate user for this class is something like an I/O system that uses large temporary byte[] buffers to copy data around. In these use cases, often the consumer wants the buffer to be a certain minimum size to ensure good performance (e.g. when copying data chunks off of a stream), but doesn't mind if the buffer is larger than the minimum. Taking this into account and also to maximize the odds of being able to reuse a recycled buffer, this class is free to return buffers larger than the requested size. The caller needs to be able to gracefully deal with getting buffers any size over the minimum.</div><div class="line">  If there is not a suitably-sized buffer in its recycling pool when a buffer is requested, this class will allocate a new buffer and return it.</div><div class="line">  This class has no special ownership of buffers it creates; the caller is free to take a buffer it receives from this pool, use it permanently, and never return it to the pool; additionally,it is not harmful to return to this pool a buffer that was allocated elsewhere, provided there are no other lingering references to it.</div><div class="line">  This class ensures that the total size of the buffers in its recycling pool never exceeds a certain byte limit. When a buffer is returned that would cause the pool to exceed the limit,least-recently-used buffers are disposed.</div><div class="line">// Google 翻译如下</div><div class="line">ByteArrayPool是&lt;code&gt; byte [] &lt;/ code&gt;对象的源和存储库。其目的是为那些需要在短时间内使用它们然后处理它们的消费者提供这些缓冲区。以常规方式简单地创建和处理这些缓冲区可能会在Android上产生相当大的堆积和垃圾收集延迟，这对于短期堆栈对象缺乏良好的管理。以永久分配的缓冲池的形式来交换一些存储器可能是有利的，以便获得堆性能改进;这就是这个类的作用。</div><div class="line">   这个类就像一个使用大型临时byte []缓冲区来复制数据的I / O系统。在这些用例中，消费者通常希望缓冲区具有一定的最小尺寸以确保良好的性能（例如，当从数据流复制数据块时），但不介意缓冲区大于最小值。考虑到这一点，并且最大限度地提高了重新使用再循环缓冲区的可能性，该类可以自由地返回大于请求的大小的缓冲区。调用者需要能够优雅地处理任何尺寸的缓冲区。</div><div class="line">  如果在请求缓冲区时，它的回收池中没有适当大小的缓冲区，则此类将分配一个新的缓冲区并返回。</div><div class="line">  这个类对它创建的缓冲区没有特殊的所有权;调用者可以自由地从该池接收缓冲区，永久使用它，并且永远不会将其返回到池中;另外，如果没有其他逗号引用它，则将其分配给其他地方的缓冲区返回到此池是没有害处的。</div><div class="line">  此类确保其回收池中的缓冲区的总大小永远不会超过某个字节限制。当返回的缓冲区将导致池超过限制时，最近最少使用的缓冲区被排除。</div></pre></td></tr></table></figure>
<p>上面已经把 ByteArrayPool 的作用说明白了，下面我们看下代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ByteArrayPool</span> </span>&#123;</div><div class="line">    <span class="comment">/** The buffer pool, arranged both by last use and by buffer size */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> List&lt;<span class="keyword">byte</span>[]&gt; mBuffersByLastUse = <span class="keyword">new</span> LinkedList&lt;<span class="keyword">byte</span>[]&gt;();</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> List&lt;<span class="keyword">byte</span>[]&gt; mBuffersBySize = <span class="keyword">new</span> ArrayList&lt;<span class="keyword">byte</span>[]&gt;(<span class="number">64</span>);</div><div class="line"></div><div class="line">    <span class="comment">/** The total size of the buffers in the pool */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span> mCurrentSize = <span class="number">0</span>;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * The maximum aggregate size of the buffers in the pool. Old buffers are discarded to stay</div><div class="line">     * under this limit.</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> mSizeLimit;</div><div class="line"></div><div class="line">    <span class="comment">/** Compares buffers by size */</span></div><div class="line">    <span class="keyword">protected</span> <span class="keyword">static</span> <span class="keyword">final</span> Comparator&lt;<span class="keyword">byte</span>[]&gt; BUF_COMPARATOR = <span class="keyword">new</span> Comparator&lt;<span class="keyword">byte</span>[]&gt;() &#123;</div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">compare</span><span class="params">(<span class="keyword">byte</span>[] lhs, <span class="keyword">byte</span>[] rhs)</span> </span>&#123;</div><div class="line">            <span class="keyword">return</span> lhs.length - rhs.length;</div><div class="line">        &#125;</div><div class="line">    &#125;;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * <span class="doctag">@param</span> sizeLimit the maximum size of the pool, in bytes</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ByteArrayPool</span><span class="params">(<span class="keyword">int</span> sizeLimit)</span> </span>&#123;</div><div class="line">        mSizeLimit = sizeLimit;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Returns a buffer from the pool if one is available in the requested size, or allocates a    		new one if a pooled one is not available.</div><div class="line">     * <span class="doctag">@param</span> len the minimum size, in bytes, of the requested buffer. The returned buffer may be</div><div class="line">     *        larger.</div><div class="line">     * <span class="doctag">@return</span> a byte[] buffer is always returned.</div><div class="line">     */</div><div class="line">    <span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">byte</span>[] getBuf(<span class="keyword">int</span> len) &#123;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; mBuffersBySize.size(); i++) &#123;</div><div class="line">            <span class="keyword">byte</span>[] buf = mBuffersBySize.get(i);</div><div class="line">            <span class="keyword">if</span> (buf.length &gt;= len) &#123;</div><div class="line">                mCurrentSize -= buf.length;</div><div class="line">                mBuffersBySize.remove(i);</div><div class="line">                mBuffersByLastUse.remove(buf);</div><div class="line">                <span class="keyword">return</span> buf;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="keyword">byte</span>[len];</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Returns a buffer to the pool, throwing away old buffers if the pool would exceed its 		   allotted size.</div><div class="line">     * <span class="doctag">@param</span> buf the buffer to return to the pool.</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">returnBuf</span><span class="params">(<span class="keyword">byte</span>[] buf)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (buf == <span class="keyword">null</span> || buf.length &gt; mSizeLimit) &#123;</div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        &#125;</div><div class="line">        mBuffersByLastUse.add(buf);</div><div class="line">        <span class="keyword">int</span> pos = Collections.binarySearch(mBuffersBySize, buf, BUF_COMPARATOR);</div><div class="line">        <span class="keyword">if</span> (pos &lt; <span class="number">0</span>) &#123;</div><div class="line">            pos = -pos - <span class="number">1</span>;</div><div class="line">        &#125;</div><div class="line">        mBuffersBySize.add(pos, buf);</div><div class="line">        mCurrentSize += buf.length;</div><div class="line">        trim();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Removes buffers from the pool until it is under its size limit.</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">trim</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">while</span> (mCurrentSize &gt; mSizeLimit) &#123;</div><div class="line">            <span class="keyword">byte</span>[] buf = mBuffersByLastUse.remove(<span class="number">0</span>);</div><div class="line">            mBuffersBySize.remove(buf);</div><div class="line">            mCurrentSize -= buf.length;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="BasicNetwork"><a href="#BasicNetwork" class="headerlink" title="BasicNetwork"></a>BasicNetwork</h4><p>网络请求实现类，针对 HttpStack 网络请求做的一层封装，如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div><div class="line">223</div><div class="line">224</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * A network performing Volley requests over an &#123;<span class="doctag">@link</span> HttpStack&#125;.</div><div class="line"> */</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BasicNetwork</span> <span class="keyword">implements</span> <span class="title">Network</span> </span>&#123;</div><div class="line">    <span class="keyword">protected</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">boolean</span> DEBUG = VolleyLog.DEBUG;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> SLOW_REQUEST_THRESHOLD_MS = <span class="number">3000</span>;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> DEFAULT_POOL_SIZE = <span class="number">4096</span>;</div><div class="line"></div><div class="line">    <span class="keyword">protected</span> <span class="keyword">final</span> HttpStack mHttpStack;</div><div class="line"></div><div class="line">    <span class="keyword">protected</span> <span class="keyword">final</span> ByteArrayPool mPool;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * <span class="doctag">@param</span> httpStack HTTP stack to be used</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">BasicNetwork</span><span class="params">(HttpStack httpStack)</span> </span>&#123;</div><div class="line">        <span class="comment">// If a pool isn't passed in, then build a small default pool that will give us a lot of</span></div><div class="line">        <span class="comment">// benefit and not use too much memory.</span></div><div class="line">        <span class="keyword">this</span>(httpStack, <span class="keyword">new</span> ByteArrayPool(DEFAULT_POOL_SIZE));</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * <span class="doctag">@param</span> httpStack HTTP stack to be used</div><div class="line">     * <span class="doctag">@param</span> pool a buffer pool that improves GC performance in copy operations</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">BasicNetwork</span><span class="params">(HttpStack httpStack, ByteArrayPool pool)</span> </span>&#123;</div><div class="line">        mHttpStack = httpStack;</div><div class="line">        mPool = pool;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> NetworkResponse <span class="title">performRequest</span><span class="params">(Request&lt;?&gt; request)</span> <span class="keyword">throws</span> VolleyError </span>&#123;</div><div class="line">        <span class="keyword">long</span> requestStart = SystemClock.elapsedRealtime();</div><div class="line">        <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</div><div class="line">            HttpResponse httpResponse = <span class="keyword">null</span>;</div><div class="line">            <span class="keyword">byte</span>[] responseContents = <span class="keyword">null</span>;</div><div class="line">            Map&lt;String, String&gt; responseHeaders = Collections.emptyMap();</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                <span class="comment">// Gather headers.</span></div><div class="line">                Map&lt;String, String&gt; headers = <span class="keyword">new</span> HashMap&lt;String, String&gt;();</div><div class="line">                addCacheHeaders(headers, request.getCacheEntry());</div><div class="line">                httpResponse = mHttpStack.performRequest(request, headers);</div><div class="line">                StatusLine statusLine = httpResponse.getStatusLine();</div><div class="line">                <span class="keyword">int</span> statusCode = statusLine.getStatusCode();</div><div class="line"></div><div class="line">                responseHeaders = convertHeaders(httpResponse.getAllHeaders());</div><div class="line">                <span class="comment">// Handle cache validation.</span></div><div class="line">                <span class="keyword">if</span> (statusCode == HttpStatus.SC_NOT_MODIFIED) &#123;</div><div class="line"></div><div class="line">                    Entry entry = request.getCacheEntry();</div><div class="line">                    <span class="keyword">if</span> (entry == <span class="keyword">null</span>) &#123;</div><div class="line">                        <span class="keyword">return</span> <span class="keyword">new</span> NetworkResponse(HttpStatus.SC_NOT_MODIFIED, <span class="keyword">null</span>,</div><div class="line">                                responseHeaders, <span class="keyword">true</span>,</div><div class="line">                                SystemClock.elapsedRealtime() - requestStart);</div><div class="line">                    &#125;</div><div class="line"></div><div class="line">                    <span class="comment">// A HTTP 304 response does not have all header fields. We</span></div><div class="line">                    <span class="comment">// have to use the header fields from the cache entry plus</span></div><div class="line">                    <span class="comment">// the new ones from the response.</span></div><div class="line">                    <span class="comment">// http://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.3.5</span></div><div class="line">                    entry.responseHeaders.putAll(responseHeaders);</div><div class="line">                    <span class="keyword">return</span> <span class="keyword">new</span> NetworkResponse(HttpStatus.SC_NOT_MODIFIED, entry.data,</div><div class="line">                            entry.responseHeaders, <span class="keyword">true</span>,</div><div class="line">                            SystemClock.elapsedRealtime() - requestStart);</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                <span class="comment">// Some responses such as 204s do not have content.  We must check.</span></div><div class="line">                <span class="keyword">if</span> (httpResponse.getEntity() != <span class="keyword">null</span>) &#123;</div><div class="line">                  responseContents = entityToBytes(httpResponse.getEntity());</div><div class="line">                &#125; <span class="keyword">else</span> &#123;</div><div class="line">                  <span class="comment">// Add 0 byte response as a way of honestly representing a</span></div><div class="line">                  <span class="comment">// no-content request.</span></div><div class="line">                  responseContents = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">0</span>];</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                <span class="comment">// if the request is slow, log it.</span></div><div class="line">                <span class="keyword">long</span> requestLifetime = SystemClock.elapsedRealtime() - requestStart;</div><div class="line">                logSlowRequests(requestLifetime, request, responseContents, statusLine);</div><div class="line"></div><div class="line">                <span class="keyword">if</span> (statusCode &lt; <span class="number">200</span> || statusCode &gt; <span class="number">299</span>) &#123;</div><div class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> IOException();</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">return</span> <span class="keyword">new</span> NetworkResponse(statusCode, responseContents, responseHeaders, <span class="keyword">false</span>,</div><div class="line">                        SystemClock.elapsedRealtime() - requestStart);</div><div class="line">            &#125; <span class="keyword">catch</span> (SocketTimeoutException e) &#123;</div><div class="line">                attemptRetryOnException(<span class="string">"socket"</span>, request, <span class="keyword">new</span> TimeoutError());</div><div class="line">            &#125; <span class="keyword">catch</span> (ConnectTimeoutException e) &#123;</div><div class="line">                attemptRetryOnException(<span class="string">"connection"</span>, request, <span class="keyword">new</span> TimeoutError());</div><div class="line">            &#125; <span class="keyword">catch</span> (MalformedURLException e) &#123;</div><div class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"Bad URL "</span> + request.getUrl(), e);</div><div class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line">                <span class="keyword">int</span> statusCode;</div><div class="line">                <span class="keyword">if</span> (httpResponse != <span class="keyword">null</span>) &#123;</div><div class="line">                    statusCode = httpResponse.getStatusLine().getStatusCode();</div><div class="line">                &#125; <span class="keyword">else</span> &#123;</div><div class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> NoConnectionError(e);</div><div class="line">                &#125;</div><div class="line">                VolleyLog.e(<span class="string">"Unexpected response code %d for %s"</span>, statusCode, request.getUrl());</div><div class="line">                NetworkResponse networkResponse;</div><div class="line">                <span class="keyword">if</span> (responseContents != <span class="keyword">null</span>) &#123;</div><div class="line">                    networkResponse = <span class="keyword">new</span> NetworkResponse(statusCode, responseContents,</div><div class="line">                            responseHeaders, <span class="keyword">false</span>, SystemClock.elapsedRealtime() - requestStart);</div><div class="line">                    <span class="keyword">if</span> (statusCode == HttpStatus.SC_UNAUTHORIZED ||</div><div class="line">                            statusCode == HttpStatus.SC_FORBIDDEN) &#123;</div><div class="line">                        attemptRetryOnException(<span class="string">"auth"</span>,</div><div class="line">                                request, <span class="keyword">new</span> AuthFailureError(networkResponse));</div><div class="line">                    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (statusCode &gt;= <span class="number">400</span> &amp;&amp; statusCode &lt;= <span class="number">499</span>) &#123;</div><div class="line">                        <span class="comment">// Don't retry other client errors.</span></div><div class="line">                        <span class="keyword">throw</span> <span class="keyword">new</span> ClientError(networkResponse);</div><div class="line">                    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (statusCode &gt;= <span class="number">500</span> &amp;&amp; statusCode &lt;= <span class="number">599</span>) &#123;</div><div class="line">                        <span class="keyword">if</span> (request.shouldRetryServerErrors()) &#123;</div><div class="line">                            attemptRetryOnException(<span class="string">"server"</span>,</div><div class="line">                                    request, <span class="keyword">new</span> ServerError(networkResponse));</div><div class="line">                        &#125; <span class="keyword">else</span> &#123;</div><div class="line">                            <span class="keyword">throw</span> <span class="keyword">new</span> ServerError(networkResponse);</div><div class="line">                        &#125;</div><div class="line">                    &#125; <span class="keyword">else</span> &#123;</div><div class="line">                        <span class="comment">// 3xx? No reason to retry.</span></div><div class="line">                        <span class="keyword">throw</span> <span class="keyword">new</span> ServerError(networkResponse);</div><div class="line">                    &#125;</div><div class="line">                &#125; <span class="keyword">else</span> &#123;</div><div class="line">                    attemptRetryOnException(<span class="string">"network"</span>, request, <span class="keyword">new</span> NetworkError());</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Logs requests that took over SLOW_REQUEST_THRESHOLD_MS to complete.</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">logSlowRequests</span><span class="params">(<span class="keyword">long</span> requestLifetime, Request&lt;?&gt; request,</span></span></div><div class="line">            <span class="keyword">byte</span>[] responseContents, StatusLine statusLine) &#123;</div><div class="line">        <span class="keyword">if</span> (DEBUG || requestLifetime &gt; SLOW_REQUEST_THRESHOLD_MS) &#123;</div><div class="line">            VolleyLog.d(<span class="string">"HTTP response for request=&lt;%s&gt; [lifetime=%d], [size=%s], "</span> +</div><div class="line">                    <span class="string">"[rc=%d], [retryCount=%s]"</span>, request, requestLifetime,</div><div class="line">                    responseContents != <span class="keyword">null</span> ? responseContents.length : <span class="string">"null"</span>,</div><div class="line">                    statusLine.getStatusCode(), request.getRetryPolicy().getCurrentRetryCount());</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Attempts to prepare the request for a retry. If there are no more attempts remaining in the</div><div class="line">     * request's retry policy, a timeout exception is thrown.</div><div class="line">     * <span class="doctag">@param</span> request The request to use.</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">attemptRetryOnException</span><span class="params">(String logPrefix, Request&lt;?&gt; request,</span></span></div><div class="line">            VolleyError exception) <span class="keyword">throws</span> VolleyError &#123;</div><div class="line">        RetryPolicy retryPolicy = request.getRetryPolicy();</div><div class="line">        <span class="keyword">int</span> oldTimeout = request.getTimeoutMs();</div><div class="line"></div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            retryPolicy.retry(exception);</div><div class="line">        &#125; <span class="keyword">catch</span> (VolleyError e) &#123;</div><div class="line">            request.addMarker(</div><div class="line">                    String.format(<span class="string">"%s-timeout-giveup [timeout=%s]"</span>, logPrefix, oldTimeout));</div><div class="line">            <span class="keyword">throw</span> e;</div><div class="line">        &#125;</div><div class="line">        request.addMarker(String.format(<span class="string">"%s-retry [timeout=%s]"</span>, logPrefix, oldTimeout));</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">addCacheHeaders</span><span class="params">(Map&lt;String, String&gt; headers, Cache.Entry entry)</span> </span>&#123;</div><div class="line">        <span class="comment">// If there's no cache entry, we're done.</span></div><div class="line">        <span class="keyword">if</span> (entry == <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (entry.etag != <span class="keyword">null</span>) &#123;</div><div class="line">            headers.put(<span class="string">"If-None-Match"</span>, entry.etag);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (entry.lastModified &gt; <span class="number">0</span>) &#123;</div><div class="line">            Date refTime = <span class="keyword">new</span> Date(entry.lastModified);</div><div class="line">            headers.put(<span class="string">"If-Modified-Since"</span>, DateUtils.formatDate(refTime));</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">logError</span><span class="params">(String what, String url, <span class="keyword">long</span> start)</span> </span>&#123;</div><div class="line">        <span class="keyword">long</span> now = SystemClock.elapsedRealtime();</div><div class="line">        VolleyLog.v(<span class="string">"HTTP ERROR(%s) %d ms to fetch %s"</span>, what, (now - start), url);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/** Reads the contents of HttpEntity into a byte[]. */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">byte</span>[] entityToBytes(HttpEntity entity) <span class="keyword">throws</span> IOException, ServerError &#123;</div><div class="line">        PoolingByteArrayOutputStream bytes =</div><div class="line">                <span class="keyword">new</span> PoolingByteArrayOutputStream(mPool, (<span class="keyword">int</span>) entity.getContentLength());</div><div class="line">        <span class="keyword">byte</span>[] buffer = <span class="keyword">null</span>;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            InputStream in = entity.getContent();</div><div class="line">            <span class="keyword">if</span> (in == <span class="keyword">null</span>) &#123;</div><div class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> ServerError();</div><div class="line">            &#125;</div><div class="line">            buffer = mPool.getBuf(<span class="number">1024</span>);</div><div class="line">            <span class="keyword">int</span> count;</div><div class="line">            <span class="keyword">while</span> ((count = in.read(buffer)) != -<span class="number">1</span>) &#123;</div><div class="line">                bytes.write(buffer, <span class="number">0</span>, count);</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">return</span> bytes.toByteArray();</div><div class="line">        &#125; <span class="keyword">finally</span> &#123;</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                <span class="comment">// Close the InputStream and release the resources by "consuming the content".</span></div><div class="line">                entity.consumeContent();</div><div class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line">                <span class="comment">// This can happen if there was an exception above that left the entity in</span></div><div class="line">                <span class="comment">// an invalid state.</span></div><div class="line">                VolleyLog.v(<span class="string">"Error occurred when calling consumingContent"</span>);</div><div class="line">            &#125;</div><div class="line">            mPool.returnBuf(buffer);</div><div class="line">            bytes.close();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Converts Headers[] to Map&lt;String, String&gt;.</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">static</span> Map&lt;String, String&gt; <span class="title">convertHeaders</span><span class="params">(Header[] headers)</span> </span>&#123;</div><div class="line">        Map&lt;String, String&gt; result = <span class="keyword">new</span> TreeMap&lt;String, String&gt;(String.CASE_INSENSITIVE_ORDER);</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; headers.length; i++) &#123;</div><div class="line">            result.put(headers[i].getName(), headers[i].getValue());</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> result;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>HttpStack 是一个接口，里面只有一个 performRequest() 方法，HurlStack 和 HttpClientStack 都继承自这个接口，如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * An HTTP stack abstraction.</div><div class="line"> */</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">HttpStack</span> </span>&#123;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Performs an HTTP request with the given parameters.</div><div class="line">     *</div><div class="line">     * &lt;p&gt;A GET request is sent if request.getPostBody() == null. A POST request is sent otherwise,</div><div class="line">     * and the Content-Type header is set to request.getPostBodyContentType().&lt;/p&gt;</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> request the request to perform</div><div class="line">     * <span class="doctag">@param</span> additionalHeaders additional headers to be sent together with</div><div class="line">     *         &#123;<span class="doctag">@link</span> Request#getHeaders()&#125;</div><div class="line">     * <span class="doctag">@return</span> the HTTP response</div><div class="line">     */</div><div class="line">    <span class="function">HttpResponse <span class="title">performRequest</span><span class="params">(Request&lt;?&gt; request, Map&lt;String, String&gt; additionalHeaders)</span></span></div><div class="line">        <span class="keyword">throws</span> IOException, AuthFailureError;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>HurlStack 是 基于 HttpURLConnection 的，如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div><div class="line">223</div></pre></td><td class="code"><pre><div class="line">**</div><div class="line"> * An &#123;<span class="meta">@link</span> HttpStack&#125; based on &#123;<span class="meta">@link</span> HttpURLConnection&#125;.</div><div class="line"> */</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HurlStack</span> <span class="keyword">implements</span> <span class="title">HttpStack</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String HEADER_CONTENT_TYPE = <span class="string">"Content-Type"</span>;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * An interface for transforming URLs before use.</div><div class="line">     */</div><div class="line">    <span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">UrlRewriter</span> </span>&#123;</div><div class="line">        <span class="comment">/**</span></div><div class="line">         * Returns a URL to use instead of the provided one, or null to indicate</div><div class="line">         * this URL should not be used at all.</div><div class="line">         */</div><div class="line">        <span class="function">String <span class="title">rewriteUrl</span><span class="params">(String originalUrl)</span></span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> UrlRewriter mUrlRewriter;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> SSLSocketFactory mSslSocketFactory;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">HurlStack</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>(<span class="keyword">null</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * <span class="doctag">@param</span> urlRewriter Rewriter to use for request URLs</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">HurlStack</span><span class="params">(UrlRewriter urlRewriter)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>(urlRewriter, <span class="keyword">null</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * <span class="doctag">@param</span> urlRewriter Rewriter to use for request URLs</div><div class="line">     * <span class="doctag">@param</span> sslSocketFactory SSL factory to use for HTTPS connections</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">HurlStack</span><span class="params">(UrlRewriter urlRewriter, SSLSocketFactory sslSocketFactory)</span> </span>&#123;</div><div class="line">        mUrlRewriter = urlRewriter;</div><div class="line">        mSslSocketFactory = sslSocketFactory;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> HttpResponse <span class="title">performRequest</span><span class="params">(Request&lt;?&gt; request, Map&lt;String, String&gt; additionalHeaders)</span></span></div><div class="line">            <span class="keyword">throws</span> IOException, AuthFailureError &#123;</div><div class="line">        String url = request.getUrl();</div><div class="line">        HashMap&lt;String, String&gt; map = <span class="keyword">new</span> HashMap&lt;String, String&gt;();</div><div class="line">        map.putAll(request.getHeaders());</div><div class="line">        map.putAll(additionalHeaders);</div><div class="line">        <span class="keyword">if</span> (mUrlRewriter != <span class="keyword">null</span>) &#123;</div><div class="line">            String rewritten = mUrlRewriter.rewriteUrl(url);</div><div class="line">            <span class="keyword">if</span> (rewritten == <span class="keyword">null</span>) &#123;</div><div class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> IOException(<span class="string">"URL blocked by rewriter: "</span> + url);</div><div class="line">            &#125;</div><div class="line">            url = rewritten;</div><div class="line">        &#125;</div><div class="line">        URL parsedUrl = <span class="keyword">new</span> URL(url);</div><div class="line">        HttpURLConnection connection = openConnection(parsedUrl, request);</div><div class="line">        <span class="keyword">for</span> (String headerName : map.keySet()) &#123;</div><div class="line">            connection.addRequestProperty(headerName, map.get(headerName));</div><div class="line">        &#125;</div><div class="line">        setConnectionParametersForRequest(connection, request);</div><div class="line">        <span class="comment">// Initialize HttpResponse with data from the HttpURLConnection.</span></div><div class="line">        ProtocolVersion protocolVersion = <span class="keyword">new</span> ProtocolVersion(<span class="string">"HTTP"</span>, <span class="number">1</span>, <span class="number">1</span>);</div><div class="line">        <span class="keyword">int</span> responseCode = connection.getResponseCode();</div><div class="line">        <span class="keyword">if</span> (responseCode == -<span class="number">1</span>) &#123;</div><div class="line">            <span class="comment">// -1 is returned by getResponseCode() if the response code could not be retrieved.</span></div><div class="line">            <span class="comment">// Signal to the caller that something was wrong with the connection.</span></div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IOException(<span class="string">"Could not retrieve response code from HttpUrlConnection."</span>);</div><div class="line">        &#125;</div><div class="line">        StatusLine responseStatus = <span class="keyword">new</span> BasicStatusLine(protocolVersion,</div><div class="line">                connection.getResponseCode(), connection.getResponseMessage());</div><div class="line">        BasicHttpResponse response = <span class="keyword">new</span> BasicHttpResponse(responseStatus);</div><div class="line">        <span class="keyword">if</span> (hasResponseBody(request.getMethod(), responseStatus.getStatusCode())) &#123;</div><div class="line">            response.setEntity(entityFromConnection(connection));</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">for</span> (Entry&lt;String, List&lt;String&gt;&gt; header : connection.getHeaderFields().entrySet()) &#123;</div><div class="line">            <span class="keyword">if</span> (header.getKey() != <span class="keyword">null</span>) &#123;</div><div class="line">                Header h = <span class="keyword">new</span> BasicHeader(header.getKey(), header.getValue().get(<span class="number">0</span>));</div><div class="line">                response.addHeader(h);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> response;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Checks if a response message contains a body.</div><div class="line">     * <span class="doctag">@see</span> &lt;a href="https://tools.ietf.org/html/rfc7230#section-3.3"&gt;RFC 7230 section 3.3&lt;/a&gt;</div><div class="line">     * <span class="doctag">@param</span> requestMethod request method</div><div class="line">     * <span class="doctag">@param</span> responseCode response status code</div><div class="line">     * <span class="doctag">@return</span> whether the response has a body</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">hasResponseBody</span><span class="params">(<span class="keyword">int</span> requestMethod, <span class="keyword">int</span> responseCode)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> requestMethod != Request.Method.HEAD</div><div class="line">            &amp;&amp; !(HttpStatus.SC_CONTINUE &lt;= responseCode &amp;&amp; responseCode &lt; HttpStatus.SC_OK)</div><div class="line">            &amp;&amp; responseCode != HttpStatus.SC_NO_CONTENT</div><div class="line">            &amp;&amp; responseCode != HttpStatus.SC_NOT_MODIFIED;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Initializes an &#123;<span class="doctag">@link</span> HttpEntity&#125; from the given &#123;<span class="doctag">@link</span> HttpURLConnection&#125;.</div><div class="line">     * <span class="doctag">@param</span> connection</div><div class="line">     * <span class="doctag">@return</span> an HttpEntity populated with data from &lt;code&gt;connection&lt;/code&gt;.</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> HttpEntity <span class="title">entityFromConnection</span><span class="params">(HttpURLConnection connection)</span> </span>&#123;</div><div class="line">        BasicHttpEntity entity = <span class="keyword">new</span> BasicHttpEntity();</div><div class="line">        InputStream inputStream;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            inputStream = connection.getInputStream();</div><div class="line">        &#125; <span class="keyword">catch</span> (IOException ioe) &#123;</div><div class="line">            inputStream = connection.getErrorStream();</div><div class="line">        &#125;</div><div class="line">        entity.setContent(inputStream);</div><div class="line">        entity.setContentLength(connection.getContentLength());</div><div class="line">        entity.setContentEncoding(connection.getContentEncoding());</div><div class="line">        entity.setContentType(connection.getContentType());</div><div class="line">        <span class="keyword">return</span> entity;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Create an &#123;<span class="doctag">@link</span> HttpURLConnection&#125; for the specified &#123;<span class="doctag">@code</span> url&#125;.</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">protected</span> HttpURLConnection <span class="title">createConnection</span><span class="params">(URL url)</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">        HttpURLConnection connection = (HttpURLConnection) url.openConnection();</div><div class="line"></div><div class="line">        <span class="comment">// Workaround for the M release HttpURLConnection not observing the</span></div><div class="line">        <span class="comment">// HttpURLConnection.setFollowRedirects() property.</span></div><div class="line">        <span class="comment">// https://code.google.com/p/android/issues/detail?id=194495</span></div><div class="line">        connection.setInstanceFollowRedirects(HttpURLConnection.getFollowRedirects());</div><div class="line"></div><div class="line">        <span class="keyword">return</span> connection;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Opens an &#123;<span class="doctag">@link</span> HttpURLConnection&#125; with parameters.</div><div class="line">     * <span class="doctag">@param</span> url</div><div class="line">     * <span class="doctag">@return</span> an open connection</div><div class="line">     * <span class="doctag">@throws</span> IOException</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">private</span> HttpURLConnection <span class="title">openConnection</span><span class="params">(URL url, Request&lt;?&gt; request)</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">        HttpURLConnection connection = createConnection(url);</div><div class="line"></div><div class="line">        <span class="keyword">int</span> timeoutMs = request.getTimeoutMs();</div><div class="line">        connection.setConnectTimeout(timeoutMs);</div><div class="line">        connection.setReadTimeout(timeoutMs);</div><div class="line">        connection.setUseCaches(<span class="keyword">false</span>);</div><div class="line">        connection.setDoInput(<span class="keyword">true</span>);</div><div class="line"></div><div class="line">        <span class="comment">// use caller-provided custom SslSocketFactory, if any, for HTTPS</span></div><div class="line">        <span class="keyword">if</span> (<span class="string">"https"</span>.equals(url.getProtocol()) &amp;&amp; mSslSocketFactory != <span class="keyword">null</span>) &#123;</div><div class="line">            ((HttpsURLConnection)connection).setSSLSocketFactory(mSslSocketFactory);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">return</span> connection;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@SuppressWarnings</span>(<span class="string">"deprecation"</span>)</div><div class="line">    <span class="comment">/* package */</span> <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">setConnectionParametersForRequest</span><span class="params">(HttpURLConnection connection,</span></span></div><div class="line">            Request&lt;?&gt; request) <span class="keyword">throws</span> IOException, AuthFailureError &#123;</div><div class="line">        <span class="keyword">switch</span> (request.getMethod()) &#123;</div><div class="line">            <span class="keyword">case</span> Method.DEPRECATED_GET_OR_POST:</div><div class="line">                <span class="comment">// This is the deprecated way that needs to be handled for backwards compatibility.</span></div><div class="line">                <span class="comment">// If the request's post body is null, then the assumption is that the request is</span></div><div class="line">                <span class="comment">// GET.  Otherwise, it is assumed that the request is a POST.</span></div><div class="line">                <span class="keyword">byte</span>[] postBody = request.getPostBody();</div><div class="line">                <span class="keyword">if</span> (postBody != <span class="keyword">null</span>) &#123;</div><div class="line">                    <span class="comment">// Prepare output. There is no need to set Content-Length explicitly,</span></div><div class="line">                    <span class="comment">// since this is handled by HttpURLConnection using the size of the prepared</span></div><div class="line">                    <span class="comment">// output stream.</span></div><div class="line">                    connection.setDoOutput(<span class="keyword">true</span>);</div><div class="line">                    connection.setRequestMethod(<span class="string">"POST"</span>);</div><div class="line">                    connection.addRequestProperty(HEADER_CONTENT_TYPE,</div><div class="line">                            request.getPostBodyContentType());</div><div class="line">                    DataOutputStream out = <span class="keyword">new</span> DataOutputStream(connection.getOutputStream());</div><div class="line">                    out.write(postBody);</div><div class="line">                    out.close();</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            <span class="keyword">case</span> Method.GET:</div><div class="line">                <span class="comment">// Not necessary to set the request method because connection defaults to GET but</span></div><div class="line">                <span class="comment">// being explicit here.</span></div><div class="line">                connection.setRequestMethod(<span class="string">"GET"</span>);</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            <span class="keyword">case</span> Method.DELETE:</div><div class="line">                connection.setRequestMethod(<span class="string">"DELETE"</span>);</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            <span class="keyword">case</span> Method.POST:</div><div class="line">                connection.setRequestMethod(<span class="string">"POST"</span>);</div><div class="line">                addBodyIfExists(connection, request);</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            <span class="keyword">case</span> Method.PUT:</div><div class="line">                connection.setRequestMethod(<span class="string">"PUT"</span>);</div><div class="line">                addBodyIfExists(connection, request);</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            <span class="keyword">case</span> Method.HEAD:</div><div class="line">                connection.setRequestMethod(<span class="string">"HEAD"</span>);</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            <span class="keyword">case</span> Method.OPTIONS:</div><div class="line">                connection.setRequestMethod(<span class="string">"OPTIONS"</span>);</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            <span class="keyword">case</span> Method.TRACE:</div><div class="line">                connection.setRequestMethod(<span class="string">"TRACE"</span>);</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            <span class="keyword">case</span> Method.PATCH:</div><div class="line">                connection.setRequestMethod(<span class="string">"PATCH"</span>);</div><div class="line">                addBodyIfExists(connection, request);</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            <span class="keyword">default</span>:</div><div class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Unknown method type."</span>);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">addBodyIfExists</span><span class="params">(HttpURLConnection connection, Request&lt;?&gt; request)</span></span></div><div class="line">            <span class="keyword">throws</span> IOException, AuthFailureError &#123;</div><div class="line">        <span class="keyword">byte</span>[] body = request.getBody();</div><div class="line">        <span class="keyword">if</span> (body != <span class="keyword">null</span>) &#123;</div><div class="line">            connection.setDoOutput(<span class="keyword">true</span>);</div><div class="line">            connection.addRequestProperty(HEADER_CONTENT_TYPE, request.getBodyContentType());</div><div class="line">            DataOutputStream out = <span class="keyword">new</span> DataOutputStream(connection.getOutputStream());</div><div class="line">            out.write(body);</div><div class="line">            out.close();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>HttpClientStack 是基于 HttpClient 的，如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * An HttpStack that performs request over an &#123;<span class="doctag">@link</span> HttpClient&#125;.</div><div class="line"> */</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HttpClientStack</span> <span class="keyword">implements</span> <span class="title">HttpStack</span> </span>&#123;</div><div class="line">    <span class="keyword">protected</span> <span class="keyword">final</span> HttpClient mClient;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> String HEADER_CONTENT_TYPE = <span class="string">"Content-Type"</span>;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">HttpClientStack</span><span class="params">(HttpClient client)</span> </span>&#123;</div><div class="line">        mClient = client;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">addHeaders</span><span class="params">(HttpUriRequest httpRequest, Map&lt;String, String&gt; headers)</span> </span>&#123;</div><div class="line">        <span class="keyword">for</span> (String key : headers.keySet()) &#123;</div><div class="line">            httpRequest.setHeader(key, headers.get(key));</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@SuppressWarnings</span>(<span class="string">"unused"</span>)</div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> List&lt;NameValuePair&gt; <span class="title">getPostParameterPairs</span><span class="params">(Map&lt;String, String&gt; postParams)</span> </span>&#123;</div><div class="line">        List&lt;NameValuePair&gt; result = <span class="keyword">new</span> ArrayList&lt;NameValuePair&gt;(postParams.size());</div><div class="line">        <span class="keyword">for</span> (String key : postParams.keySet()) &#123;</div><div class="line">            result.add(<span class="keyword">new</span> BasicNameValuePair(key, postParams.get(key)));</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> result;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> HttpResponse <span class="title">performRequest</span><span class="params">(Request&lt;?&gt; request, Map&lt;String, String&gt; additionalHeaders)</span></span></div><div class="line">            <span class="keyword">throws</span> IOException, AuthFailureError &#123;</div><div class="line">        HttpUriRequest httpRequest = createHttpRequest(request, additionalHeaders);</div><div class="line">        addHeaders(httpRequest, additionalHeaders);</div><div class="line">        addHeaders(httpRequest, request.getHeaders());</div><div class="line">        onPrepareRequest(httpRequest);</div><div class="line">        HttpParams httpParams = httpRequest.getParams();</div><div class="line">        <span class="keyword">int</span> timeoutMs = request.getTimeoutMs();</div><div class="line">        <span class="comment">// <span class="doctag">TODO:</span> Reevaluate this connection timeout based on more wide-scale</span></div><div class="line">        <span class="comment">// data collection and possibly different for wifi vs. 3G.</span></div><div class="line">        HttpConnectionParams.setConnectionTimeout(httpParams, <span class="number">5000</span>);</div><div class="line">        HttpConnectionParams.setSoTimeout(httpParams, timeoutMs);</div><div class="line">        <span class="keyword">return</span> mClient.execute(httpRequest);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Creates the appropriate subclass of HttpUriRequest for passed in request.</div><div class="line">     */</div><div class="line">    <span class="meta">@SuppressWarnings</span>(<span class="string">"deprecation"</span>)</div><div class="line">    <span class="comment">/* protected */</span> <span class="function"><span class="keyword">static</span> HttpUriRequest <span class="title">createHttpRequest</span><span class="params">(Request&lt;?&gt; request,</span></span></div><div class="line">            Map&lt;String, String&gt; additionalHeaders) <span class="keyword">throws</span> AuthFailureError &#123;</div><div class="line">        <span class="keyword">switch</span> (request.getMethod()) &#123;</div><div class="line">            <span class="keyword">case</span> Method.DEPRECATED_GET_OR_POST: &#123;</div><div class="line">                <span class="comment">// This is the deprecated way that needs to be handled for backwards compatibility.</span></div><div class="line">                <span class="comment">// If the request's post body is null, then the assumption is that the request is</span></div><div class="line">                <span class="comment">// GET.  Otherwise, it is assumed that the request is a POST.</span></div><div class="line">                <span class="keyword">byte</span>[] postBody = request.getPostBody();</div><div class="line">                <span class="keyword">if</span> (postBody != <span class="keyword">null</span>) &#123;</div><div class="line">                    HttpPost postRequest = <span class="keyword">new</span> HttpPost(request.getUrl());</div><div class="line">                    postRequest.addHeader(HEADER_CONTENT_TYPE, request.getPostBodyContentType());</div><div class="line">                    HttpEntity entity;</div><div class="line">                    entity = <span class="keyword">new</span> ByteArrayEntity(postBody);</div><div class="line">                    postRequest.setEntity(entity);</div><div class="line">                    <span class="keyword">return</span> postRequest;</div><div class="line">                &#125; <span class="keyword">else</span> &#123;</div><div class="line">                    <span class="keyword">return</span> <span class="keyword">new</span> HttpGet(request.getUrl());</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">case</span> Method.GET:</div><div class="line">                <span class="keyword">return</span> <span class="keyword">new</span> HttpGet(request.getUrl());</div><div class="line">            <span class="keyword">case</span> Method.DELETE:</div><div class="line">                <span class="keyword">return</span> <span class="keyword">new</span> HttpDelete(request.getUrl());</div><div class="line">            <span class="keyword">case</span> Method.POST: &#123;</div><div class="line">                HttpPost postRequest = <span class="keyword">new</span> HttpPost(request.getUrl());</div><div class="line">                postRequest.addHeader(HEADER_CONTENT_TYPE, request.getBodyContentType());</div><div class="line">                setEntityIfNonEmptyBody(postRequest, request);</div><div class="line">                <span class="keyword">return</span> postRequest;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">case</span> Method.PUT: &#123;</div><div class="line">                HttpPut putRequest = <span class="keyword">new</span> HttpPut(request.getUrl());</div><div class="line">                putRequest.addHeader(HEADER_CONTENT_TYPE, request.getBodyContentType());</div><div class="line">                setEntityIfNonEmptyBody(putRequest, request);</div><div class="line">                <span class="keyword">return</span> putRequest;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">case</span> Method.HEAD:</div><div class="line">                <span class="keyword">return</span> <span class="keyword">new</span> HttpHead(request.getUrl());</div><div class="line">            <span class="keyword">case</span> Method.OPTIONS:</div><div class="line">                <span class="keyword">return</span> <span class="keyword">new</span> HttpOptions(request.getUrl());</div><div class="line">            <span class="keyword">case</span> Method.TRACE:</div><div class="line">                <span class="keyword">return</span> <span class="keyword">new</span> HttpTrace(request.getUrl());</div><div class="line">            <span class="keyword">case</span> Method.PATCH: &#123;</div><div class="line">                HttpPatch patchRequest = <span class="keyword">new</span> HttpPatch(request.getUrl());</div><div class="line">                patchRequest.addHeader(HEADER_CONTENT_TYPE, request.getBodyContentType());</div><div class="line">                setEntityIfNonEmptyBody(patchRequest, request);</div><div class="line">                <span class="keyword">return</span> patchRequest;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">default</span>:</div><div class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Unknown request method."</span>);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">setEntityIfNonEmptyBody</span><span class="params">(HttpEntityEnclosingRequestBase httpRequest,</span></span></div><div class="line">            Request&lt;?&gt; request) <span class="keyword">throws</span> AuthFailureError &#123;</div><div class="line">        <span class="keyword">byte</span>[] body = request.getBody();</div><div class="line">        <span class="keyword">if</span> (body != <span class="keyword">null</span>) &#123;</div><div class="line">            HttpEntity entity = <span class="keyword">new</span> ByteArrayEntity(body);</div><div class="line">            httpRequest.setEntity(entity);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Called before the request is executed using the underlying HttpClient.</div><div class="line">     *</div><div class="line">     * &lt;p&gt;Overwrite in subclasses to augment the request.&lt;/p&gt;</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onPrepareRequest</span><span class="params">(HttpUriRequest request)</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">        <span class="comment">// Nothing.</span></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * The HttpPatch class does not exist in the Android framework, so this has been defined here.</div><div class="line">     */</div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">HttpPatch</span> <span class="keyword">extends</span> <span class="title">HttpEntityEnclosingRequestBase</span> </span>&#123;</div><div class="line"></div><div class="line">        <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">static</span> String METHOD_NAME = <span class="string">"PATCH"</span>;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="title">HttpPatch</span><span class="params">()</span> </span>&#123;</div><div class="line">            <span class="keyword">super</span>();</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="title">HttpPatch</span><span class="params">(<span class="keyword">final</span> URI uri)</span> </span>&#123;</div><div class="line">            <span class="keyword">super</span>();</div><div class="line">            setURI(uri);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">/**</span></div><div class="line">         * <span class="doctag">@throws</span> IllegalArgumentException if the uri is invalid.</div><div class="line">         */</div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="title">HttpPatch</span><span class="params">(<span class="keyword">final</span> String uri)</span> </span>&#123;</div><div class="line">            <span class="keyword">super</span>();</div><div class="line">            setURI(URI.create(uri));</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> String <span class="title">getMethod</span><span class="params">()</span> </span>&#123;</div><div class="line">            <span class="keyword">return</span> METHOD_NAME;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="Request"><a href="#Request" class="headerlink" title="Request"></a>Request</h3><h4 id="StringRequest"><a href="#StringRequest" class="headerlink" title="StringRequest"></a>StringRequest</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * A canned request for retrieving the response body at a given URL as a String.</div><div class="line"> */</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">StringRequest</span> <span class="keyword">extends</span> <span class="title">Request</span>&lt;<span class="title">String</span>&gt; </span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Listener&lt;String&gt; mListener;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Creates a new request with the given method.</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> method the request &#123;<span class="doctag">@link</span> Method&#125; to use</div><div class="line">     * <span class="doctag">@param</span> url URL to fetch the string at</div><div class="line">     * <span class="doctag">@param</span> listener Listener to receive the String response</div><div class="line">     * <span class="doctag">@param</span> errorListener Error listener, or null to ignore errors</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">StringRequest</span><span class="params">(<span class="keyword">int</span> method, String url, Listener&lt;String&gt; listener,</span></span></div><div class="line">            ErrorListener errorListener) &#123;</div><div class="line">        <span class="keyword">super</span>(method, url, errorListener);</div><div class="line">        mListener = listener;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Creates a new GET request.</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> url URL to fetch the string at</div><div class="line">     * <span class="doctag">@param</span> listener Listener to receive the String response</div><div class="line">     * <span class="doctag">@param</span> errorListener Error listener, or null to ignore errors</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">StringRequest</span><span class="params">(String url, Listener&lt;String&gt; listener, ErrorListener errorListener)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>(Method.GET, url, listener, errorListener);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">deliverResponse</span><span class="params">(String response)</span> </span>&#123;</div><div class="line">        mListener.onResponse(response);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> Response&lt;String&gt; <span class="title">parseNetworkResponse</span><span class="params">(NetworkResponse response)</span> </span>&#123;</div><div class="line">        String parsed;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            parsed = <span class="keyword">new</span> String(response.data, HttpHeaderParser.parseCharset(response.headers));</div><div class="line">        &#125; <span class="keyword">catch</span> (UnsupportedEncodingException e) &#123;</div><div class="line">            parsed = <span class="keyword">new</span> String(response.data);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> Response.success(parsed, HttpHeaderParser.parseCacheHeaders(response));</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="JsonRequest"><a href="#JsonRequest" class="headerlink" title="JsonRequest"></a>JsonRequest</h4><h5 id="JsonRequest-1"><a href="#JsonRequest-1" class="headerlink" title="JsonRequest"></a>JsonRequest</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * A request for retrieving a T type response body at a given URL that also</div><div class="line"> * optionally sends along a JSON body in the request specified.</div><div class="line"> *</div><div class="line"> * <span class="doctag">@param</span> &lt;T&gt; JSON type of response expected</div><div class="line"> */</div><div class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">JsonRequest</span>&lt;<span class="title">T</span>&gt; <span class="keyword">extends</span> <span class="title">Request</span>&lt;<span class="title">T</span>&gt; </span>&#123;</div><div class="line">    <span class="comment">/** Default charset for JSON request. */</span></div><div class="line">    <span class="keyword">protected</span> <span class="keyword">static</span> <span class="keyword">final</span> String PROTOCOL_CHARSET = <span class="string">"utf-8"</span>;</div><div class="line"></div><div class="line">    <span class="comment">/** Content type for request. */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String PROTOCOL_CONTENT_TYPE =</div><div class="line">        String.format(<span class="string">"application/json; charset=%s"</span>, PROTOCOL_CHARSET);</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Listener&lt;T&gt; mListener;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String mRequestBody;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Deprecated constructor for a JsonRequest which defaults to GET unless &#123;<span class="doctag">@link</span> #getPostBody()&#125;</div><div class="line">     * or &#123;<span class="doctag">@link</span> #getPostParams()&#125; is overridden (which defaults to POST).</div><div class="line">     *</div><div class="line">     * <span class="doctag">@deprecated</span> Use &#123;<span class="doctag">@link</span> #JsonRequest(int, String, String, Listener, ErrorListener)&#125;.</div><div class="line">     */</div><div class="line">    <span class="meta">@Deprecated</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">JsonRequest</span><span class="params">(String url, String requestBody, Listener&lt;T&gt; listener,</span></span></div><div class="line">            ErrorListener errorListener) &#123;</div><div class="line">        <span class="keyword">this</span>(Method.DEPRECATED_GET_OR_POST, url, requestBody, listener, errorListener);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">JsonRequest</span><span class="params">(<span class="keyword">int</span> method, String url, String requestBody, Listener&lt;T&gt; listener,</span></span></div><div class="line">            ErrorListener errorListener) &#123;</div><div class="line">        <span class="keyword">super</span>(method, url, errorListener);</div><div class="line">        mListener = listener;</div><div class="line">        mRequestBody = requestBody;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">deliverResponse</span><span class="params">(T response)</span> </span>&#123;</div><div class="line">        mListener.onResponse(response);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">abstract</span> <span class="keyword">protected</span> Response&lt;T&gt; <span class="title">parseNetworkResponse</span><span class="params">(NetworkResponse response)</span></span>;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * <span class="doctag">@deprecated</span> Use &#123;<span class="doctag">@link</span> #getBodyContentType()&#125;.</div><div class="line">     */</div><div class="line">    <span class="meta">@Deprecated</span></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getPostBodyContentType</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> getBodyContentType();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * <span class="doctag">@deprecated</span> Use &#123;<span class="doctag">@link</span> #getBody()&#125;.</div><div class="line">     */</div><div class="line">    <span class="meta">@Deprecated</span></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="keyword">public</span> <span class="keyword">byte</span>[] getPostBody() &#123;</div><div class="line">        <span class="keyword">return</span> getBody();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getBodyContentType</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> PROTOCOL_CONTENT_TYPE;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="keyword">public</span> <span class="keyword">byte</span>[] getBody() &#123;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            <span class="keyword">return</span> mRequestBody == <span class="keyword">null</span> ? <span class="keyword">null</span> : mRequestBody.getBytes(PROTOCOL_CHARSET);</div><div class="line">        &#125; <span class="keyword">catch</span> (UnsupportedEncodingException uee) &#123;</div><div class="line">            VolleyLog.wtf(<span class="string">"Unsupported Encoding while trying to get the bytes of %s using %s"</span>,</div><div class="line">                    mRequestBody, PROTOCOL_CHARSET);</div><div class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h5 id="JsonObjectRequest"><a href="#JsonObjectRequest" class="headerlink" title="JsonObjectRequest"></a>JsonObjectRequest</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * A request for retrieving a &#123;<span class="doctag">@link</span> JSONObject&#125; response body at a given URL, allowing for an</div><div class="line"> * optional &#123;<span class="doctag">@link</span> JSONObject&#125; to be passed in as part of the request body.</div><div class="line"> */</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JsonObjectRequest</span> <span class="keyword">extends</span> <span class="title">JsonRequest</span>&lt;<span class="title">JSONObject</span>&gt; </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Creates a new request.</div><div class="line">     * <span class="doctag">@param</span> method the HTTP method to use</div><div class="line">     * <span class="doctag">@param</span> url URL to fetch the JSON from</div><div class="line">     * <span class="doctag">@param</span> jsonRequest A &#123;<span class="doctag">@link</span> JSONObject&#125; to post with the request. Null is allowed and</div><div class="line">     *   indicates no parameters will be posted along with request.</div><div class="line">     * <span class="doctag">@param</span> listener Listener to receive the JSON response</div><div class="line">     * <span class="doctag">@param</span> errorListener Error listener, or null to ignore errors.</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">JsonObjectRequest</span><span class="params">(<span class="keyword">int</span> method, String url, JSONObject jsonRequest,</span></span></div><div class="line">            Listener&lt;JSONObject&gt; listener, ErrorListener errorListener) &#123;</div><div class="line">        <span class="keyword">super</span>(method, url, (jsonRequest == <span class="keyword">null</span>) ? <span class="keyword">null</span> : jsonRequest.toString(), listener,</div><div class="line">                    errorListener);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Constructor which defaults to &lt;code&gt;GET&lt;/code&gt; if &lt;code&gt;jsonRequest&lt;/code&gt; is</div><div class="line">     * &lt;code&gt;null&lt;/code&gt;, &lt;code&gt;POST&lt;/code&gt; otherwise.</div><div class="line">     *</div><div class="line">     * <span class="doctag">@see</span> #JsonObjectRequest(int, String, JSONObject, Listener, ErrorListener)</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">JsonObjectRequest</span><span class="params">(String url, JSONObject jsonRequest, Listener&lt;JSONObject&gt; listener,</span></span></div><div class="line">            ErrorListener errorListener) &#123;</div><div class="line">        <span class="keyword">this</span>(jsonRequest == <span class="keyword">null</span> ? Method.GET : Method.POST, url, jsonRequest,</div><div class="line">                listener, errorListener);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> Response&lt;JSONObject&gt; <span class="title">parseNetworkResponse</span><span class="params">(NetworkResponse response)</span> </span>&#123;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            String jsonString = <span class="keyword">new</span> String(response.data,</div><div class="line">                    HttpHeaderParser.parseCharset(response.headers, PROTOCOL_CHARSET));</div><div class="line">            <span class="keyword">return</span> Response.success(<span class="keyword">new</span> JSONObject(jsonString),</div><div class="line">                    HttpHeaderParser.parseCacheHeaders(response));</div><div class="line">        &#125; <span class="keyword">catch</span> (UnsupportedEncodingException e) &#123;</div><div class="line">            <span class="keyword">return</span> Response.error(<span class="keyword">new</span> ParseError(e));</div><div class="line">        &#125; <span class="keyword">catch</span> (JSONException je) &#123;</div><div class="line">            <span class="keyword">return</span> Response.error(<span class="keyword">new</span> ParseError(je));</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h5 id="JsonArrayRequest"><a href="#JsonArrayRequest" class="headerlink" title="JsonArrayRequest"></a>JsonArrayRequest</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * A request for retrieving a &#123;<span class="doctag">@link</span> JSONArray&#125; response body at a given URL.</div><div class="line"> */</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JsonArrayRequest</span> <span class="keyword">extends</span> <span class="title">JsonRequest</span>&lt;<span class="title">JSONArray</span>&gt; </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Creates a new request.</div><div class="line">     * <span class="doctag">@param</span> url URL to fetch the JSON from</div><div class="line">     * <span class="doctag">@param</span> listener Listener to receive the JSON response</div><div class="line">     * <span class="doctag">@param</span> errorListener Error listener, or null to ignore errors.</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">JsonArrayRequest</span><span class="params">(String url, Listener&lt;JSONArray&gt; listener, ErrorListener errorListener)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>(Method.GET, url, <span class="keyword">null</span>, listener, errorListener);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Creates a new request.</div><div class="line">     * <span class="doctag">@param</span> method the HTTP method to use</div><div class="line">     * <span class="doctag">@param</span> url URL to fetch the JSON from</div><div class="line">     * <span class="doctag">@param</span> jsonRequest A &#123;<span class="doctag">@link</span> JSONArray&#125; to post with the request. Null is allowed and</div><div class="line">     *   indicates no parameters will be posted along with request.</div><div class="line">     * <span class="doctag">@param</span> listener Listener to receive the JSON response</div><div class="line">     * <span class="doctag">@param</span> errorListener Error listener, or null to ignore errors.</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">JsonArrayRequest</span><span class="params">(<span class="keyword">int</span> method, String url, JSONArray jsonRequest,</span></span></div><div class="line">                            Listener&lt;JSONArray&gt; listener, ErrorListener errorListener) &#123;</div><div class="line">        <span class="keyword">super</span>(method, url, (jsonRequest == <span class="keyword">null</span>) ? <span class="keyword">null</span> : jsonRequest.toString(), listener,</div><div class="line">                errorListener);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> Response&lt;JSONArray&gt; <span class="title">parseNetworkResponse</span><span class="params">(NetworkResponse response)</span> </span>&#123;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            String jsonString = <span class="keyword">new</span> String(response.data,</div><div class="line">                    HttpHeaderParser.parseCharset(response.headers, PROTOCOL_CHARSET));</div><div class="line">            <span class="keyword">return</span> Response.success(<span class="keyword">new</span> JSONArray(jsonString),</div><div class="line">                    HttpHeaderParser.parseCacheHeaders(response));</div><div class="line">        &#125; <span class="keyword">catch</span> (UnsupportedEncodingException e) &#123;</div><div class="line">            <span class="keyword">return</span> Response.error(<span class="keyword">new</span> ParseError(e));</div><div class="line">        &#125; <span class="keyword">catch</span> (JSONException je) &#123;</div><div class="line">            <span class="keyword">return</span> Response.error(<span class="keyword">new</span> ParseError(je));</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="ImageRequest"><a href="#ImageRequest" class="headerlink" title="ImageRequest"></a>ImageRequest</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * A canned request for getting an image at a given URL and calling</div><div class="line"> * back with a decoded Bitmap.</div><div class="line"> */</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ImageRequest</span> <span class="keyword">extends</span> <span class="title">Request</span>&lt;<span class="title">Bitmap</span>&gt; </span>&#123;</div><div class="line">    <span class="comment">/** Socket timeout in milliseconds for image requests */</span></div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> DEFAULT_IMAGE_TIMEOUT_MS = <span class="number">1000</span>;</div><div class="line"></div><div class="line">    <span class="comment">/** Default number of retries for image requests */</span></div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> DEFAULT_IMAGE_MAX_RETRIES = <span class="number">2</span>;</div><div class="line"></div><div class="line">    <span class="comment">/** Default backoff multiplier for image requests */</span></div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">float</span> DEFAULT_IMAGE_BACKOFF_MULT = <span class="number">2f</span>;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Response.Listener&lt;Bitmap&gt; mListener;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Config mDecodeConfig;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> mMaxWidth;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> mMaxHeight;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ScaleType mScaleType;</div><div class="line"></div><div class="line">    <span class="comment">/** Decoding lock so that we don't decode more than one image at a time (to avoid OOM's) */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Object sDecodeLock = <span class="keyword">new</span> Object();</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Creates a new image request, decoding to a maximum specified width and</div><div class="line">     * height. If both width and height are zero, the image will be decoded to</div><div class="line">     * its natural size. If one of the two is nonzero, that dimension will be</div><div class="line">     * clamped and the other one will be set to preserve the image's aspect</div><div class="line">     * ratio. If both width and height are nonzero, the image will be decoded to</div><div class="line">     * be fit in the rectangle of dimensions width x height while keeping its</div><div class="line">     * aspect ratio.</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> url URL of the image</div><div class="line">     * <span class="doctag">@param</span> listener Listener to receive the decoded bitmap</div><div class="line">     * <span class="doctag">@param</span> maxWidth Maximum width to decode this bitmap to, or zero for none</div><div class="line">     * <span class="doctag">@param</span> maxHeight Maximum height to decode this bitmap to, or zero for</div><div class="line">     *            none</div><div class="line">     * <span class="doctag">@param</span> scaleType The ImageViews ScaleType used to calculate the needed image size.</div><div class="line">     * <span class="doctag">@param</span> decodeConfig Format to decode the bitmap to</div><div class="line">     * <span class="doctag">@param</span> errorListener Error listener, or null to ignore errors</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ImageRequest</span><span class="params">(String url, Response.Listener&lt;Bitmap&gt; listener, <span class="keyword">int</span> maxWidth, <span class="keyword">int</span> maxHeight,</span></span></div><div class="line">            ScaleType scaleType, Config decodeConfig, Response.ErrorListener errorListener) &#123;</div><div class="line">        <span class="keyword">super</span>(Method.GET, url, errorListener);</div><div class="line">        setRetryPolicy(<span class="keyword">new</span> DefaultRetryPolicy(DEFAULT_IMAGE_TIMEOUT_MS, DEFAULT_IMAGE_MAX_RETRIES,</div><div class="line">                DEFAULT_IMAGE_BACKOFF_MULT));</div><div class="line">        mListener = listener;</div><div class="line">        mDecodeConfig = decodeConfig;</div><div class="line">        mMaxWidth = maxWidth;</div><div class="line">        mMaxHeight = maxHeight;</div><div class="line">        mScaleType = scaleType;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * For API compatibility with the pre-ScaleType variant of the constructor. Equivalent to</div><div class="line">     * the normal constructor with &#123;<span class="doctag">@code</span> ScaleType.CENTER_INSIDE&#125;.</div><div class="line">     */</div><div class="line">    <span class="meta">@Deprecated</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ImageRequest</span><span class="params">(String url, Response.Listener&lt;Bitmap&gt; listener, <span class="keyword">int</span> maxWidth, <span class="keyword">int</span> maxHeight,</span></span></div><div class="line">            Config decodeConfig, Response.ErrorListener errorListener) &#123;</div><div class="line">        <span class="keyword">this</span>(url, listener, maxWidth, maxHeight,</div><div class="line">                ScaleType.CENTER_INSIDE, decodeConfig, errorListener);</div><div class="line">    &#125;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> Priority <span class="title">getPriority</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> Priority.LOW;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Scales one side of a rectangle to fit aspect ratio.</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> maxPrimary Maximum size of the primary dimension (i.e. width for</div><div class="line">     *        max width), or zero to maintain aspect ratio with secondary</div><div class="line">     *        dimension</div><div class="line">     * <span class="doctag">@param</span> maxSecondary Maximum size of the secondary dimension, or zero to</div><div class="line">     *        maintain aspect ratio with primary dimension</div><div class="line">     * <span class="doctag">@param</span> actualPrimary Actual size of the primary dimension</div><div class="line">     * <span class="doctag">@param</span> actualSecondary Actual size of the secondary dimension</div><div class="line">     * <span class="doctag">@param</span> scaleType The ScaleType used to calculate the needed image size.</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">getResizedDimension</span><span class="params">(<span class="keyword">int</span> maxPrimary, <span class="keyword">int</span> maxSecondary, <span class="keyword">int</span> actualPrimary,</span></span></div><div class="line">            <span class="keyword">int</span> actualSecondary, ScaleType scaleType) &#123;</div><div class="line"></div><div class="line">        <span class="comment">// If no dominant value at all, just return the actual.</span></div><div class="line">        <span class="keyword">if</span> ((maxPrimary == <span class="number">0</span>) &amp;&amp; (maxSecondary == <span class="number">0</span>)) &#123;</div><div class="line">            <span class="keyword">return</span> actualPrimary;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// If ScaleType.FIT_XY fill the whole rectangle, ignore ratio.</span></div><div class="line">        <span class="keyword">if</span> (scaleType == ScaleType.FIT_XY) &#123;</div><div class="line">            <span class="keyword">if</span> (maxPrimary == <span class="number">0</span>) &#123;</div><div class="line">                <span class="keyword">return</span> actualPrimary;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">return</span> maxPrimary;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// If primary is unspecified, scale primary to match secondary's scaling ratio.</span></div><div class="line">        <span class="keyword">if</span> (maxPrimary == <span class="number">0</span>) &#123;</div><div class="line">            <span class="keyword">double</span> ratio = (<span class="keyword">double</span>) maxSecondary / (<span class="keyword">double</span>) actualSecondary;</div><div class="line">            <span class="keyword">return</span> (<span class="keyword">int</span>) (actualPrimary * ratio);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (maxSecondary == <span class="number">0</span>) &#123;</div><div class="line">            <span class="keyword">return</span> maxPrimary;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">double</span> ratio = (<span class="keyword">double</span>) actualSecondary / (<span class="keyword">double</span>) actualPrimary;</div><div class="line">        <span class="keyword">int</span> resized = maxPrimary;</div><div class="line"></div><div class="line">        <span class="comment">// If ScaleType.CENTER_CROP fill the whole rectangle, preserve aspect ratio.</span></div><div class="line">        <span class="keyword">if</span> (scaleType == ScaleType.CENTER_CROP) &#123;</div><div class="line">            <span class="keyword">if</span> ((resized * ratio) &lt; maxSecondary) &#123;</div><div class="line">                resized = (<span class="keyword">int</span>) (maxSecondary / ratio);</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">return</span> resized;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> ((resized * ratio) &gt; maxSecondary) &#123;</div><div class="line">            resized = (<span class="keyword">int</span>) (maxSecondary / ratio);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> resized;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> Response&lt;Bitmap&gt; <span class="title">parseNetworkResponse</span><span class="params">(NetworkResponse response)</span> </span>&#123;</div><div class="line">        <span class="comment">// Serialize all decode on a global lock to reduce concurrent heap usage.</span></div><div class="line">        <span class="keyword">synchronized</span> (sDecodeLock) &#123;</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                <span class="keyword">return</span> doParse(response);</div><div class="line">            &#125; <span class="keyword">catch</span> (OutOfMemoryError e) &#123;</div><div class="line">                VolleyLog.e(<span class="string">"Caught OOM for %d byte image, url=%s"</span>, response.data.length, getUrl());</div><div class="line">                <span class="keyword">return</span> Response.error(<span class="keyword">new</span> ParseError(e));</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * The real guts of parseNetworkResponse. Broken out for readability.</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">private</span> Response&lt;Bitmap&gt; <span class="title">doParse</span><span class="params">(NetworkResponse response)</span> </span>&#123;</div><div class="line">        <span class="keyword">byte</span>[] data = response.data;</div><div class="line">        BitmapFactory.Options decodeOptions = <span class="keyword">new</span> BitmapFactory.Options();</div><div class="line">        Bitmap bitmap = <span class="keyword">null</span>;</div><div class="line">        <span class="keyword">if</span> (mMaxWidth == <span class="number">0</span> &amp;&amp; mMaxHeight == <span class="number">0</span>) &#123;</div><div class="line">            decodeOptions.inPreferredConfig = mDecodeConfig;</div><div class="line">            bitmap = BitmapFactory.decodeByteArray(data, <span class="number">0</span>, data.length, decodeOptions);</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="comment">// If we have to resize this image, first get the natural bounds.</span></div><div class="line">            decodeOptions.inJustDecodeBounds = <span class="keyword">true</span>;</div><div class="line">            BitmapFactory.decodeByteArray(data, <span class="number">0</span>, data.length, decodeOptions);</div><div class="line">            <span class="keyword">int</span> actualWidth = decodeOptions.outWidth;</div><div class="line">            <span class="keyword">int</span> actualHeight = decodeOptions.outHeight;</div><div class="line"></div><div class="line">            <span class="comment">// Then compute the dimensions we would ideally like to decode to.</span></div><div class="line">            <span class="keyword">int</span> desiredWidth = getResizedDimension(mMaxWidth, mMaxHeight,</div><div class="line">                    actualWidth, actualHeight, mScaleType);</div><div class="line">            <span class="keyword">int</span> desiredHeight = getResizedDimension(mMaxHeight, mMaxWidth,</div><div class="line">                    actualHeight, actualWidth, mScaleType);</div><div class="line"></div><div class="line">            <span class="comment">// Decode to the nearest power of two scaling factor.</span></div><div class="line">            decodeOptions.inJustDecodeBounds = <span class="keyword">false</span>;</div><div class="line">            <span class="comment">// TODO(ficus): Do we need this or is it okay since API 8 doesn't support it?</span></div><div class="line">            <span class="comment">// decodeOptions.inPreferQualityOverSpeed = PREFER_QUALITY_OVER_SPEED;</span></div><div class="line">            decodeOptions.inSampleSize =</div><div class="line">                findBestSampleSize(actualWidth, actualHeight, desiredWidth, desiredHeight);</div><div class="line">            Bitmap tempBitmap =</div><div class="line">                BitmapFactory.decodeByteArray(data, <span class="number">0</span>, data.length, decodeOptions);</div><div class="line"></div><div class="line">            <span class="comment">// If necessary, scale down to the maximal acceptable size.</span></div><div class="line">            <span class="keyword">if</span> (tempBitmap != <span class="keyword">null</span> &amp;&amp; (tempBitmap.getWidth() &gt; desiredWidth ||</div><div class="line">                    tempBitmap.getHeight() &gt; desiredHeight)) &#123;</div><div class="line">                bitmap = Bitmap.createScaledBitmap(tempBitmap,</div><div class="line">                        desiredWidth, desiredHeight, <span class="keyword">true</span>);</div><div class="line">                tempBitmap.recycle();</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                bitmap = tempBitmap;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (bitmap == <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">return</span> Response.error(<span class="keyword">new</span> ParseError(response));</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="keyword">return</span> Response.success(bitmap, HttpHeaderParser.parseCacheHeaders(response));</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">deliverResponse</span><span class="params">(Bitmap response)</span> </span>&#123;</div><div class="line">        mListener.onResponse(response);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Returns the largest power-of-two divisor for use in downscaling a bitmap</div><div class="line">     * that will not result in the scaling past the desired dimensions.</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> actualWidth Actual width of the bitmap</div><div class="line">     * <span class="doctag">@param</span> actualHeight Actual height of the bitmap</div><div class="line">     * <span class="doctag">@param</span> desiredWidth Desired width of the bitmap</div><div class="line">     * <span class="doctag">@param</span> desiredHeight Desired height of the bitmap</div><div class="line">     */</div><div class="line">    <span class="comment">// Visible for testing.</span></div><div class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">findBestSampleSize</span><span class="params">(</span></span></div><div class="line">            <span class="keyword">int</span> actualWidth, <span class="keyword">int</span> actualHeight, <span class="keyword">int</span> desiredWidth, <span class="keyword">int</span> desiredHeight) &#123;</div><div class="line">        <span class="keyword">double</span> wr = (<span class="keyword">double</span>) actualWidth / desiredWidth;</div><div class="line">        <span class="keyword">double</span> hr = (<span class="keyword">double</span>) actualHeight / desiredHeight;</div><div class="line">        <span class="keyword">double</span> ratio = Math.min(wr, hr);</div><div class="line">        <span class="keyword">float</span> n = <span class="number">1.0f</span>;</div><div class="line">        <span class="keyword">while</span> ((n * <span class="number">2</span>) &lt;= ratio) &#123;</div><div class="line">            n *= <span class="number">2</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">return</span> (<span class="keyword">int</span>) n;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li><p>ImageLoader</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div><div class="line">223</div><div class="line">224</div><div class="line">225</div><div class="line">226</div><div class="line">227</div><div class="line">228</div><div class="line">229</div><div class="line">230</div><div class="line">231</div><div class="line">232</div><div class="line">233</div><div class="line">234</div><div class="line">235</div><div class="line">236</div><div class="line">237</div><div class="line">238</div><div class="line">239</div><div class="line">240</div><div class="line">241</div><div class="line">242</div><div class="line">243</div><div class="line">244</div><div class="line">245</div><div class="line">246</div><div class="line">247</div><div class="line">248</div><div class="line">249</div><div class="line">250</div><div class="line">251</div><div class="line">252</div><div class="line">253</div><div class="line">254</div><div class="line">255</div><div class="line">256</div><div class="line">257</div><div class="line">258</div><div class="line">259</div><div class="line">260</div><div class="line">261</div><div class="line">262</div><div class="line">263</div><div class="line">264</div><div class="line">265</div><div class="line">266</div><div class="line">267</div><div class="line">268</div><div class="line">269</div><div class="line">270</div><div class="line">271</div><div class="line">272</div><div class="line">273</div><div class="line">274</div><div class="line">275</div><div class="line">276</div><div class="line">277</div><div class="line">278</div><div class="line">279</div><div class="line">280</div><div class="line">281</div><div class="line">282</div><div class="line">283</div><div class="line">284</div><div class="line">285</div><div class="line">286</div><div class="line">287</div><div class="line">288</div><div class="line">289</div><div class="line">290</div><div class="line">291</div><div class="line">292</div><div class="line">293</div><div class="line">294</div><div class="line">295</div><div class="line">296</div><div class="line">297</div><div class="line">298</div><div class="line">299</div><div class="line">300</div><div class="line">301</div><div class="line">302</div><div class="line">303</div><div class="line">304</div><div class="line">305</div><div class="line">306</div><div class="line">307</div><div class="line">308</div><div class="line">309</div><div class="line">310</div><div class="line">311</div><div class="line">312</div><div class="line">313</div><div class="line">314</div><div class="line">315</div><div class="line">316</div><div class="line">317</div><div class="line">318</div><div class="line">319</div><div class="line">320</div><div class="line">321</div><div class="line">322</div><div class="line">323</div><div class="line">324</div><div class="line">325</div><div class="line">326</div><div class="line">327</div><div class="line">328</div><div class="line">329</div><div class="line">330</div><div class="line">331</div><div class="line">332</div><div class="line">333</div><div class="line">334</div><div class="line">335</div><div class="line">336</div><div class="line">337</div><div class="line">338</div><div class="line">339</div><div class="line">340</div><div class="line">341</div><div class="line">342</div><div class="line">343</div><div class="line">344</div><div class="line">345</div><div class="line">346</div><div class="line">347</div><div class="line">348</div><div class="line">349</div><div class="line">350</div><div class="line">351</div><div class="line">352</div><div class="line">353</div><div class="line">354</div><div class="line">355</div><div class="line">356</div><div class="line">357</div><div class="line">358</div><div class="line">359</div><div class="line">360</div><div class="line">361</div><div class="line">362</div><div class="line">363</div><div class="line">364</div><div class="line">365</div><div class="line">366</div><div class="line">367</div><div class="line">368</div><div class="line">369</div><div class="line">370</div><div class="line">371</div><div class="line">372</div><div class="line">373</div><div class="line">374</div><div class="line">375</div><div class="line">376</div><div class="line">377</div><div class="line">378</div><div class="line">379</div><div class="line">380</div><div class="line">381</div><div class="line">382</div><div class="line">383</div><div class="line">384</div><div class="line">385</div><div class="line">386</div><div class="line">387</div><div class="line">388</div><div class="line">389</div><div class="line">390</div><div class="line">391</div><div class="line">392</div><div class="line">393</div><div class="line">394</div><div class="line">395</div><div class="line">396</div><div class="line">397</div><div class="line">398</div><div class="line">399</div><div class="line">400</div><div class="line">401</div><div class="line">402</div><div class="line">403</div><div class="line">404</div><div class="line">405</div><div class="line">406</div><div class="line">407</div><div class="line">408</div><div class="line">409</div><div class="line">410</div><div class="line">411</div><div class="line">412</div><div class="line">413</div><div class="line">414</div><div class="line">415</div><div class="line">416</div><div class="line">417</div><div class="line">418</div><div class="line">419</div><div class="line">420</div><div class="line">421</div><div class="line">422</div><div class="line">423</div><div class="line">424</div><div class="line">425</div><div class="line">426</div><div class="line">427</div><div class="line">428</div><div class="line">429</div><div class="line">430</div><div class="line">431</div><div class="line">432</div><div class="line">433</div><div class="line">434</div><div class="line">435</div><div class="line">436</div><div class="line">437</div><div class="line">438</div><div class="line">439</div><div class="line">440</div><div class="line">441</div><div class="line">442</div><div class="line">443</div><div class="line">444</div><div class="line">445</div><div class="line">446</div><div class="line">447</div><div class="line">448</div><div class="line">449</div><div class="line">450</div><div class="line">451</div><div class="line">452</div><div class="line">453</div><div class="line">454</div><div class="line">455</div><div class="line">456</div><div class="line">457</div><div class="line">458</div><div class="line">459</div><div class="line">460</div><div class="line">461</div><div class="line">462</div><div class="line">463</div><div class="line">464</div><div class="line">465</div><div class="line">466</div><div class="line">467</div><div class="line">468</div><div class="line">469</div><div class="line">470</div><div class="line">471</div><div class="line">472</div><div class="line">473</div><div class="line">474</div><div class="line">475</div><div class="line">476</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * Helper that handles loading and caching images from remote URLs.</div><div class="line"> *</div><div class="line"> * The simple way to use this class is to call &#123;<span class="doctag">@link</span> ImageLoader#get(String, ImageListener)&#125;</div><div class="line"> * and to pass in the default image listener provided by</div><div class="line"> * &#123;<span class="doctag">@link</span> ImageLoader#getImageListener(ImageView, int, int)&#125;. Note that all function calls to</div><div class="line"> * this class must be made from the main thead, and all responses will be delivered to the main</div><div class="line"> * thread as well.</div><div class="line"> */</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ImageLoader</span> </span>&#123;</div><div class="line">    <span class="comment">/** RequestQueue for dispatching ImageRequests onto. */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> RequestQueue mRequestQueue;</div><div class="line"></div><div class="line">    <span class="comment">/** Amount of time to wait after first response arrives before delivering all responses. */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span> mBatchResponseDelayMs = <span class="number">100</span>;</div><div class="line"></div><div class="line">    <span class="comment">/** The cache implementation to be used as an L1 cache before calling into volley. */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ImageCache mCache;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * HashMap of Cache keys -&gt; BatchedImageRequest used to track in-flight requests so</div><div class="line">     * that we can coalesce multiple requests to the same URL into a single network request.</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> HashMap&lt;String, BatchedImageRequest&gt; mInFlightRequests =</div><div class="line">            <span class="keyword">new</span> HashMap&lt;String, BatchedImageRequest&gt;();</div><div class="line"></div><div class="line">    <span class="comment">/** HashMap of the currently pending responses (waiting to be delivered). */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> HashMap&lt;String, BatchedImageRequest&gt; mBatchedResponses =</div><div class="line">            <span class="keyword">new</span> HashMap&lt;String, BatchedImageRequest&gt;();</div><div class="line"></div><div class="line">    <span class="comment">/** Handler to the main thread. */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Handler mHandler = <span class="keyword">new</span> Handler(Looper.getMainLooper());</div><div class="line"></div><div class="line">    <span class="comment">/** Runnable for in-flight response delivery. */</span></div><div class="line">    <span class="keyword">private</span> Runnable mRunnable;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Simple cache adapter interface. If provided to the ImageLoader, it</div><div class="line">     * will be used as an L1 cache before dispatch to Volley. Implementations</div><div class="line">     * must not block. Implementation with an LruCache is recommended.</div><div class="line">     */</div><div class="line">    <span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ImageCache</span> </span>&#123;</div><div class="line">        <span class="function">Bitmap <span class="title">getBitmap</span><span class="params">(String url)</span></span>;</div><div class="line">        <span class="function"><span class="keyword">void</span> <span class="title">putBitmap</span><span class="params">(String url, Bitmap bitmap)</span></span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Constructs a new ImageLoader.</div><div class="line">     * <span class="doctag">@param</span> queue The RequestQueue to use for making image requests.</div><div class="line">     * <span class="doctag">@param</span> imageCache The cache to use as an L1 cache.</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ImageLoader</span><span class="params">(RequestQueue queue, ImageCache imageCache)</span> </span>&#123;</div><div class="line">        mRequestQueue = queue;</div><div class="line">        mCache = imageCache;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * The default implementation of ImageListener which handles basic functionality</div><div class="line">     * of showing a default image until the network response is received, at which point</div><div class="line">     * it will switch to either the actual image or the error image.</div><div class="line">     * <span class="doctag">@param</span> view The imageView that the listener is associated with.</div><div class="line">     * <span class="doctag">@param</span> defaultImageResId Default image resource ID to use, or 0 if it doesn't exist.</div><div class="line">     * <span class="doctag">@param</span> errorImageResId Error image resource ID to use, or 0 if it doesn't exist.</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ImageListener <span class="title">getImageListener</span><span class="params">(<span class="keyword">final</span> ImageView view,</span></span></div><div class="line">            <span class="keyword">final</span> <span class="keyword">int</span> defaultImageResId, <span class="keyword">final</span> <span class="keyword">int</span> errorImageResId) &#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ImageListener() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onErrorResponse</span><span class="params">(VolleyError error)</span> </span>&#123;</div><div class="line">                <span class="keyword">if</span> (errorImageResId != <span class="number">0</span>) &#123;</div><div class="line">                    view.setImageResource(errorImageResId);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onResponse</span><span class="params">(ImageContainer response, <span class="keyword">boolean</span> isImmediate)</span> </span>&#123;</div><div class="line">                <span class="keyword">if</span> (response.getBitmap() != <span class="keyword">null</span>) &#123;</div><div class="line">                    view.setImageBitmap(response.getBitmap());</div><div class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (defaultImageResId != <span class="number">0</span>) &#123;</div><div class="line">                    view.setImageResource(defaultImageResId);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Interface for the response handlers on image requests.</div><div class="line">     *</div><div class="line">     * The call flow is this:</div><div class="line">     * 1. Upon being  attached to a request, onResponse(response, true) will</div><div class="line">     * be invoked to reflect any cached data that was already available. If the</div><div class="line">     * data was available, response.getBitmap() will be non-null.</div><div class="line">     *</div><div class="line">     * 2. After a network response returns, only one of the following cases will happen:</div><div class="line">     *   - onResponse(response, false) will be called if the image was loaded.</div><div class="line">     *   or</div><div class="line">     *   - onErrorResponse will be called if there was an error loading the image.</div><div class="line">     */</div><div class="line">    <span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ImageListener</span> <span class="keyword">extends</span> <span class="title">ErrorListener</span> </span>&#123;</div><div class="line">        <span class="comment">/**</span></div><div class="line">         * Listens for non-error changes to the loading of the image request.</div><div class="line">         *</div><div class="line">         * <span class="doctag">@param</span> response Holds all information pertaining to the request, as well</div><div class="line">         * as the bitmap (if it is loaded).</div><div class="line">         * <span class="doctag">@param</span> isImmediate True if this was called during ImageLoader.get() variants.</div><div class="line">         * This can be used to differentiate between a cached image loading and a network</div><div class="line">         * image loading in order to, for example, run an animation to fade in network loaded</div><div class="line">         * images.</div><div class="line">         */</div><div class="line">        <span class="function"><span class="keyword">void</span> <span class="title">onResponse</span><span class="params">(ImageContainer response, <span class="keyword">boolean</span> isImmediate)</span></span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Checks if the item is available in the cache.</div><div class="line">     * <span class="doctag">@param</span> requestUrl The url of the remote image</div><div class="line">     * <span class="doctag">@param</span> maxWidth The maximum width of the returned image.</div><div class="line">     * <span class="doctag">@param</span> maxHeight The maximum height of the returned image.</div><div class="line">     * <span class="doctag">@return</span> True if the item exists in cache, false otherwise.</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isCached</span><span class="params">(String requestUrl, <span class="keyword">int</span> maxWidth, <span class="keyword">int</span> maxHeight)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> isCached(requestUrl, maxWidth, maxHeight, ScaleType.CENTER_INSIDE);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Checks if the item is available in the cache.</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> requestUrl The url of the remote image</div><div class="line">     * <span class="doctag">@param</span> maxWidth   The maximum width of the returned image.</div><div class="line">     * <span class="doctag">@param</span> maxHeight  The maximum height of the returned image.</div><div class="line">     * <span class="doctag">@param</span> scaleType  The scaleType of the imageView.</div><div class="line">     * <span class="doctag">@return</span> True if the item exists in cache, false otherwise.</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isCached</span><span class="params">(String requestUrl, <span class="keyword">int</span> maxWidth, <span class="keyword">int</span> maxHeight, ScaleType scaleType)</span> </span>&#123;</div><div class="line">        throwIfNotOnMainThread();</div><div class="line"></div><div class="line">        String cacheKey = getCacheKey(requestUrl, maxWidth, maxHeight, scaleType);</div><div class="line">        <span class="keyword">return</span> mCache.getBitmap(cacheKey) != <span class="keyword">null</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Returns an ImageContainer for the requested URL.</div><div class="line">     *</div><div class="line">     * The ImageContainer will contain either the specified default bitmap or the loaded bitmap.</div><div class="line">     * If the default was returned, the &#123;<span class="doctag">@link</span> ImageLoader&#125; will be invoked when the</div><div class="line">     * request is fulfilled.</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> requestUrl The URL of the image to be loaded.</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> ImageContainer <span class="title">get</span><span class="params">(String requestUrl, <span class="keyword">final</span> ImageListener listener)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> get(requestUrl, listener, <span class="number">0</span>, <span class="number">0</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Equivalent to calling &#123;<span class="doctag">@link</span> #get(String, ImageListener, int, int, ScaleType)&#125; with</div><div class="line">     * &#123;<span class="doctag">@code</span> Scaletype == ScaleType.CENTER_INSIDE&#125;.</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> ImageContainer <span class="title">get</span><span class="params">(String requestUrl, ImageListener imageListener,</span></span></div><div class="line">            <span class="keyword">int</span> maxWidth, <span class="keyword">int</span> maxHeight) &#123;</div><div class="line">        <span class="keyword">return</span> get(requestUrl, imageListener, maxWidth, maxHeight, ScaleType.CENTER_INSIDE);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Issues a bitmap request with the given URL if that image is not available</div><div class="line">     * in the cache, and returns a bitmap container that contains all of the data</div><div class="line">     * relating to the request (as well as the default image if the requested</div><div class="line">     * image is not available).</div><div class="line">     * <span class="doctag">@param</span> requestUrl The url of the remote image</div><div class="line">     * <span class="doctag">@param</span> imageListener The listener to call when the remote image is loaded</div><div class="line">     * <span class="doctag">@param</span> maxWidth The maximum width of the returned image.</div><div class="line">     * <span class="doctag">@param</span> maxHeight The maximum height of the returned image.</div><div class="line">     * <span class="doctag">@param</span> scaleType The ImageViews ScaleType used to calculate the needed image size.</div><div class="line">     * <span class="doctag">@return</span> A container object that contains all of the properties of the request, as well as</div><div class="line">     *     the currently available image (default if remote is not loaded).</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> ImageContainer <span class="title">get</span><span class="params">(String requestUrl, ImageListener imageListener,</span></span></div><div class="line">            <span class="keyword">int</span> maxWidth, <span class="keyword">int</span> maxHeight, ScaleType scaleType) &#123;</div><div class="line"></div><div class="line">        <span class="comment">// only fulfill requests that were initiated from the main thread.</span></div><div class="line">        throwIfNotOnMainThread();</div><div class="line"></div><div class="line">        <span class="keyword">final</span> String cacheKey = getCacheKey(requestUrl, maxWidth, maxHeight, scaleType);</div><div class="line"></div><div class="line">        <span class="comment">// Try to look up the request in the cache of remote images.</span></div><div class="line">        Bitmap cachedBitmap = mCache.getBitmap(cacheKey);</div><div class="line">        <span class="keyword">if</span> (cachedBitmap != <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="comment">// Return the cached bitmap.</span></div><div class="line">            ImageContainer container = <span class="keyword">new</span> ImageContainer(cachedBitmap, requestUrl, <span class="keyword">null</span>, <span class="keyword">null</span>);</div><div class="line">            imageListener.onResponse(container, <span class="keyword">true</span>);</div><div class="line">            <span class="keyword">return</span> container;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// The bitmap did not exist in the cache, fetch it!</span></div><div class="line">        ImageContainer imageContainer =</div><div class="line">                <span class="keyword">new</span> ImageContainer(<span class="keyword">null</span>, requestUrl, cacheKey, imageListener);</div><div class="line"></div><div class="line">        <span class="comment">// Update the caller to let them know that they should use the default bitmap.</span></div><div class="line">        imageListener.onResponse(imageContainer, <span class="keyword">true</span>);</div><div class="line"></div><div class="line">        <span class="comment">// Check to see if a request is already in-flight.</span></div><div class="line">        BatchedImageRequest request = mInFlightRequests.get(cacheKey);</div><div class="line">        <span class="keyword">if</span> (request != <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="comment">// If it is, add this request to the list of listeners.</span></div><div class="line">            request.addContainer(imageContainer);</div><div class="line">            <span class="keyword">return</span> imageContainer;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// The request is not already in flight. Send the new request to the network and</span></div><div class="line">        <span class="comment">// track it.</span></div><div class="line">        Request&lt;Bitmap&gt; newRequest = makeImageRequest(requestUrl, maxWidth, maxHeight, scaleType,</div><div class="line">                cacheKey);</div><div class="line"></div><div class="line">        mRequestQueue.add(newRequest);</div><div class="line">        mInFlightRequests.put(cacheKey,</div><div class="line">                <span class="keyword">new</span> BatchedImageRequest(newRequest, imageContainer));</div><div class="line">        <span class="keyword">return</span> imageContainer;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">protected</span> Request&lt;Bitmap&gt; <span class="title">makeImageRequest</span><span class="params">(String requestUrl, <span class="keyword">int</span> maxWidth, <span class="keyword">int</span> maxHeight,</span></span></div><div class="line">            ScaleType scaleType, <span class="keyword">final</span> String cacheKey) &#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ImageRequest(requestUrl, <span class="keyword">new</span> Listener&lt;Bitmap&gt;() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onResponse</span><span class="params">(Bitmap response)</span> </span>&#123;</div><div class="line">                onGetImageSuccess(cacheKey, response);</div><div class="line">            &#125;</div><div class="line">        &#125;, maxWidth, maxHeight, scaleType, Config.RGB_565, <span class="keyword">new</span> ErrorListener() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onErrorResponse</span><span class="params">(VolleyError error)</span> </span>&#123;</div><div class="line">                onGetImageError(cacheKey, error);</div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Sets the amount of time to wait after the first response arrives before delivering all</div><div class="line">     * responses. Batching can be disabled entirely by passing in 0.</div><div class="line">     * <span class="doctag">@param</span> newBatchedResponseDelayMs The time in milliseconds to wait.</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setBatchedResponseDelay</span><span class="params">(<span class="keyword">int</span> newBatchedResponseDelayMs)</span> </span>&#123;</div><div class="line">        mBatchResponseDelayMs = newBatchedResponseDelayMs;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Handler for when an image was successfully loaded.</div><div class="line">     * <span class="doctag">@param</span> cacheKey The cache key that is associated with the image request.</div><div class="line">     * <span class="doctag">@param</span> response The bitmap that was returned from the network.</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onGetImageSuccess</span><span class="params">(String cacheKey, Bitmap response)</span> </span>&#123;</div><div class="line">        <span class="comment">// cache the image that was fetched.</span></div><div class="line">        mCache.putBitmap(cacheKey, response);</div><div class="line"></div><div class="line">        <span class="comment">// remove the request from the list of in-flight requests.</span></div><div class="line">        BatchedImageRequest request = mInFlightRequests.remove(cacheKey);</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (request != <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="comment">// Update the response bitmap.</span></div><div class="line">            request.mResponseBitmap = response;</div><div class="line"></div><div class="line">            <span class="comment">// Send the batched response</span></div><div class="line">            batchResponse(cacheKey, request);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Handler for when an image failed to load.</div><div class="line">     * <span class="doctag">@param</span> cacheKey The cache key that is associated with the image request.</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onGetImageError</span><span class="params">(String cacheKey, VolleyError error)</span> </span>&#123;</div><div class="line">        <span class="comment">// Notify the requesters that something failed via a null result.</span></div><div class="line">        <span class="comment">// Remove this request from the list of in-flight requests.</span></div><div class="line">        BatchedImageRequest request = mInFlightRequests.remove(cacheKey);</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (request != <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="comment">// Set the error for this request</span></div><div class="line">            request.setError(error);</div><div class="line"></div><div class="line">            <span class="comment">// Send the batched response</span></div><div class="line">            batchResponse(cacheKey, request);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Container object for all of the data surrounding an image request.</div><div class="line">     */</div><div class="line">    <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ImageContainer</span> </span>&#123;</div><div class="line">        <span class="comment">/**</span></div><div class="line">         * The most relevant bitmap for the container. If the image was in cache, the</div><div class="line">         * Holder to use for the final bitmap (the one that pairs to the requested URL).</div><div class="line">         */</div><div class="line">        <span class="keyword">private</span> Bitmap mBitmap;</div><div class="line"></div><div class="line">        <span class="keyword">private</span> <span class="keyword">final</span> ImageListener mListener;</div><div class="line"></div><div class="line">        <span class="comment">/** The cache key that was associated with the request */</span></div><div class="line">        <span class="keyword">private</span> <span class="keyword">final</span> String mCacheKey;</div><div class="line"></div><div class="line">        <span class="comment">/** The request URL that was specified */</span></div><div class="line">        <span class="keyword">private</span> <span class="keyword">final</span> String mRequestUrl;</div><div class="line"></div><div class="line">        <span class="comment">/**</span></div><div class="line">         * Constructs a BitmapContainer object.</div><div class="line">         * <span class="doctag">@param</span> bitmap The final bitmap (if it exists).</div><div class="line">         * <span class="doctag">@param</span> requestUrl The requested URL for this container.</div><div class="line">         * <span class="doctag">@param</span> cacheKey The cache key that identifies the requested URL for this container.</div><div class="line">         */</div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="title">ImageContainer</span><span class="params">(Bitmap bitmap, String requestUrl,</span></span></div><div class="line">                String cacheKey, ImageListener listener) &#123;</div><div class="line">            mBitmap = bitmap;</div><div class="line">            mRequestUrl = requestUrl;</div><div class="line">            mCacheKey = cacheKey;</div><div class="line">            mListener = listener;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">/**</span></div><div class="line">         * Releases interest in the in-flight request (and cancels it if no one else is listening).</div><div class="line">         */</div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">cancelRequest</span><span class="params">()</span> </span>&#123;</div><div class="line">            <span class="keyword">if</span> (mListener == <span class="keyword">null</span>) &#123;</div><div class="line">                <span class="keyword">return</span>;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            BatchedImageRequest request = mInFlightRequests.get(mCacheKey);</div><div class="line">            <span class="keyword">if</span> (request != <span class="keyword">null</span>) &#123;</div><div class="line">                <span class="keyword">boolean</span> canceled = request.removeContainerAndCancelIfNecessary(<span class="keyword">this</span>);</div><div class="line">                <span class="keyword">if</span> (canceled) &#123;</div><div class="line">                    mInFlightRequests.remove(mCacheKey);</div><div class="line">                &#125;</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                <span class="comment">// check to see if it is already batched for delivery.</span></div><div class="line">                request = mBatchedResponses.get(mCacheKey);</div><div class="line">                <span class="keyword">if</span> (request != <span class="keyword">null</span>) &#123;</div><div class="line">                    request.removeContainerAndCancelIfNecessary(<span class="keyword">this</span>);</div><div class="line">                    <span class="keyword">if</span> (request.mContainers.size() == <span class="number">0</span>) &#123;</div><div class="line">                        mBatchedResponses.remove(mCacheKey);</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">/**</span></div><div class="line">         * Returns the bitmap associated with the request URL if it has been loaded, null otherwise.</div><div class="line">         */</div><div class="line">        <span class="function"><span class="keyword">public</span> Bitmap <span class="title">getBitmap</span><span class="params">()</span> </span>&#123;</div><div class="line">            <span class="keyword">return</span> mBitmap;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">/**</span></div><div class="line">         * Returns the requested URL for this container.</div><div class="line">         */</div><div class="line">        <span class="function"><span class="keyword">public</span> String <span class="title">getRequestUrl</span><span class="params">()</span> </span>&#123;</div><div class="line">            <span class="keyword">return</span> mRequestUrl;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Wrapper class used to map a Request to the set of active ImageContainer objects that are</div><div class="line">     * interested in its results.</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">BatchedImageRequest</span> </span>&#123;</div><div class="line">        <span class="comment">/** The request being tracked */</span></div><div class="line">        <span class="keyword">private</span> <span class="keyword">final</span> Request&lt;?&gt; mRequest;</div><div class="line"></div><div class="line">        <span class="comment">/** The result of the request being tracked by this item */</span></div><div class="line">        <span class="keyword">private</span> Bitmap mResponseBitmap;</div><div class="line"></div><div class="line">        <span class="comment">/** Error if one occurred for this response */</span></div><div class="line">        <span class="keyword">private</span> VolleyError mError;</div><div class="line"></div><div class="line">        <span class="comment">/** List of all of the active ImageContainers that are interested in the request */</span></div><div class="line">        <span class="keyword">private</span> <span class="keyword">final</span> LinkedList&lt;ImageContainer&gt; mContainers = <span class="keyword">new</span> LinkedList&lt;ImageContainer&gt;();</div><div class="line"></div><div class="line">        <span class="comment">/**</span></div><div class="line">         * Constructs a new BatchedImageRequest object</div><div class="line">         * <span class="doctag">@param</span> request The request being tracked</div><div class="line">         * <span class="doctag">@param</span> container The ImageContainer of the person who initiated the request.</div><div class="line">         */</div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="title">BatchedImageRequest</span><span class="params">(Request&lt;?&gt; request, ImageContainer container)</span> </span>&#123;</div><div class="line">            mRequest = request;</div><div class="line">            mContainers.add(container);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">/**</span></div><div class="line">         * Set the error for this response</div><div class="line">         */</div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setError</span><span class="params">(VolleyError error)</span> </span>&#123;</div><div class="line">            mError = error;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">/**</span></div><div class="line">         * Get the error for this response</div><div class="line">         */</div><div class="line">        <span class="function"><span class="keyword">public</span> VolleyError <span class="title">getError</span><span class="params">()</span> </span>&#123;</div><div class="line">            <span class="keyword">return</span> mError;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">/**</span></div><div class="line">         * Adds another ImageContainer to the list of those interested in the results of</div><div class="line">         * the request.</div><div class="line">         */</div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addContainer</span><span class="params">(ImageContainer container)</span> </span>&#123;</div><div class="line">            mContainers.add(container);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">/**</span></div><div class="line">         * Detatches the bitmap container from the request and cancels the request if no one is</div><div class="line">         * left listening.</div><div class="line">         * <span class="doctag">@param</span> container The container to remove from the list</div><div class="line">         * <span class="doctag">@return</span> True if the request was canceled, false otherwise.</div><div class="line">         */</div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">removeContainerAndCancelIfNecessary</span><span class="params">(ImageContainer container)</span> </span>&#123;</div><div class="line">            mContainers.remove(container);</div><div class="line">            <span class="keyword">if</span> (mContainers.size() == <span class="number">0</span>) &#123;</div><div class="line">                mRequest.cancel();</div><div class="line">                <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Starts the runnable for batched delivery of responses if it is not already started.</div><div class="line">     * <span class="doctag">@param</span> cacheKey The cacheKey of the response being delivered.</div><div class="line">     * <span class="doctag">@param</span> request The BatchedImageRequest to be delivered.</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">batchResponse</span><span class="params">(String cacheKey, BatchedImageRequest request)</span> </span>&#123;</div><div class="line">        mBatchedResponses.put(cacheKey, request);</div><div class="line">        <span class="comment">// If we don't already have a batch delivery runnable in flight, make a new one.</span></div><div class="line">        <span class="comment">// Note that this will be used to deliver responses to all callers in mBatchedResponses.</span></div><div class="line">        <span class="keyword">if</span> (mRunnable == <span class="keyword">null</span>) &#123;</div><div class="line">            mRunnable = <span class="keyword">new</span> Runnable() &#123;</div><div class="line">                <span class="meta">@Override</span></div><div class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">                    <span class="keyword">for</span> (BatchedImageRequest bir : mBatchedResponses.values()) &#123;</div><div class="line">                        <span class="keyword">for</span> (ImageContainer container : bir.mContainers) &#123;</div><div class="line">                            <span class="comment">// If one of the callers in the batched request canceled the request</span></div><div class="line">                            <span class="comment">// after the response was received but before it was delivered,</span></div><div class="line">                            <span class="comment">// skip them.</span></div><div class="line">                            <span class="keyword">if</span> (container.mListener == <span class="keyword">null</span>) &#123;</div><div class="line">                                <span class="keyword">continue</span>;</div><div class="line">                            &#125;</div><div class="line">                            <span class="keyword">if</span> (bir.getError() == <span class="keyword">null</span>) &#123;</div><div class="line">                                container.mBitmap = bir.mResponseBitmap;</div><div class="line">                                container.mListener.onResponse(container, <span class="keyword">false</span>);</div><div class="line">                            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                                container.mListener.onErrorResponse(bir.getError());</div><div class="line">                            &#125;</div><div class="line">                        &#125;</div><div class="line">                    &#125;</div><div class="line">                    mBatchedResponses.clear();</div><div class="line">                    mRunnable = <span class="keyword">null</span>;</div><div class="line">                &#125;</div><div class="line"></div><div class="line">            &#125;;</div><div class="line">            <span class="comment">// Post the runnable.</span></div><div class="line">            mHandler.postDelayed(mRunnable, mBatchResponseDelayMs);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">throwIfNotOnMainThread</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (Looper.myLooper() != Looper.getMainLooper()) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"ImageLoader must be invoked from the main thread."</span>);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Creates a cache key for use with the L1 cache.</div><div class="line">     * <span class="doctag">@param</span> url The URL of the request.</div><div class="line">     * <span class="doctag">@param</span> maxWidth The max-width of the output.</div><div class="line">     * <span class="doctag">@param</span> maxHeight The max-height of the output.</div><div class="line">     * <span class="doctag">@param</span> scaleType The scaleType of the imageView.</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> String <span class="title">getCacheKey</span><span class="params">(String url, <span class="keyword">int</span> maxWidth, <span class="keyword">int</span> maxHeight, ScaleType scaleType)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> StringBuilder(url.length() + <span class="number">12</span>).append(<span class="string">"#W"</span>).append(maxWidth)</div><div class="line">                .append(<span class="string">"#H"</span>).append(maxHeight).append(<span class="string">"#S"</span>).append(scaleType.ordinal()).append(url)</div><div class="line">                .toString();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>NetworkImageView</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * Handles fetching an image from a URL as well as the life-cycle of the</div><div class="line"> * associated request.</div><div class="line"> */</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NetworkImageView</span> <span class="keyword">extends</span> <span class="title">ImageView</span> </span>&#123;</div><div class="line">    <span class="comment">/** The URL of the network image to load */</span></div><div class="line">    <span class="keyword">private</span> String mUrl;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Resource ID of the image to be used as a placeholder until the network image is loaded.</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span> mDefaultImageId;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Resource ID of the image to be used if the network response fails.</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span> mErrorImageId;</div><div class="line"></div><div class="line">    <span class="comment">/** Local copy of the ImageLoader. */</span></div><div class="line">    <span class="keyword">private</span> ImageLoader mImageLoader;</div><div class="line"></div><div class="line">    <span class="comment">/** Current ImageContainer. (either in-flight or finished) */</span></div><div class="line">    <span class="keyword">private</span> ImageContainer mImageContainer;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">NetworkImageView</span><span class="params">(Context context)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>(context, <span class="keyword">null</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">NetworkImageView</span><span class="params">(Context context, AttributeSet attrs)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>(context, attrs, <span class="number">0</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">NetworkImageView</span><span class="params">(Context context, AttributeSet attrs, <span class="keyword">int</span> defStyle)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>(context, attrs, defStyle);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Sets URL of the image that should be loaded into this view. Note that calling this will</div><div class="line">     * immediately either set the cached image (if available) or the default image specified by</div><div class="line">     * &#123;<span class="doctag">@link</span> NetworkImageView#setDefaultImageResId(int)&#125; on the view.</div><div class="line">     *</div><div class="line">     * <span class="doctag">NOTE:</span> If applicable, &#123;<span class="doctag">@link</span> NetworkImageView#setDefaultImageResId(int)&#125; and</div><div class="line">     * &#123;<span class="doctag">@link</span> NetworkImageView#setErrorImageResId(int)&#125; should be called prior to calling</div><div class="line">     * this function.</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> url The URL that should be loaded into this ImageView.</div><div class="line">     * <span class="doctag">@param</span> imageLoader ImageLoader that will be used to make the request.</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setImageUrl</span><span class="params">(String url, ImageLoader imageLoader)</span> </span>&#123;</div><div class="line">        mUrl = url;</div><div class="line">        mImageLoader = imageLoader;</div><div class="line">        <span class="comment">// The URL has potentially changed. See if we need to load it.</span></div><div class="line">        loadImageIfNecessary(<span class="keyword">false</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Sets the default image resource ID to be used for this view until the attempt to load it</div><div class="line">     * completes.</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setDefaultImageResId</span><span class="params">(<span class="keyword">int</span> defaultImage)</span> </span>&#123;</div><div class="line">        mDefaultImageId = defaultImage;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Sets the error image resource ID to be used for this view in the event that the image</div><div class="line">     * requested fails to load.</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setErrorImageResId</span><span class="params">(<span class="keyword">int</span> errorImage)</span> </span>&#123;</div><div class="line">        mErrorImageId = errorImage;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Loads the image for the view if it isn't already loaded.</div><div class="line">     * <span class="doctag">@param</span> isInLayoutPass True if this was invoked from a layout pass, false otherwise.</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">loadImageIfNecessary</span><span class="params">(<span class="keyword">final</span> <span class="keyword">boolean</span> isInLayoutPass)</span> </span>&#123;</div><div class="line">        <span class="keyword">int</span> width = getWidth();</div><div class="line">        <span class="keyword">int</span> height = getHeight();</div><div class="line">        ScaleType scaleType = getScaleType();</div><div class="line"></div><div class="line">        <span class="keyword">boolean</span> wrapWidth = <span class="keyword">false</span>, wrapHeight = <span class="keyword">false</span>;</div><div class="line">        <span class="keyword">if</span> (getLayoutParams() != <span class="keyword">null</span>) &#123;</div><div class="line">            wrapWidth = getLayoutParams().width == LayoutParams.WRAP_CONTENT;</div><div class="line">            wrapHeight = getLayoutParams().height == LayoutParams.WRAP_CONTENT;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// if the view's bounds aren't known yet, and this is not a wrap-content/wrap-content</span></div><div class="line">        <span class="comment">// view, hold off on loading the image.</span></div><div class="line">        <span class="keyword">boolean</span> isFullyWrapContent = wrapWidth &amp;&amp; wrapHeight;</div><div class="line">        <span class="keyword">if</span> (width == <span class="number">0</span> &amp;&amp; height == <span class="number">0</span> &amp;&amp; !isFullyWrapContent) &#123;</div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// if the URL to be loaded in this view is empty, cancel any old requests and clear the</span></div><div class="line">        <span class="comment">// currently loaded image.</span></div><div class="line">        <span class="keyword">if</span> (TextUtils.isEmpty(mUrl)) &#123;</div><div class="line">            <span class="keyword">if</span> (mImageContainer != <span class="keyword">null</span>) &#123;</div><div class="line">                mImageContainer.cancelRequest();</div><div class="line">                mImageContainer = <span class="keyword">null</span>;</div><div class="line">            &#125;</div><div class="line">            setDefaultImageOrNull();</div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// if there was an old request in this view, check if it needs to be canceled.</span></div><div class="line">        <span class="keyword">if</span> (mImageContainer != <span class="keyword">null</span> &amp;&amp; mImageContainer.getRequestUrl() != <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">if</span> (mImageContainer.getRequestUrl().equals(mUrl)) &#123;</div><div class="line">                <span class="comment">// if the request is from the same URL, return.</span></div><div class="line">                <span class="keyword">return</span>;</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                <span class="comment">// if there is a pre-existing request, cancel it if it's fetching a different URL.</span></div><div class="line">                mImageContainer.cancelRequest();</div><div class="line">                setDefaultImageOrNull();</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// Calculate the max image width / height to use while ignoring WRAP_CONTENT dimens.</span></div><div class="line">        <span class="keyword">int</span> maxWidth = wrapWidth ? <span class="number">0</span> : width;</div><div class="line">        <span class="keyword">int</span> maxHeight = wrapHeight ? <span class="number">0</span> : height;</div><div class="line"></div><div class="line">        <span class="comment">// The pre-existing content of this view didn't match the current URL. Load the new image</span></div><div class="line">        <span class="comment">// from the network.</span></div><div class="line"></div><div class="line">        <span class="comment">// update the ImageContainer to be the new bitmap container.</span></div><div class="line">        mImageContainer = mImageLoader.get(mUrl,</div><div class="line">                <span class="keyword">new</span> ImageListener() &#123;</div><div class="line">                    <span class="meta">@Override</span></div><div class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onErrorResponse</span><span class="params">(VolleyError error)</span> </span>&#123;</div><div class="line">                        <span class="keyword">if</span> (mErrorImageId != <span class="number">0</span>) &#123;</div><div class="line">                            setImageResource(mErrorImageId);</div><div class="line">                        &#125;</div><div class="line">                    &#125;</div><div class="line"></div><div class="line">                    <span class="meta">@Override</span></div><div class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onResponse</span><span class="params">(<span class="keyword">final</span> ImageContainer response, <span class="keyword">boolean</span> isImmediate)</span> </span>&#123;</div><div class="line">                        <span class="comment">// If this was an immediate response that was delivered inside of a layout</span></div><div class="line">                        <span class="comment">// pass do not set the image immediately as it will trigger a requestLayout</span></div><div class="line">                        <span class="comment">// inside of a layout. Instead, defer setting the image by posting back to</span></div><div class="line">                        <span class="comment">// the main thread.</span></div><div class="line">                        <span class="keyword">if</span> (isImmediate &amp;&amp; isInLayoutPass) &#123;</div><div class="line">                            post(<span class="keyword">new</span> Runnable() &#123;</div><div class="line">                                <span class="meta">@Override</span></div><div class="line">                                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">                                    onResponse(response, <span class="keyword">false</span>);</div><div class="line">                                &#125;</div><div class="line">                            &#125;);</div><div class="line">                            <span class="keyword">return</span>;</div><div class="line">                        &#125;</div><div class="line"></div><div class="line">                        <span class="keyword">if</span> (response.getBitmap() != <span class="keyword">null</span>) &#123;</div><div class="line">                            setImageBitmap(response.getBitmap());</div><div class="line">                        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (mDefaultImageId != <span class="number">0</span>) &#123;</div><div class="line">                            setImageResource(mDefaultImageId);</div><div class="line">                        &#125;</div><div class="line">                    &#125;</div><div class="line">                &#125;, maxWidth, maxHeight, scaleType);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">setDefaultImageOrNull</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span>(mDefaultImageId != <span class="number">0</span>) &#123;</div><div class="line">            setImageResource(mDefaultImageId);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">else</span> &#123;</div><div class="line">            setImageBitmap(<span class="keyword">null</span>);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onLayout</span><span class="params">(<span class="keyword">boolean</span> changed, <span class="keyword">int</span> left, <span class="keyword">int</span> top, <span class="keyword">int</span> right, <span class="keyword">int</span> bottom)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.onLayout(changed, left, top, right, bottom);</div><div class="line">        loadImageIfNecessary(<span class="keyword">true</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onDetachedFromWindow</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (mImageContainer != <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="comment">// If the view was bound to an image request, cancel it and clear</span></div><div class="line">            <span class="comment">// out the image from the view.</span></div><div class="line">            mImageContainer.cancelRequest();</div><div class="line">            setImageBitmap(<span class="keyword">null</span>);</div><div class="line">            <span class="comment">// also clear out the container so we can reload the image if necessary.</span></div><div class="line">            mImageContainer = <span class="keyword">null</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">super</span>.onDetachedFromWindow();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">drawableStateChanged</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.drawableStateChanged();</div><div class="line">        invalidate();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ul>
<h4 id="ClearCacheRequest"><a href="#ClearCacheRequest" class="headerlink" title="ClearCacheRequest"></a>ClearCacheRequest</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * A synthetic request used for clearing the cache.</div><div class="line"> */</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ClearCacheRequest</span> <span class="keyword">extends</span> <span class="title">Request</span>&lt;<span class="title">Object</span>&gt; </span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Cache mCache;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Runnable mCallback;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Creates a synthetic request for clearing the cache.</div><div class="line">     * <span class="doctag">@param</span> cache Cache to clear</div><div class="line">     * <span class="doctag">@param</span> callback Callback to make on the main thread once the cache is clear,</div><div class="line">     * or null for none</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ClearCacheRequest</span><span class="params">(Cache cache, Runnable callback)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>(Method.GET, <span class="keyword">null</span>, <span class="keyword">null</span>);</div><div class="line">        mCache = cache;</div><div class="line">        mCallback = callback;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isCanceled</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="comment">// This is a little bit of a hack, but hey, why not.</span></div><div class="line">        mCache.clear();</div><div class="line">        <span class="keyword">if</span> (mCallback != <span class="keyword">null</span>) &#123;</div><div class="line">            Handler handler = <span class="keyword">new</span> Handler(Looper.getMainLooper());</div><div class="line">            handler.postAtFrontOfQueue(mCallback);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> Priority <span class="title">getPriority</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> Priority.IMMEDIATE;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> Response&lt;Object&gt; <span class="title">parseNetworkResponse</span><span class="params">(NetworkResponse response)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">deliverResponse</span><span class="params">(Object response)</span> </span>&#123;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="Cache"><a href="#Cache" class="headerlink" title="Cache"></a>Cache</h3><h4 id="DiskBasedCache"><a href="#DiskBasedCache" class="headerlink" title="DiskBasedCache"></a>DiskBasedCache</h4><p>默认缓存路径为硬盘缓存，如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div><div class="line">223</div><div class="line">224</div><div class="line">225</div><div class="line">226</div><div class="line">227</div><div class="line">228</div><div class="line">229</div><div class="line">230</div><div class="line">231</div><div class="line">232</div><div class="line">233</div><div class="line">234</div><div class="line">235</div><div class="line">236</div><div class="line">237</div><div class="line">238</div><div class="line">239</div><div class="line">240</div><div class="line">241</div><div class="line">242</div><div class="line">243</div><div class="line">244</div><div class="line">245</div><div class="line">246</div><div class="line">247</div><div class="line">248</div><div class="line">249</div><div class="line">250</div><div class="line">251</div><div class="line">252</div><div class="line">253</div><div class="line">254</div><div class="line">255</div><div class="line">256</div><div class="line">257</div><div class="line">258</div><div class="line">259</div><div class="line">260</div><div class="line">261</div><div class="line">262</div><div class="line">263</div><div class="line">264</div><div class="line">265</div><div class="line">266</div><div class="line">267</div><div class="line">268</div><div class="line">269</div><div class="line">270</div><div class="line">271</div><div class="line">272</div><div class="line">273</div><div class="line">274</div><div class="line">275</div><div class="line">276</div><div class="line">277</div><div class="line">278</div><div class="line">279</div><div class="line">280</div><div class="line">281</div><div class="line">282</div><div class="line">283</div><div class="line">284</div><div class="line">285</div><div class="line">286</div><div class="line">287</div><div class="line">288</div><div class="line">289</div><div class="line">290</div><div class="line">291</div><div class="line">292</div><div class="line">293</div><div class="line">294</div><div class="line">295</div><div class="line">296</div><div class="line">297</div><div class="line">298</div><div class="line">299</div><div class="line">300</div><div class="line">301</div><div class="line">302</div><div class="line">303</div><div class="line">304</div><div class="line">305</div><div class="line">306</div><div class="line">307</div><div class="line">308</div><div class="line">309</div><div class="line">310</div><div class="line">311</div><div class="line">312</div><div class="line">313</div><div class="line">314</div><div class="line">315</div><div class="line">316</div><div class="line">317</div><div class="line">318</div><div class="line">319</div><div class="line">320</div><div class="line">321</div><div class="line">322</div><div class="line">323</div><div class="line">324</div><div class="line">325</div><div class="line">326</div><div class="line">327</div><div class="line">328</div><div class="line">329</div><div class="line">330</div><div class="line">331</div><div class="line">332</div><div class="line">333</div><div class="line">334</div><div class="line">335</div><div class="line">336</div><div class="line">337</div><div class="line">338</div><div class="line">339</div><div class="line">340</div><div class="line">341</div><div class="line">342</div><div class="line">343</div><div class="line">344</div><div class="line">345</div><div class="line">346</div><div class="line">347</div><div class="line">348</div><div class="line">349</div><div class="line">350</div><div class="line">351</div><div class="line">352</div><div class="line">353</div><div class="line">354</div><div class="line">355</div><div class="line">356</div><div class="line">357</div><div class="line">358</div><div class="line">359</div><div class="line">360</div><div class="line">361</div><div class="line">362</div><div class="line">363</div><div class="line">364</div><div class="line">365</div><div class="line">366</div><div class="line">367</div><div class="line">368</div><div class="line">369</div><div class="line">370</div><div class="line">371</div><div class="line">372</div><div class="line">373</div><div class="line">374</div><div class="line">375</div><div class="line">376</div><div class="line">377</div><div class="line">378</div><div class="line">379</div><div class="line">380</div><div class="line">381</div><div class="line">382</div><div class="line">383</div><div class="line">384</div><div class="line">385</div><div class="line">386</div><div class="line">387</div><div class="line">388</div><div class="line">389</div><div class="line">390</div><div class="line">391</div><div class="line">392</div><div class="line">393</div><div class="line">394</div><div class="line">395</div><div class="line">396</div><div class="line">397</div><div class="line">398</div><div class="line">399</div><div class="line">400</div><div class="line">401</div><div class="line">402</div><div class="line">403</div><div class="line">404</div><div class="line">405</div><div class="line">406</div><div class="line">407</div><div class="line">408</div><div class="line">409</div><div class="line">410</div><div class="line">411</div><div class="line">412</div><div class="line">413</div><div class="line">414</div><div class="line">415</div><div class="line">416</div><div class="line">417</div><div class="line">418</div><div class="line">419</div><div class="line">420</div><div class="line">421</div><div class="line">422</div><div class="line">423</div><div class="line">424</div><div class="line">425</div><div class="line">426</div><div class="line">427</div><div class="line">428</div><div class="line">429</div><div class="line">430</div><div class="line">431</div><div class="line">432</div><div class="line">433</div><div class="line">434</div><div class="line">435</div><div class="line">436</div><div class="line">437</div><div class="line">438</div><div class="line">439</div><div class="line">440</div><div class="line">441</div><div class="line">442</div><div class="line">443</div><div class="line">444</div><div class="line">445</div><div class="line">446</div><div class="line">447</div><div class="line">448</div><div class="line">449</div><div class="line">450</div><div class="line">451</div><div class="line">452</div><div class="line">453</div><div class="line">454</div><div class="line">455</div><div class="line">456</div><div class="line">457</div><div class="line">458</div><div class="line">459</div><div class="line">460</div><div class="line">461</div><div class="line">462</div><div class="line">463</div><div class="line">464</div><div class="line">465</div><div class="line">466</div><div class="line">467</div><div class="line">468</div><div class="line">469</div><div class="line">470</div><div class="line">471</div><div class="line">472</div><div class="line">473</div><div class="line">474</div><div class="line">475</div><div class="line">476</div><div class="line">477</div><div class="line">478</div><div class="line">479</div><div class="line">480</div><div class="line">481</div><div class="line">482</div><div class="line">483</div><div class="line">484</div><div class="line">485</div><div class="line">486</div><div class="line">487</div><div class="line">488</div><div class="line">489</div><div class="line">490</div><div class="line">491</div><div class="line">492</div><div class="line">493</div><div class="line">494</div><div class="line">495</div><div class="line">496</div><div class="line">497</div><div class="line">498</div><div class="line">499</div><div class="line">500</div><div class="line">501</div><div class="line">502</div><div class="line">503</div><div class="line">504</div><div class="line">505</div><div class="line">506</div><div class="line">507</div><div class="line">508</div><div class="line">509</div><div class="line">510</div><div class="line">511</div><div class="line">512</div><div class="line">513</div><div class="line">514</div><div class="line">515</div><div class="line">516</div><div class="line">517</div><div class="line">518</div><div class="line">519</div><div class="line">520</div><div class="line">521</div><div class="line">522</div><div class="line">523</div><div class="line">524</div><div class="line">525</div><div class="line">526</div><div class="line">527</div><div class="line">528</div><div class="line">529</div><div class="line">530</div><div class="line">531</div><div class="line">532</div><div class="line">533</div><div class="line">534</div><div class="line">535</div><div class="line">536</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Cache implementation that caches files directly onto the hard disk in the specified</div><div class="line"> * directory. The default disk usage size is 5MB, but is configurable.</div><div class="line"> */</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DiskBasedCache</span> <span class="keyword">implements</span> <span class="title">Cache</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">/** Map of the Key, CacheHeader pairs */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, CacheHeader&gt; mEntries =</div><div class="line">            <span class="keyword">new</span> LinkedHashMap&lt;String, CacheHeader&gt;(<span class="number">16</span>, .<span class="number">75f</span>, <span class="keyword">true</span>);</div><div class="line"></div><div class="line">    <span class="comment">/** Total amount of space currently used by the cache in bytes. */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">long</span> mTotalSize = <span class="number">0</span>;</div><div class="line"></div><div class="line">    <span class="comment">/** The root directory to use for the cache. */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> File mRootDirectory;</div><div class="line"></div><div class="line">    <span class="comment">/** The maximum size of the cache in bytes. */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> mMaxCacheSizeInBytes;</div><div class="line"></div><div class="line">    <span class="comment">/** Default maximum disk usage in bytes. */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> DEFAULT_DISK_USAGE_BYTES = <span class="number">5</span> * <span class="number">1024</span> * <span class="number">1024</span>;</div><div class="line"></div><div class="line">    <span class="comment">/** High water mark percentage for the cache */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">float</span> HYSTERESIS_FACTOR = <span class="number">0.9f</span>;</div><div class="line"></div><div class="line">    <span class="comment">/** Magic number for current version of cache file format. */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> CACHE_MAGIC = <span class="number">0x20150306</span>;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Constructs an instance of the DiskBasedCache at the specified directory.</div><div class="line">     * <span class="doctag">@param</span> rootDirectory The root directory of the cache.</div><div class="line">     * <span class="doctag">@param</span> maxCacheSizeInBytes The maximum size of the cache in bytes.</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">DiskBasedCache</span><span class="params">(File rootDirectory, <span class="keyword">int</span> maxCacheSizeInBytes)</span> </span>&#123;</div><div class="line">        mRootDirectory = rootDirectory;</div><div class="line">        mMaxCacheSizeInBytes = maxCacheSizeInBytes;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Constructs an instance of the DiskBasedCache at the specified directory using</div><div class="line">     * the default maximum cache size of 5MB.</div><div class="line">     * <span class="doctag">@param</span> rootDirectory The root directory of the cache.</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">DiskBasedCache</span><span class="params">(File rootDirectory)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>(rootDirectory, DEFAULT_DISK_USAGE_BYTES);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Clears the cache. Deletes all cached files from disk.</div><div class="line">     */</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">clear</span><span class="params">()</span> </span>&#123;</div><div class="line">        File[] files = mRootDirectory.listFiles();</div><div class="line">        <span class="keyword">if</span> (files != <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">for</span> (File file : files) &#123;</div><div class="line">                file.delete();</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        mEntries.clear();</div><div class="line">        mTotalSize = <span class="number">0</span>;</div><div class="line">        VolleyLog.d(<span class="string">"Cache cleared."</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Returns the cache entry with the specified key if it exists, null otherwise.</div><div class="line">     */</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> Entry <span class="title">get</span><span class="params">(String key)</span> </span>&#123;</div><div class="line">        CacheHeader entry = mEntries.get(key);</div><div class="line">        <span class="comment">// if the entry does not exist, return.</span></div><div class="line">        <span class="keyword">if</span> (entry == <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        File file = getFileForKey(key);</div><div class="line">        CountingInputStream cis = <span class="keyword">null</span>;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            cis = <span class="keyword">new</span> CountingInputStream(<span class="keyword">new</span> BufferedInputStream(<span class="keyword">new</span> FileInputStream(file)));</div><div class="line">            CacheHeader.readHeader(cis); <span class="comment">// eat header</span></div><div class="line">            <span class="keyword">byte</span>[] data = streamToBytes(cis, (<span class="keyword">int</span>) (file.length() - cis.bytesRead));</div><div class="line">            <span class="keyword">return</span> entry.toCacheEntry(data);</div><div class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line">            VolleyLog.d(<span class="string">"%s: %s"</span>, file.getAbsolutePath(), e.toString());</div><div class="line">            remove(key);</div><div class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">        &#125;  <span class="keyword">catch</span> (NegativeArraySizeException e) &#123;</div><div class="line">            VolleyLog.d(<span class="string">"%s: %s"</span>, file.getAbsolutePath(), e.toString());</div><div class="line">            remove(key);</div><div class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">        &#125; <span class="keyword">finally</span> &#123;</div><div class="line">            <span class="keyword">if</span> (cis != <span class="keyword">null</span>) &#123;</div><div class="line">                <span class="keyword">try</span> &#123;</div><div class="line">                    cis.close();</div><div class="line">                &#125; <span class="keyword">catch</span> (IOException ioe) &#123;</div><div class="line">                    <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Initializes the DiskBasedCache by scanning for all files currently in the</div><div class="line">     * specified root directory. Creates the root directory if necessary.</div><div class="line">     */</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">initialize</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (!mRootDirectory.exists()) &#123;</div><div class="line">            <span class="keyword">if</span> (!mRootDirectory.mkdirs()) &#123;</div><div class="line">                VolleyLog.e(<span class="string">"Unable to create cache dir %s"</span>, mRootDirectory.getAbsolutePath());</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        File[] files = mRootDirectory.listFiles();</div><div class="line">        <span class="keyword">if</span> (files == <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">for</span> (File file : files) &#123;</div><div class="line">            BufferedInputStream fis = <span class="keyword">null</span>;</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                fis = <span class="keyword">new</span> BufferedInputStream(<span class="keyword">new</span> FileInputStream(file));</div><div class="line">                CacheHeader entry = CacheHeader.readHeader(fis);</div><div class="line">                entry.size = file.length();</div><div class="line">                putEntry(entry.key, entry);</div><div class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line">                <span class="keyword">if</span> (file != <span class="keyword">null</span>) &#123;</div><div class="line">                   file.delete();</div><div class="line">                &#125;</div><div class="line">            &#125; <span class="keyword">finally</span> &#123;</div><div class="line">                <span class="keyword">try</span> &#123;</div><div class="line">                    <span class="keyword">if</span> (fis != <span class="keyword">null</span>) &#123;</div><div class="line">                        fis.close();</div><div class="line">                    &#125;</div><div class="line">                &#125; <span class="keyword">catch</span> (IOException ignored) &#123; &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Invalidates an entry in the cache.</div><div class="line">     * <span class="doctag">@param</span> key Cache key</div><div class="line">     * <span class="doctag">@param</span> fullExpire True to fully expire the entry, false to soft expire</div><div class="line">     */</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">invalidate</span><span class="params">(String key, <span class="keyword">boolean</span> fullExpire)</span> </span>&#123;</div><div class="line">        Entry entry = get(key);</div><div class="line">        <span class="keyword">if</span> (entry != <span class="keyword">null</span>) &#123;</div><div class="line">            entry.softTtl = <span class="number">0</span>;</div><div class="line">            <span class="keyword">if</span> (fullExpire) &#123;</div><div class="line">                entry.ttl = <span class="number">0</span>;</div><div class="line">            &#125;</div><div class="line">            put(key, entry);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Puts the entry with the specified key into the cache.</div><div class="line">     */</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">put</span><span class="params">(String key, Entry entry)</span> </span>&#123;</div><div class="line">        pruneIfNeeded(entry.data.length);</div><div class="line">        File file = getFileForKey(key);</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            BufferedOutputStream fos = <span class="keyword">new</span> BufferedOutputStream(<span class="keyword">new</span> FileOutputStream(file));</div><div class="line">            CacheHeader e = <span class="keyword">new</span> CacheHeader(key, entry);</div><div class="line">            <span class="keyword">boolean</span> success = e.writeHeader(fos);</div><div class="line">            <span class="keyword">if</span> (!success) &#123;</div><div class="line">                fos.close();</div><div class="line">                VolleyLog.d(<span class="string">"Failed to write header for %s"</span>, file.getAbsolutePath());</div><div class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> IOException();</div><div class="line">            &#125;</div><div class="line">            fos.write(entry.data);</div><div class="line">            fos.close();</div><div class="line">            putEntry(key, e);</div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">boolean</span> deleted = file.delete();</div><div class="line">        <span class="keyword">if</span> (!deleted) &#123;</div><div class="line">            VolleyLog.d(<span class="string">"Could not clean up file %s"</span>, file.getAbsolutePath());</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Removes the specified key from the cache if it exists.</div><div class="line">     */</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">remove</span><span class="params">(String key)</span> </span>&#123;</div><div class="line">        <span class="keyword">boolean</span> deleted = getFileForKey(key).delete();</div><div class="line">        removeEntry(key);</div><div class="line">        <span class="keyword">if</span> (!deleted) &#123;</div><div class="line">            VolleyLog.d(<span class="string">"Could not delete cache entry for key=%s, filename=%s"</span>,</div><div class="line">                    key, getFilenameForKey(key));</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Creates a pseudo-unique filename for the specified cache key.</div><div class="line">     * <span class="doctag">@param</span> key The key to generate a file name for.</div><div class="line">     * <span class="doctag">@return</span> A pseudo-unique filename.</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">private</span> String <span class="title">getFilenameForKey</span><span class="params">(String key)</span> </span>&#123;</div><div class="line">        <span class="keyword">int</span> firstHalfLength = key.length() / <span class="number">2</span>;</div><div class="line">        String localFilename = String.valueOf(key.substring(<span class="number">0</span>, firstHalfLength).hashCode());</div><div class="line">        localFilename += String.valueOf(key.substring(firstHalfLength).hashCode());</div><div class="line">        <span class="keyword">return</span> localFilename;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Returns a file object for the given cache key.</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> File <span class="title">getFileForKey</span><span class="params">(String key)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> File(mRootDirectory, getFilenameForKey(key));</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Prunes the cache to fit the amount of bytes specified.</div><div class="line">     * <span class="doctag">@param</span> neededSpace The amount of bytes we are trying to fit into the cache.</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">pruneIfNeeded</span><span class="params">(<span class="keyword">int</span> neededSpace)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> ((mTotalSize + neededSpace) &lt; mMaxCacheSizeInBytes) &#123;</div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (VolleyLog.DEBUG) &#123;</div><div class="line">            VolleyLog.v(<span class="string">"Pruning old cache entries."</span>);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">long</span> before = mTotalSize;</div><div class="line">        <span class="keyword">int</span> prunedFiles = <span class="number">0</span>;</div><div class="line">        <span class="keyword">long</span> startTime = SystemClock.elapsedRealtime();</div><div class="line"></div><div class="line">        Iterator&lt;Map.Entry&lt;String, CacheHeader&gt;&gt; iterator = mEntries.entrySet().iterator();</div><div class="line">        <span class="keyword">while</span> (iterator.hasNext()) &#123;</div><div class="line">            Map.Entry&lt;String, CacheHeader&gt; entry = iterator.next();</div><div class="line">            CacheHeader e = entry.getValue();</div><div class="line">            <span class="keyword">boolean</span> deleted = getFileForKey(e.key).delete();</div><div class="line">            <span class="keyword">if</span> (deleted) &#123;</div><div class="line">                mTotalSize -= e.size;</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">               VolleyLog.d(<span class="string">"Could not delete cache entry for key=%s, filename=%s"</span>,</div><div class="line">                       e.key, getFilenameForKey(e.key));</div><div class="line">            &#125;</div><div class="line">            iterator.remove();</div><div class="line">            prunedFiles++;</div><div class="line"></div><div class="line">            <span class="keyword">if</span> ((mTotalSize + neededSpace) &lt; mMaxCacheSizeInBytes * HYSTERESIS_FACTOR) &#123;</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (VolleyLog.DEBUG) &#123;</div><div class="line">            VolleyLog.v(<span class="string">"pruned %d files, %d bytes, %d ms"</span>,</div><div class="line">                    prunedFiles, (mTotalSize - before), SystemClock.elapsedRealtime() - startTime);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Puts the entry with the specified key into the cache.</div><div class="line">     * <span class="doctag">@param</span> key The key to identify the entry by.</div><div class="line">     * <span class="doctag">@param</span> entry The entry to cache.</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">putEntry</span><span class="params">(String key, CacheHeader entry)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (!mEntries.containsKey(key)) &#123;</div><div class="line">            mTotalSize += entry.size;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            CacheHeader oldEntry = mEntries.get(key);</div><div class="line">            mTotalSize += (entry.size - oldEntry.size);</div><div class="line">        &#125;</div><div class="line">        mEntries.put(key, entry);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Removes the entry identified by 'key' from the cache.</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">removeEntry</span><span class="params">(String key)</span> </span>&#123;</div><div class="line">        CacheHeader entry = mEntries.get(key);</div><div class="line">        <span class="keyword">if</span> (entry != <span class="keyword">null</span>) &#123;</div><div class="line">            mTotalSize -= entry.size;</div><div class="line">            mEntries.remove(key);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Reads the contents of an InputStream into a byte[].</div><div class="line">     * */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">byte</span>[] streamToBytes(InputStream in, <span class="keyword">int</span> length) <span class="keyword">throws</span> IOException &#123;</div><div class="line">        <span class="keyword">byte</span>[] bytes = <span class="keyword">new</span> <span class="keyword">byte</span>[length];</div><div class="line">        <span class="keyword">int</span> count;</div><div class="line">        <span class="keyword">int</span> pos = <span class="number">0</span>;</div><div class="line">        <span class="keyword">while</span> (pos &lt; length &amp;&amp; ((count = in.read(bytes, pos, length - pos)) != -<span class="number">1</span>)) &#123;</div><div class="line">            pos += count;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (pos != length) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IOException(<span class="string">"Expected "</span> + length + <span class="string">" bytes, read "</span> + pos + <span class="string">" bytes"</span>);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> bytes;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Handles holding onto the cache headers for an entry.</div><div class="line">     */</div><div class="line">    <span class="comment">// Visible for testing.</span></div><div class="line">    <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">CacheHeader</span> </span>&#123;</div><div class="line">        <span class="comment">/** The size of the data identified by this CacheHeader. (This is not</span></div><div class="line">         * serialized to disk. */</div><div class="line">        <span class="keyword">public</span> <span class="keyword">long</span> size;</div><div class="line"></div><div class="line">        <span class="comment">/** The key that identifies the cache entry. */</span></div><div class="line">        <span class="keyword">public</span> String key;</div><div class="line"></div><div class="line">        <span class="comment">/** ETag for cache coherence. */</span></div><div class="line">        <span class="keyword">public</span> String etag;</div><div class="line"></div><div class="line">        <span class="comment">/** Date of this response as reported by the server. */</span></div><div class="line">        <span class="keyword">public</span> <span class="keyword">long</span> serverDate;</div><div class="line"></div><div class="line">        <span class="comment">/** The last modified date for the requested object. */</span></div><div class="line">        <span class="keyword">public</span> <span class="keyword">long</span> lastModified;</div><div class="line"></div><div class="line">        <span class="comment">/** TTL for this record. */</span></div><div class="line">        <span class="keyword">public</span> <span class="keyword">long</span> ttl;</div><div class="line"></div><div class="line">        <span class="comment">/** Soft TTL for this record. */</span></div><div class="line">        <span class="keyword">public</span> <span class="keyword">long</span> softTtl;</div><div class="line"></div><div class="line">        <span class="comment">/** Headers from the response resulting in this cache entry. */</span></div><div class="line">        <span class="keyword">public</span> Map&lt;String, String&gt; responseHeaders;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">private</span> <span class="title">CacheHeader</span><span class="params">()</span> </span>&#123; &#125;</div><div class="line"></div><div class="line">        <span class="comment">/**</span></div><div class="line">         * Instantiates a new CacheHeader object</div><div class="line">         * <span class="doctag">@param</span> key The key that identifies the cache entry</div><div class="line">         * <span class="doctag">@param</span> entry The cache entry.</div><div class="line">         */</div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="title">CacheHeader</span><span class="params">(String key, Entry entry)</span> </span>&#123;</div><div class="line">            <span class="keyword">this</span>.key = key;</div><div class="line">            <span class="keyword">this</span>.size = entry.data.length;</div><div class="line">            <span class="keyword">this</span>.etag = entry.etag;</div><div class="line">            <span class="keyword">this</span>.serverDate = entry.serverDate;</div><div class="line">            <span class="keyword">this</span>.lastModified = entry.lastModified;</div><div class="line">            <span class="keyword">this</span>.ttl = entry.ttl;</div><div class="line">            <span class="keyword">this</span>.softTtl = entry.softTtl;</div><div class="line">            <span class="keyword">this</span>.responseHeaders = entry.responseHeaders;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">/**</span></div><div class="line">         * Reads the header off of an InputStream and returns a CacheHeader object.</div><div class="line">         * <span class="doctag">@param</span> is The InputStream to read from.</div><div class="line">         * <span class="doctag">@throws</span> IOException</div><div class="line">         */</div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> CacheHeader <span class="title">readHeader</span><span class="params">(InputStream is)</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">            CacheHeader entry = <span class="keyword">new</span> CacheHeader();</div><div class="line">            <span class="keyword">int</span> magic = readInt(is);</div><div class="line">            <span class="keyword">if</span> (magic != CACHE_MAGIC) &#123;</div><div class="line">                <span class="comment">// don't bother deleting, it'll get pruned eventually</span></div><div class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> IOException();</div><div class="line">            &#125;</div><div class="line">            entry.key = readString(is);</div><div class="line">            entry.etag = readString(is);</div><div class="line">            <span class="keyword">if</span> (entry.etag.equals(<span class="string">""</span>)) &#123;</div><div class="line">                entry.etag = <span class="keyword">null</span>;</div><div class="line">            &#125;</div><div class="line">            entry.serverDate = readLong(is);</div><div class="line">            entry.lastModified = readLong(is);</div><div class="line">            entry.ttl = readLong(is);</div><div class="line">            entry.softTtl = readLong(is);</div><div class="line">            entry.responseHeaders = readStringStringMap(is);</div><div class="line"></div><div class="line">            <span class="keyword">return</span> entry;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">/**</span></div><div class="line">         * Creates a cache entry for the specified data.</div><div class="line">         */</div><div class="line">        <span class="function"><span class="keyword">public</span> Entry <span class="title">toCacheEntry</span><span class="params">(<span class="keyword">byte</span>[] data)</span> </span>&#123;</div><div class="line">            Entry e = <span class="keyword">new</span> Entry();</div><div class="line">            e.data = data;</div><div class="line">            e.etag = etag;</div><div class="line">            e.serverDate = serverDate;</div><div class="line">            e.lastModified = lastModified;</div><div class="line">            e.ttl = ttl;</div><div class="line">            e.softTtl = softTtl;</div><div class="line">            e.responseHeaders = responseHeaders;</div><div class="line">            <span class="keyword">return</span> e;</div><div class="line">        &#125;</div><div class="line"></div><div class="line"></div><div class="line">        <span class="comment">/**</span></div><div class="line">         * Writes the contents of this CacheHeader to the specified OutputStream.</div><div class="line">         */</div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">writeHeader</span><span class="params">(OutputStream os)</span> </span>&#123;</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                writeInt(os, CACHE_MAGIC);</div><div class="line">                writeString(os, key);</div><div class="line">                writeString(os, etag == <span class="keyword">null</span> ? <span class="string">""</span> : etag);</div><div class="line">                writeLong(os, serverDate);</div><div class="line">                writeLong(os, lastModified);</div><div class="line">                writeLong(os, ttl);</div><div class="line">                writeLong(os, softTtl);</div><div class="line">                writeStringStringMap(responseHeaders, os);</div><div class="line">                os.flush();</div><div class="line">                <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line">                VolleyLog.d(<span class="string">"%s"</span>, e.toString());</div><div class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">CountingInputStream</span> <span class="keyword">extends</span> <span class="title">FilterInputStream</span> </span>&#123;</div><div class="line">        <span class="keyword">private</span> <span class="keyword">int</span> bytesRead = <span class="number">0</span>;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">private</span> <span class="title">CountingInputStream</span><span class="params">(InputStream in)</span> </span>&#123;</div><div class="line">            <span class="keyword">super</span>(in);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">read</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">            <span class="keyword">int</span> result = <span class="keyword">super</span>.read();</div><div class="line">            <span class="keyword">if</span> (result != -<span class="number">1</span>) &#123;</div><div class="line">                bytesRead++;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">return</span> result;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">read</span><span class="params">(<span class="keyword">byte</span>[] buffer, <span class="keyword">int</span> offset, <span class="keyword">int</span> count)</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">            <span class="keyword">int</span> result = <span class="keyword">super</span>.read(buffer, offset, count);</div><div class="line">            <span class="keyword">if</span> (result != -<span class="number">1</span>) &#123;</div><div class="line">                bytesRead += result;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">return</span> result;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/*</span></div><div class="line">     * Homebrewed simple serialization system used for reading and writing cache</div><div class="line">     * headers on disk. Once upon a time, this used the standard Java</div><div class="line">     * Object&#123;Input,Output&#125;Stream, but the default implementation relies heavily</div><div class="line">     * on reflection (even for standard types) and generates a ton of garbage.</div><div class="line">     */</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Simple wrapper around &#123;<span class="doctag">@link</span> InputStream#read()&#125; that throws EOFException</div><div class="line">     * instead of returning -1.</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">read</span><span class="params">(InputStream is)</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">        <span class="keyword">int</span> b = is.read();</div><div class="line">        <span class="keyword">if</span> (b == -<span class="number">1</span>) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> EOFException();</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> b;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">writeInt</span><span class="params">(OutputStream os, <span class="keyword">int</span> n)</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">        os.write((n &gt;&gt; <span class="number">0</span>) &amp; <span class="number">0xff</span>);</div><div class="line">        os.write((n &gt;&gt; <span class="number">8</span>) &amp; <span class="number">0xff</span>);</div><div class="line">        os.write((n &gt;&gt; <span class="number">16</span>) &amp; <span class="number">0xff</span>);</div><div class="line">        os.write((n &gt;&gt; <span class="number">24</span>) &amp; <span class="number">0xff</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">readInt</span><span class="params">(InputStream is)</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">        <span class="keyword">int</span> n = <span class="number">0</span>;</div><div class="line">        n |= (read(is) &lt;&lt; <span class="number">0</span>);</div><div class="line">        n |= (read(is) &lt;&lt; <span class="number">8</span>);</div><div class="line">        n |= (read(is) &lt;&lt; <span class="number">16</span>);</div><div class="line">        n |= (read(is) &lt;&lt; <span class="number">24</span>);</div><div class="line">        <span class="keyword">return</span> n;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">writeLong</span><span class="params">(OutputStream os, <span class="keyword">long</span> n)</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">        os.write((<span class="keyword">byte</span>)(n &gt;&gt;&gt; <span class="number">0</span>));</div><div class="line">        os.write((<span class="keyword">byte</span>)(n &gt;&gt;&gt; <span class="number">8</span>));</div><div class="line">        os.write((<span class="keyword">byte</span>)(n &gt;&gt;&gt; <span class="number">16</span>));</div><div class="line">        os.write((<span class="keyword">byte</span>)(n &gt;&gt;&gt; <span class="number">24</span>));</div><div class="line">        os.write((<span class="keyword">byte</span>)(n &gt;&gt;&gt; <span class="number">32</span>));</div><div class="line">        os.write((<span class="keyword">byte</span>)(n &gt;&gt;&gt; <span class="number">40</span>));</div><div class="line">        os.write((<span class="keyword">byte</span>)(n &gt;&gt;&gt; <span class="number">48</span>));</div><div class="line">        os.write((<span class="keyword">byte</span>)(n &gt;&gt;&gt; <span class="number">56</span>));</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">long</span> <span class="title">readLong</span><span class="params">(InputStream is)</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">        <span class="keyword">long</span> n = <span class="number">0</span>;</div><div class="line">        n |= ((read(is) &amp; <span class="number">0xFFL</span>) &lt;&lt; <span class="number">0</span>);</div><div class="line">        n |= ((read(is) &amp; <span class="number">0xFFL</span>) &lt;&lt; <span class="number">8</span>);</div><div class="line">        n |= ((read(is) &amp; <span class="number">0xFFL</span>) &lt;&lt; <span class="number">16</span>);</div><div class="line">        n |= ((read(is) &amp; <span class="number">0xFFL</span>) &lt;&lt; <span class="number">24</span>);</div><div class="line">        n |= ((read(is) &amp; <span class="number">0xFFL</span>) &lt;&lt; <span class="number">32</span>);</div><div class="line">        n |= ((read(is) &amp; <span class="number">0xFFL</span>) &lt;&lt; <span class="number">40</span>);</div><div class="line">        n |= ((read(is) &amp; <span class="number">0xFFL</span>) &lt;&lt; <span class="number">48</span>);</div><div class="line">        n |= ((read(is) &amp; <span class="number">0xFFL</span>) &lt;&lt; <span class="number">56</span>);</div><div class="line">        <span class="keyword">return</span> n;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">writeString</span><span class="params">(OutputStream os, String s)</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">        <span class="keyword">byte</span>[] b = s.getBytes(<span class="string">"UTF-8"</span>);</div><div class="line">        writeLong(os, b.length);</div><div class="line">        os.write(b, <span class="number">0</span>, b.length);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">static</span> String <span class="title">readString</span><span class="params">(InputStream is)</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">        <span class="keyword">int</span> n = (<span class="keyword">int</span>) readLong(is);</div><div class="line">        <span class="keyword">byte</span>[] b = streamToBytes(is, n);</div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> String(b, <span class="string">"UTF-8"</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">writeStringStringMap</span><span class="params">(Map&lt;String, String&gt; map, OutputStream os)</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">        <span class="keyword">if</span> (map != <span class="keyword">null</span>) &#123;</div><div class="line">            writeInt(os, map.size());</div><div class="line">            <span class="keyword">for</span> (Map.Entry&lt;String, String&gt; entry : map.entrySet()) &#123;</div><div class="line">                writeString(os, entry.getKey());</div><div class="line">                writeString(os, entry.getValue());</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            writeInt(os, <span class="number">0</span>);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">static</span> Map&lt;String, String&gt; <span class="title">readStringStringMap</span><span class="params">(InputStream is)</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">        <span class="keyword">int</span> size = readInt(is);</div><div class="line">        Map&lt;String, String&gt; result = (size == <span class="number">0</span>)</div><div class="line">                ? Collections.&lt;String, String&gt;emptyMap()</div><div class="line">                : <span class="keyword">new</span> HashMap&lt;String, String&gt;(size);</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; size; i++) &#123;</div><div class="line">            String key = readString(is).intern();</div><div class="line">            String value = readString(is).intern();</div><div class="line">            result.put(key, value);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> result;</div><div class="line">    &#125;</div><div class="line"></div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>#### </p>

      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        

      
    </div>

    <footer class="post-footer">
      

      
        
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2017/06/06/LayoutInflater-源码解析/" rel="next" title="LayoutInflater 源码解析">
                <i class="fa fa-chevron-left"></i> LayoutInflater 源码解析
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2017/05/21/ReactNative-BLE-的使用体会/" rel="prev" title="ReactNative/BLE 的使用体会">
                ReactNative/BLE 的使用体会 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/uploads/header.jpg"
               alt="喝咖啡的鱼儿" />
          <p class="site-author-name" itemprop="name">喝咖啡的鱼儿</p>
           
              <p class="site-description motion-element" itemprop="description">愿你走出半生，归来仍是少年</p>
          
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives">
                <span class="site-state-item-count">22</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-categories">
              
                <span class="site-state-item-count">6</span>
                <span class="site-state-item-name">分类</span>
              
            </div>
          

          
            
            
            <div class="site-state-item site-state-tags">
              
                <span class="site-state-item-count">6</span>
                <span class="site-state-item-name">标签</span>
              
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        
        

        


      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#Network"><span class="nav-number">1.</span> <span class="nav-text">Network</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#ByteArrayPool"><span class="nav-number">1.1.</span> <span class="nav-text">ByteArrayPool</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#BasicNetwork"><span class="nav-number">1.2.</span> <span class="nav-text">BasicNetwork</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Request"><span class="nav-number">2.</span> <span class="nav-text">Request</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#StringRequest"><span class="nav-number">2.1.</span> <span class="nav-text">StringRequest</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#JsonRequest"><span class="nav-number">2.2.</span> <span class="nav-text">JsonRequest</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#JsonRequest-1"><span class="nav-number">2.2.1.</span> <span class="nav-text">JsonRequest</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#JsonObjectRequest"><span class="nav-number">2.2.2.</span> <span class="nav-text">JsonObjectRequest</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#JsonArrayRequest"><span class="nav-number">2.2.3.</span> <span class="nav-text">JsonArrayRequest</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ImageRequest"><span class="nav-number">2.3.</span> <span class="nav-text">ImageRequest</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ClearCacheRequest"><span class="nav-number">2.4.</span> <span class="nav-text">ClearCacheRequest</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Cache"><span class="nav-number">3.</span> <span class="nav-text">Cache</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#DiskBasedCache"><span class="nav-number">3.1.</span> <span class="nav-text">DiskBasedCache</span></a></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2017</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">喝咖啡的鱼儿</span>
</div>


<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Pisces
  </a>
</div>


        

        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  








  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.0"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.0"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.0"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.0"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.0"></script>



  


  




	





  





  





  






  





  

  

  

  

  

</body>
</html>
